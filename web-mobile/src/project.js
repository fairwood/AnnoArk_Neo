require=function o(i,s,l){function c(e,t){if(!s[e]){if(!i[e]){var a="function"==typeof require&&require;if(!t&&a)return a(e,!0);if(d)return d(e,!0);var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}var n=s[e]={exports:{}};i[e][0].call(n.exports,function(t){return c(i[e][1][t]||t)},n,n.exports,o,i,s,l)}return s[e].exports}for(var d="function"==typeof require&&require,t=0;t<l.length;t++)c(l[t]);return c}({ArkInWorld:[function(t,e,a){"use strict";cc._RF.push(e,"dec21HFq/1BXrPvCkgOJBUs","ArkInWorld"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../DataMgr"),n=t("../WorldUI"),o=t("../UI/FlagMgr"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.sprIcon=null,t.sprFlag=null,t.lblName=null,t.grpInfo=null,t.spfIconMe=null,t.spfIconOther=null,t}return __extends(t,e),t.prototype.onLoad=function(){},t.prototype.setAndRefresh=function(t,e){this.data=t,this.sprIcon.spriteFrame=this.data.address==r.DataMgr.myUser.address?this.spfIconMe:this.spfIconOther,this.lblName.string=t.nickname,this.refreshZoom(e),o.FlagMgr.setFlag(this.sprFlag,t.country)},t.prototype.refreshZoom=function(t){if(this.data){var e=r.DataMgr.getUserCurrentLocation(this.data);this.node.position=e.mul(t)}},t.prototype.update=function(t){this.refreshZoom(n.default.Instance.zoomScale)},t.prototype.onClick=function(){n.default.Instance.selectObject(this.node)},__decorate([l(cc.Sprite)],t.prototype,"sprIcon",void 0),__decorate([l(cc.Sprite)],t.prototype,"sprFlag",void 0),__decorate([l(cc.Label)],t.prototype,"lblName",void 0),__decorate([l(cc.Node)],t.prototype,"grpInfo",void 0),__decorate([l(cc.SpriteFrame)],t.prototype,"spfIconMe",void 0),__decorate([l(cc.SpriteFrame)],t.prototype,"spfIconOther",void 0),t=__decorate([s],t)}(cc.Component);a.default=c,cc._RF.pop()},{"../DataMgr":"DataMgr","../UI/FlagMgr":"FlagMgr","../WorldUI":"WorldUI"}],AsyncLoadSprite:[function(t,e,a){"use strict";cc._RF.push(e,"39cbcBA8NhMbplhvYeYYTtc","AsyncLoadSprite"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.delay=0,t.path="",t}return __extends(t,e),t.prototype.start=function(){setTimeout(this.loadSprite.bind(this),1e3*this.delay)},t.prototype.loadSprite=function(){try{var r=this;cc.loader.loadRes(r.path,cc.SpriteFrame,function(t,e){if(!t){var a=r.node.getComponent(cc.Sprite);a&&(a.spriteFrame=e)}})}catch(t){console.error(t)}},__decorate([o(cc.Float)],t.prototype,"delay",void 0),__decorate([o(cc.String)],t.prototype,"path",void 0),t=__decorate([n],t)}(cc.Component);a.default=i,cc._RF.pop()},{}],AttackOtherPanel:[function(t,e,a){"use strict";cc._RF.push(e,"455d22zIrlGeZ1li6lS2g9o","AttackOtherPanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../DataMgr"),n=t("../BlockchainMgr"),o=t("./ToastPanel"),i=t("./DialogPanel"),s=cc._decorator,l=s.ccclass,c=s.property,d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblTitle=null,t.lblLv=null,t.lblDefTank=null,t.lblDefChopper=null,t.lblDefShip=null,t.lblAtkTankMax=null,t.lblAtkChopperMax=null,t.lblAtkShipMax=null,t.edtAtkTank=null,t.edtAtkChopper=null,t.edtAtkShip=null,t.SldAtkTank=null,t.SldAtkChopper=null,t.SldAtkShip=null,t.lblDistance=null,t.tankMax=0,t.chopperMax=0,t.shipMax=0,t}return __extends(t,e),(a=t).prototype.onLoad=function(){a.Instance=this},t.prototype.setAndRefresh=function(t){this.user=t,this.user=t,this.lblTitle.string=t.nickname,this.lblLv.string=r.DataMgr.getUserLevel(t).toFixed();var e=r.DataMgr.getUserCurrentCargoData(t);this.lblDefTank.string=(e.tank||0).toFixed(),this.lblDefChopper.string=(e.chopper||0).toFixed(),this.lblDefShip.string=(e.ship||0).toFixed(),this.SldAtkTank.progress=0,this.SldAtkChopper.progress=0,this.SldAtkShip.progress=0,this.onSliderChange(null,"Tank"),this.onSliderChange(null,"Chopper"),this.onSliderChange(null,"Ship"),this.refreshDistance()},t.prototype.onSliderChange=function(t,e){switch(e){case"Tank":this.edtAtkTank.string=(this.SldAtkTank.progress*this.tankMax).toFixed();break;case"Chopper":this.edtAtkChopper.string=(this.SldAtkChopper.progress*this.chopperMax).toFixed();break;case"Ship":this.edtAtkShip.string=(this.SldAtkShip.progress*this.shipMax).toFixed()}this.refreshDistance()},t.prototype.onEditBoxChange=function(t,e){switch(e){case"Tank":var a=parseInt(this.edtAtkTank.string);a=Math.max(0,Math.min(this.tankMax,a)),this.edtAtkTank.string=a.toFixed(),this.SldAtkTank.progress=a/this.tankMax;break;case"Chopper":a=parseInt(this.edtAtkChopper.string),a=Math.max(0,Math.min(this.chopperMax,a)),this.edtAtkChopper.string=a.toFixed(),this.SldAtkChopper.progress=a/this.chopperMax;break;case"Ship":a=parseInt(this.edtAtkShip.string),a=Math.max(0,Math.min(this.shipMax,a)),this.edtAtkShip.string=a.toFixed(),this.SldAtkShip.progress=a/this.shipMax}this.refreshDistance()},t.prototype.update=function(t){var e=r.DataMgr.getUserCurrentCargoData(r.DataMgr.myUser);this.tankMax=Math.floor(e.tank),this.lblAtkTankMax.string="/"+this.tankMax.toFixed(),this.chopperMax=Math.floor(e.chopper),this.lblAtkChopperMax.string="/"+this.chopperMax.toFixed(),this.shipMax=Math.floor(e.ship),this.lblAtkShipMax.string="/"+this.shipMax.toFixed()},t.prototype.refreshDistance=function(){var t=r.DataMgr.getUserCurrentLocation(this.user).sub(r.DataMgr.getUserCurrentLocation(r.DataMgr.myUser)).mag();this.lblDistance.string=t.toFixed()+"km"},t.prototype.onConfirmClick=function(){console.log("想要攻打玩家",this.user.address);var t=r.DataMgr.getUserCurrentLocation(this.user),e=r.DataMgr.getUserCurrentLocation(r.DataMgr.myUser);100<t.sub(e).mag()?i.default.PopupWith2Buttons("警告：可能失败的区块链调用","距离100km之内才能攻打其他玩家，强行发送交易可能会失败。","确定",null,"强行发送",this.confirmAttack.bind(this)):this.confirmAttack()},t.prototype.confirmAttack=function(){var t=Math.round(this.SldAtkTank.progress*this.tankMax),e=Math.round(this.SldAtkChopper.progress*this.chopperMax),a=Math.round(this.SldAtkShip.progress*this.shipMax);n.default.Instance.callFunction("attackUserCity",[this.user.address,{tank:t,chopper:e,ship:a}],0,function(t){"Error"!=t.toString().substr(0,5)?i.default.PopupWith2Buttons("正在递交作战计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):o.default.Toast("交易失败:"+t)})},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([c(cc.Label)],t.prototype,"lblTitle",void 0),__decorate([c(cc.Label)],t.prototype,"lblLv",void 0),__decorate([c(cc.Label)],t.prototype,"lblDefTank",void 0),__decorate([c(cc.Label)],t.prototype,"lblDefChopper",void 0),__decorate([c(cc.Label)],t.prototype,"lblDefShip",void 0),__decorate([c(cc.Label)],t.prototype,"lblAtkTankMax",void 0),__decorate([c(cc.Label)],t.prototype,"lblAtkChopperMax",void 0),__decorate([c(cc.Label)],t.prototype,"lblAtkShipMax",void 0),__decorate([c(cc.EditBox)],t.prototype,"edtAtkTank",void 0),__decorate([c(cc.EditBox)],t.prototype,"edtAtkChopper",void 0),__decorate([c(cc.EditBox)],t.prototype,"edtAtkShip",void 0),__decorate([c(cc.Slider)],t.prototype,"SldAtkTank",void 0),__decorate([c(cc.Slider)],t.prototype,"SldAtkChopper",void 0),__decorate([c(cc.Slider)],t.prototype,"SldAtkShip",void 0),__decorate([c(cc.Label)],t.prototype,"lblDistance",void 0),t=a=__decorate([l],t);var a}(cc.Component);a.default=d,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","../DataMgr":"DataMgr","./DialogPanel":"DialogPanel","./ToastPanel":"ToastPanel"}],AttackPiratePanel:[function(t,e,a){"use strict";cc._RF.push(e,"233d5+KYfFEMKHBsb/Gf1Qg","AttackPiratePanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../DataMgr"),n=t("../BlockchainMgr"),o=t("./ToastPanel"),i=t("./DialogPanel"),s=cc._decorator,l=s.ccclass,c=s.property,d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblTitle=null,t.lblLv=null,t.lblDefTank=null,t.lblDefChopper=null,t.lblDefShip=null,t.lblAtkTankMax=null,t.lblAtkChopperMax=null,t.lblAtkShipMax=null,t.edtAtkTank=null,t.edtAtkChopper=null,t.edtAtkShip=null,t.SldAtkTank=null,t.SldAtkChopper=null,t.SldAtkShip=null,t.lblDistance=null,t.tankMax=0,t.chopperMax=0,t.shipMax=0,t}return __extends(t,e),(a=t).prototype.onLoad=function(){a.Instance=this},t.prototype.setAndRefresh=function(t){this.pirateData=t,this.pirateData=t,this.lblTitle.string="海盗 #"+t.index.toString(),this.lblLv.string=t.lv.toString(),this.lblDefTank.string=(t.army.tank||0).toFixed(),this.lblDefChopper.string=(t.army.chopper||0).toFixed(),this.lblDefShip.string=(t.army.ship||0).toFixed(),this.SldAtkTank.progress=0,this.SldAtkChopper.progress=0,this.SldAtkShip.progress=0,this.onSliderChange(null,"Tank"),this.onSliderChange(null,"Chopper"),this.onSliderChange(null,"Ship"),this.refreshDistance()},t.prototype.onSliderChange=function(t,e){switch(e){case"Tank":this.edtAtkTank.string=(this.SldAtkTank.progress*this.tankMax).toFixed();break;case"Chopper":this.edtAtkChopper.string=(this.SldAtkChopper.progress*this.chopperMax).toFixed();break;case"Ship":this.edtAtkShip.string=(this.SldAtkShip.progress*this.shipMax).toFixed()}this.refreshDistance()},t.prototype.onEditBoxChange=function(t,e){switch(e){case"Tank":var a=parseInt(this.edtAtkTank.string);a=Math.max(0,Math.min(this.tankMax,a)),this.edtAtkTank.string=a.toFixed(),this.SldAtkTank.progress=a/this.tankMax;break;case"Chopper":a=parseInt(this.edtAtkChopper.string),a=Math.max(0,Math.min(this.chopperMax,a)),this.edtAtkChopper.string=a.toFixed(),this.SldAtkChopper.progress=a/this.chopperMax;break;case"Ship":a=parseInt(this.edtAtkShip.string),a=Math.max(0,Math.min(this.shipMax,a)),this.edtAtkShip.string=a.toFixed(),this.SldAtkShip.progress=a/this.shipMax}this.refreshDistance()},t.prototype.update=function(t){var e=r.DataMgr.getUserCurrentCargoData(r.DataMgr.myUser);this.tankMax=Math.floor(e.tank),this.lblAtkTankMax.string="/"+this.tankMax.toFixed(),this.chopperMax=Math.floor(e.chopper),this.lblAtkChopperMax.string="/"+this.chopperMax.toFixed(),this.shipMax=Math.floor(e.ship),this.lblAtkShipMax.string="/"+this.shipMax.toFixed()},t.prototype.refreshDistance=function(){var t=new cc.Vec2(this.pirateData.x,this.pirateData.y).sub(r.DataMgr.getUserCurrentLocation(r.DataMgr.myUser)).mag();this.lblDistance.string=t.toFixed()+"km"},t.prototype.onConfirmClick=function(){console.log("想要攻打海盗",this.pirateData.index);var t=new cc.Vec2(this.pirateData.x,this.pirateData.y),e=r.DataMgr.getUserCurrentLocation(r.DataMgr.myUser);300<t.sub(e).mag()?i.default.PopupWith2Buttons("警告：可能失败的区块链调用","距离300km之内才能攻打海盗，强行发送交易可能会失败。","确定",null,"强行发送",this.confirmAttack.bind(this)):this.confirmAttack()},t.prototype.confirmAttack=function(){var t=Math.round(this.SldAtkTank.progress*this.tankMax),e=Math.round(this.SldAtkChopper.progress*this.chopperMax),a=Math.round(this.SldAtkShip.progress*this.shipMax);n.default.Instance.callFunction("attackPirate",[this.pirateData.index,{tank:t,chopper:e,ship:a}],0,function(t){"Error"!=t.toString().substr(0,5)?i.default.PopupWith2Buttons("正在递交作战计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):o.default.Toast("交易失败:"+t)})},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([c(cc.Label)],t.prototype,"lblTitle",void 0),__decorate([c(cc.Label)],t.prototype,"lblLv",void 0),__decorate([c(cc.Label)],t.prototype,"lblDefTank",void 0),__decorate([c(cc.Label)],t.prototype,"lblDefChopper",void 0),__decorate([c(cc.Label)],t.prototype,"lblDefShip",void 0),__decorate([c(cc.Label)],t.prototype,"lblAtkTankMax",void 0),__decorate([c(cc.Label)],t.prototype,"lblAtkChopperMax",void 0),__decorate([c(cc.Label)],t.prototype,"lblAtkShipMax",void 0),__decorate([c(cc.EditBox)],t.prototype,"edtAtkTank",void 0),__decorate([c(cc.EditBox)],t.prototype,"edtAtkChopper",void 0),__decorate([c(cc.EditBox)],t.prototype,"edtAtkShip",void 0),__decorate([c(cc.Slider)],t.prototype,"SldAtkTank",void 0),__decorate([c(cc.Slider)],t.prototype,"SldAtkChopper",void 0),__decorate([c(cc.Slider)],t.prototype,"SldAtkShip",void 0),__decorate([c(cc.Label)],t.prototype,"lblDistance",void 0),t=a=__decorate([l],t);var a}(cc.Component);a.default=d,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","../DataMgr":"DataMgr","./DialogPanel":"DialogPanel","./ToastPanel":"ToastPanel"}],BaseUI:[function(t,e,a){"use strict";cc._RF.push(e,"3b934a4EjZFs6JzaRDhWpVf","BaseUI"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=(r.property,function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e=__decorate([n],e)}(cc.Component));a.default=o,cc._RF.pop()},{}],BlockchainMgr:[function(t,e,p){"use strict";cc._RF.push(e,"3ffefed5pBCD40DXf/kM6bs","BlockchainMgr"),Object.defineProperty(p,"__esModule",{value:!0});var n=t("./DataMgr"),a=t("./WorldUI"),r=t("./CityUI"),o=t("./CvsMain"),f=t("./HomeUI"),i=t("./MainCtrl"),g=t("./Internal/FakeBC"),s=cc._decorator,l=s.ccclass;s.property;p.ContractAddress="n1wJnaszNyRzV8EFmA7UMnkXSC4Cugb8Zp8",p.EncKey=37234;var c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.checkWalletCountdown=1e9,t.fetchMyDataInterval=1e9,t.fetchAllDataCountdown=1e9,t}return __extends(t,e),(u=t).prototype.onLoad=function(){u.Instance=this},t.getExplorerOfAccount=function(t){return"https://explorer.neo.org/#/address/"+t},t.getExplorerOfTx=function(t){return"https://explorer.neo.org/#/tx/"+t},t.prototype.start=function(){this.checkWalletCountdown=1,this.fetchMyDataInterval=1,this.fetchAllDataCountdown=2},t.prototype.update=function(t){if(this.checkWalletCountdown-=t,this.fetchMyDataInterval-=t,this.fetchAllDataCountdown-=t,this.checkWalletCountdown<=0){if(u.UseFake)u.WalletAddress="APL5FCFSZrnG8L3cinkDRmXFDb27quJUWE",f.default.Instance.edtBlockchainAddress.string=u.WalletAddress?u.WalletAddress:"";else try{try{Neb,NebPay}catch(t){return}var e=this;(d=new Neb).setRequest(new HttpRequest(u.BlockchainUrl)),d.api.getNebState().then(function(t){window.addEventListener("message",e.onGetWalletData),window.postMessage({target:"contentscript",data:{},method:"getAccount"},"*")})}catch(t){console.error(t)}this.checkWalletCountdown=u.CheckWalletInterval}if(this.fetchMyDataInterval<=0&&u.WalletAddress){var a=u.WalletAddress,r="0",n="0",o="1000000",i="2000000",s={function:c="getUser",args:JSON.stringify([u.WalletAddress])},l=this;if(u.UseFake)l.onGetMyData(g.default.instance.callFunction(a,c,s.args,0));else(d=new Neb).setRequest(new HttpRequest(u.BlockchainUrl)),d.api.call(a,p.ContractAddress,r,n,o,i,s).then(l.onGetMyData).catch(function(t){console.log("call mydata error:"+t.message,a)});this.fetchMyDataInterval=u.FetchMyDataInterval}if(this.fetchAllDataCountdown<=0){var c,d,h=u.WalletAddress?u.WalletAddress:"sdfsdfsfsdf";r="0",n="0",o="1000000",i="2000000",s={function:c="getMapInfo",args:"[]"},l=this;if(u.UseFake)l.onGetAllMapData(g.default.instance.callFunction(h,c,s.args,0));else(d=new Neb).setRequest(new HttpRequest(u.BlockchainUrl)),d.api.call(h,p.ContractAddress,r,n,o,i,s).then(l.onGetAllMapData).catch(function(t){console.log("call get_map_info error:"+t.message)});this.fetchAllDataCountdown=u.FetchAllDataInterval}},t.prototype.getFunction=function(e,t,a){try{var r=u.WalletAddress?u.WalletAddress:"sdfsfsdfs",n=e,o={function:n,args:JSON.stringify(t)};if(u.UseFake)a(g.default.instance.callFunction(r,n,o.args,"0"));else{var i=new Neb;i.setRequest(new HttpRequest(u.BlockchainUrl)),i.api.call(r,p.ContractAddress,"0","0","1000000","2000000",o).then(a).catch(function(t){console.error("Neb call "+e+" error:"+t.message)})}}catch(t){console.error(t)}},t.prototype.onGetWalletData=function(t){if(t.data&&t.data.data&&t.data.data.account&&0<t.data.data.account.length){var e=t.data.data.account;if(u.WalletAddress!=e){console.log("Change wallet address:",e),u.WalletAddress=e,f.default.Instance.edtBlockchainAddress.string=u.WalletAddress?u.WalletAddress:"",this.fetchAllDataCountdown=0;try{n.DataMgr.myUser&&n.DataMgr.myUser.address!=e&&(a.default.Instance.node.active||r.default.Instance.node.active)&&o.default.EnterUI(f.default)}catch(t){console.error(t)}}}},t.prototype.onGetMyData=function(t){console.log("onGetMyData",t);var e=JSON.parse(t.result);e&&((n.DataMgr.myUser=e).ticks=i.default.Ticks,n.DataMgr.allUsers[e.address]=n.DataMgr.myUser)},t.prototype.onGetAllMapData=function(t){console.log("onGetAllMapData",t);var e=JSON.parse(t.result).result_data,a=e.users,r=e.islands;n.DataMgr.allUsers={},a.forEach(function(t){t.address==u.WalletAddress?n.DataMgr.allUsers[t.address]=n.DataMgr.myUser:n.DataMgr.allUsers[t.address]=t}),r.forEach(function(t){n.DataMgr.allIslandData[t.index]=t})},t.prototype.callFunction=function(t,e,a,r){try{a=a?Math.ceil(1e10*a)/1e10:0,console.log("调用钱包(",t,e,a);var n=u.BlockchainUrl,o=p.ContractAddress;if(u.UseFake)r(g.default.instance.callFunction(u.WalletAddress,t,JSON.stringify(e),a));else(new NebPay).call(o,a,t,JSON.stringify(e),{qrcode:{showQRCode:!1},goods:{name:"test",desc:"test goods"},callback:n,listener:r})}catch(t){console.error(t)}},t.encrypto=function(t,e,a){if("string"==typeof t&&"number"==typeof e&&"number"==typeof a){var r=[];a=a<=25?a:a%25;for(var n=0;n<t.length;n++){var o=t.charCodeAt(n);o=(o=1*o^e).toString(a),r.push(o)}var i=String.fromCharCode(a+97);return r.join(i)}},t.UseFake=!0,t.BlockchainUrl="http://localhost:8685",t.CheckWalletInterval=10,t.FetchMyDataInterval=2,t.FetchAllDataInterval=5,t=u=__decorate([l],t);var u}(cc.Component);p.default=c,cc._RF.pop()},{"./CityUI":"CityUI","./CvsMain":"CvsMain","./DataMgr":"DataMgr","./HomeUI":"HomeUI","./Internal/FakeBC":"FakeBC","./MainCtrl":"MainCtrl","./WorldUI":"WorldUI"}],BuildPanel:[function(t,e,a){"use strict";cc._RF.push(e,"5cf0290QotGfpJodxaDGNKp","BuildPanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("./BuildingButton"),n=t("../DataMgr"),o=t("../CityUI"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.buttonContainer=null,t.buttonTemplate=null,t}return __extends(t,e),(a=t).prototype.onLoad=function(){a.Instance=this},t.prototype.start=function(){var a=this;n.DataMgr.BuildingConfig.sort(function(t,e){return t.Order-e.Order}).forEach(function(t){if("1"===t.CanBuild){var e=cc.instantiate(a.buttonTemplate);e.parent=a.buttonContainer,e.getComponent(r.default).setAndRefresh(t),e.active=!0}}),this.buttonTemplate.active=!1},t.prototype.onEnable=function(){},t.prototype.refresh=function(){},t.prototype.onBtnExpandClick=function(){o.default.Instance.enterExpandMode(),this.close()},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([l(cc.Node)],t.prototype,"buttonContainer",void 0),__decorate([l(cc.Node)],t.prototype,"buttonTemplate",void 0),t=a=__decorate([s],t);var a}(cc.Component);a.default=c,cc._RF.pop()},{"../CityUI":"CityUI","../DataMgr":"DataMgr","./BuildingButton":"BuildingButton"}],BuildingButton:[function(t,e,a){"use strict";cc._RF.push(e,"7884bIsfolMCKOoH+GiGik+","BuildingButton"),Object.defineProperty(a,"__esModule",{value:!0});var s=t("./BuildPanel"),l=t("../DataMgr"),c=t("./ToastPanel"),d=t("../CvsMain"),h=t("../CityUI"),u=t("../Utils/CurrencyFormatter"),r=t("./BuildingInfoPanel"),n=cc._decorator,o=n.ccclass,i=n.property,p=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblName=null,t.lblConsumption=null,t}return __extends(t,e),t.prototype.setAndRefresh=function(t){this.info=t,this.lblName.string=t.Name;for(var e=[],a=0;a<3;a++){var r="BuildMat"+a,n=t[r];if(n){var o=t[r+"Cnt"],i=l.DataMgr.getCargoInfo(n);e.push(o+" "+i.Name)}}var s=Number(t.Money);0<s&&e.push(u.default.formatNAS(s)+l.DataMgr.coinUnit),this.lblConsumption.string=e.join("\n")},t.prototype.onClick=function(){r.default.Show(this.info)},t.prototype.onBuildClick=function(){for(var t=this.info,e=l.DataMgr.getUserCurrentCargoData(l.DataMgr.myUser),a=!0,r=0;r<3;r++){var n="BuildMat"+r,o=t[n];if(o){var i=t[n+"Cnt"];e[o]<i&&(a=!1)}}a||c.default.Toast("某些货物不足。如果强行发送区块链交易，可能失败。"),d.default.ClosePanel(s.default),h.default.Instance.enterBuildMode(this.info)},__decorate([i(cc.Label)],t.prototype,"lblName",void 0),__decorate([i(cc.Label)],t.prototype,"lblConsumption",void 0),t=__decorate([o],t)}(cc.Component);a.default=p,cc._RF.pop()},{"../CityUI":"CityUI","../CvsMain":"CvsMain","../DataMgr":"DataMgr","../Utils/CurrencyFormatter":"CurrencyFormatter","./BuildPanel":"BuildPanel","./BuildingInfoPanel":"BuildingInfoPanel","./ToastPanel":"ToastPanel"}],BuildingInfoPanel:[function(t,e,a){"use strict";cc._RF.push(e,"3a0f2BiXhFBZ7J7uLjk6n4I","BuildingInfoPanel"),Object.defineProperty(a,"__esModule",{value:!0});var d=t("../DataMgr"),s=t("../CvsMain"),h=t("./BuildingInfoProgressFrame"),u=t("./DialogPanel"),p=t("./ToastPanel"),f=t("../BlockchainMgr"),l=t("../CityUI"),g=t("./BuildPanel"),r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblName=null,t.lblLv=null,t.lblUpperInfoName=null,t.sprPic=null,t.cargoFrameTemplate=null,t.cargoFrameContainer=null,t.cargoFrameList=[],t.lblNeedTime=null,t.progressFrameTemplate=null,t.progressFrameContainer=null,t.progressFrameList=[],t.btnBuild=null,t.btnUpgrade=null,t}return __extends(t,e),(c=t).prototype.onLoad=function(){c.Instance=this},t.prototype.start=function(){this.cargoFrameTemplate.active=!1,this.progressFrameTemplate.active=!1},t.prototype.setAndRefreshInfo=function(t){this.info=t,this.lblName.string=t.Name,this.lblLv.string="Max Lv "+(Number(t.MaxLevel)+1),this.lblUpperInfoName.string="建造需要",this._refreshPic(t);for(var e={},a=0;a<4;a++){var r=t["BuildMat"+a];if(r&&0<r.length){var n=Number(t["BuildMat"+a+"Cnt"]);e[r]=n}}if(this._refreshMats(e),this._refreshProgressFrames(null,t),"producer"===t.Type){var o=t.CDPerUnit*t.MaxQueue/60;this.lblNeedTime.string=o+"h"}else this.lblNeedTime.string="0min";this.btnBuild.active=!0,this.btnUpgrade.active=!1},t.prototype.setAndRefreshBuilding=function(t,e){this.ij=t,this.data=e;var a=d.DataMgr.getBuildingInfo(e.id);this.info=a,this._refreshPic(a),this.lblName.string=a.Name,this.lblLv.string="Lv "+(e.lv+1).toString(),this.lblUpperInfoName.string="升级需要";for(var r={},n=0;n<4;n++){var o=a["BuildMat"+n];if(o&&0<o.length){var i=d.DataMgr.getBuildingInfoItemWithLv(a.id,"BuildMat"+n+"Cnt",e.lv+1);r[o]=i}}this._refreshMats(r),this._refreshProgressFrames(e,a);var s=a.MaxLevel;if(e.lv<s)if("producer"===a.Type){var l=d.DataMgr.getBuildingInfoItemWithLv(a.id,"CDPerUnit",e.lv+1)*d.DataMgr.getBuildingInfoItemWithLv(a.id,"MaxQueue",e.lv+1)/60;this.lblNeedTime.string=l+"h"}else this.lblNeedTime.string="0min";else this.lblNeedTime.string="--";this.btnBuild.active=!1,this.btnUpgrade.active=e.lv<s},t.prototype._refreshPic=function(t){if(this.sprPic)try{var a=this;t.Pic?cc.loader.loadRes("buildings/"+t.Pic,cc.SpriteFrame,function(t,e){t||(a.sprPic.spriteFrame=e)}):this.sprPic.spriteFrame=null}catch(t){console.error(t),this.sprPic.spriteFrame=null}},t.prototype._refreshMats=function(t){console.log("mats",t);var e=0;for(var a in t){var r=void 0;e<this.cargoFrameList.length?r=this.cargoFrameList[e]:((r=cc.instantiate(this.cargoFrameTemplate)).parent=this.cargoFrameContainer,this.cargoFrameList.push(r),r.active=!0),r.getComponent(cc.Label).string=t[a].toFixed()+" "+d.DataMgr.getCargoInfo(a).Name,e++}for(;e<this.cargoFrameList.length;e++)this.cargoFrameList[e].destroy()},t.prototype._refreshProgressFrames=function(t,e){var a=0;for(var r in c.upgradableItems){var n=void 0,o={},i=e[r];if(i&&0<i.length){var s=Number(e.MaxLevel),l=c.upgradableItems[r];o.name=l.getName(e),o.valueMax=l.transValue(d.DataMgr.getBuildingInfoItemWithLv(e.id,r,s)),o.valueNext=t&&t.lv<s?l.transValue(d.DataMgr.getBuildingInfoItemWithLv(e.id,r,t.lv+1)):null,o.valueCur=l.transValue(d.DataMgr.getBuildingInfoItemWithLv(e.id,r,t?t.lv:0)),o.unit=l.getUnit(),a<this.progressFrameList.length?n=this.progressFrameList[a]:((n=cc.instantiate(this.progressFrameTemplate)).parent=this.progressFrameContainer,this.progressFrameList.push(n),n.active=!0),n.getComponent(h.BuildingInfoProgressFrame).refresh(o),a++}}for(;a<this.progressFrameList.length;a++)this.progressFrameList[a].destroy()},t.prototype.onBuildClick=function(){for(var t=this.info,e=d.DataMgr.getUserCurrentCargoData(d.DataMgr.myUser),a=!0,r=0;r<3;r++){var n="BuildMat"+r,o=t[n];if(o){var i=t[n+"Cnt"];e[o]<i&&(a=!1)}}a||p.default.Toast("某些货物不足。如果强行发送区块链交易，可能失败。"),s.default.ClosePanel(c),s.default.ClosePanel(g.default),l.default.Instance.enterBuildMode(t)},t.prototype.onUpgradeClick=function(){for(var t=this.info,e=d.DataMgr.getUserCurrentCargoData(d.DataMgr.myUser),a=!0,r=0;r<3;r++){var n="BuildMat"+r,o=t[n];if(o){var i=n+"Cnt",s=d.DataMgr.getBuildingInfoItemWithLv(this.info.id,i,this.data.lv+1);e[o]<s&&(a=!1)}}a||p.default.Toast("某些货物不足。如果强行发送区块链交易，可能失败。");var l=[this.ij.i,this.ij.j];f.default.Instance.callFunction("upgradeBuilding",l,0,function(t){"Error"!=t.toString().substr(0,5)?u.default.PopupWith2Buttons("正在递交升级计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):p.default.Toast("交易失败:"+t)})},t.Show=function(e){var t;t="string"==typeof e?d.DataMgr.BuildingConfig.find(function(t){return t.id==e}):e,s.default.OpenPanel("BuildingInfoPanel",function(){return c.Instance.setAndRefreshInfo(t)})},t.ShowBuildingData=function(t,e){s.default.OpenPanel("BuildingInfoPanel",function(){return c.Instance.setAndRefreshBuilding(t,e)})},t.prototype.close=function(){this.node.destroy(),c.Instance=null},t.upgradableItems={Out0Rate:{getName:function(t){var e=t.Out0;return e?"产出 "+d.DataMgr.getCargoInfo(e).Name:null},transValue:function(t){return t},getUnit:function(){return""}},CDPerUnit:{getName:function(t){return"生产冷却速度"},transValue:function(t){return Math.round(60/t*100)/100},getUnit:function(){return"/h"}},MaxQueue:{getName:function(t){return"生产队列容量"},transValue:function(t){return t},getUnit:function(){return""}},Capacity:{getName:function(t){return"容量"},transValue:function(t){return t},getUnit:function(){return""}}},__decorate([o(cc.Label)],t.prototype,"lblName",void 0),__decorate([o(cc.Label)],t.prototype,"lblLv",void 0),__decorate([o(cc.Label)],t.prototype,"lblUpperInfoName",void 0),__decorate([o(cc.Sprite)],t.prototype,"sprPic",void 0),__decorate([o(cc.Node)],t.prototype,"cargoFrameTemplate",void 0),__decorate([o(cc.Node)],t.prototype,"cargoFrameContainer",void 0),__decorate([o(cc.Label)],t.prototype,"lblNeedTime",void 0),__decorate([o(cc.Node)],t.prototype,"progressFrameTemplate",void 0),__decorate([o(cc.Node)],t.prototype,"progressFrameContainer",void 0),__decorate([o(cc.Node)],t.prototype,"btnBuild",void 0),__decorate([o(cc.Node)],t.prototype,"btnUpgrade",void 0),t=c=__decorate([n],t);var c}(cc.Component);a.default=i,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","../CityUI":"CityUI","../CvsMain":"CvsMain","../DataMgr":"DataMgr","./BuildPanel":"BuildPanel","./BuildingInfoProgressFrame":"BuildingInfoProgressFrame","./DialogPanel":"DialogPanel","./ToastPanel":"ToastPanel"}],BuildingInfoProgressFrame:[function(t,e,a){"use strict";cc._RF.push(e,"cee92SDenpGpZusiRHlXrCH","BuildingInfoProgressFrame"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblName=null,t.prgUpgraded=null,t.prgCurrent=null,t.lblNum=null,t}return __extends(t,e),t.prototype.refresh=function(t){this.lblName.string=t.name,t.valueNext?(this.prgUpgraded.progress=t.valueNext/t.valueMax,this.prgCurrent.progress=t.valueCur/t.valueMax,this.lblNum.string=t.valueCur+"+"+t.valueNext):(this.prgUpgraded.progress=0,this.prgCurrent.progress=t.valueCur/t.valueMax,this.lblNum.string=t.valueCur)},__decorate([o(cc.Label)],t.prototype,"lblName",void 0),__decorate([o(cc.ProgressBar)],t.prototype,"prgUpgraded",void 0),__decorate([o(cc.ProgressBar)],t.prototype,"prgCurrent",void 0),__decorate([o(cc.Label)],t.prototype,"lblNum",void 0),t=__decorate([n],t)}(cc.Component);a.BuildingInfoProgressFrame=i,cc._RF.pop()},{}],Building:[function(t,e,a){"use strict";cc._RF.push(e,"3d090TfsndH9pF8dNZnNchl","Building"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../CityUI"),n=t("../DataMgr"),o=cc._decorator,i=o.ccclass,s=o.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.sprPic=null,t.lblName=null,t.lblLv=null,t.frmInfo=null,t}return __extends(t,e),t.prototype.onClick=function(){r.default.Instance.selectBuilding(this)},t.prototype.setIJ=function(t,e){this.ij=new n.IJ,this.ij.i=t,this.ij.j=e},t.prototype.setInfo=function(t,e){if(this.info=t,this.data=e,this.lblName&&(this.lblName.string=t.Name),this.lblLv&&(this.lblLv.string="Lv. "+(e.lv+1)),this.sprPic)try{var a=this;t.Pic?cc.loader.loadRes("buildings/"+t.Pic,cc.SpriteFrame,function(t,e){t||(a.sprPic.spriteFrame=e)}):this.sprPic.spriteFrame=null}catch(t){console.error(t),this.sprPic.spriteFrame=null}this.frmInfo.active=r.default.Instance.togShowBuildingInfo.isChecked,this.refresh()},t.prototype.refresh=function(){},__decorate([s(cc.Sprite)],t.prototype,"sprPic",void 0),__decorate([s(cc.Label)],t.prototype,"lblName",void 0),__decorate([s(cc.Label)],t.prototype,"lblLv",void 0),__decorate([s(cc.Node)],t.prototype,"frmInfo",void 0),t=__decorate([i],t)}(cc.Component);a.default=l,cc._RF.pop()},{"../CityUI":"CityUI","../DataMgr":"DataMgr"}],CityInfoPanel:[function(t,e,a){"use strict";cc._RF.push(e,"351edSZ0ChFNrMmUX1JPdCk","CityInfoPanel"),Object.defineProperty(a,"__esModule",{value:!0});var s=t("../DataMgr"),n=t("../BlockchainMgr"),o=t("./ToastPanel"),l=t("./DialogPanel"),c=t("../Utils/CurrencyFormatter"),d=t("./FlagMgr"),r=cc._decorator,h=r.ccclass,u=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblTitle=null,t.lblLv=null,t.lblDefTank=null,t.lblDefChopper=null,t.lblDefShip=null,t.sprPic=null,t.grpWatch=null,t.grpAttack=null,t.grpWatchCity=null,t.grpWatchIsland=null,t.grpWatchCityUser=null,t.grpLv=null,t.lblHull=null,t.cargoFrameTemplate=null,t.cargoFrameContainer=null,t.cargoFrameList=[],t.lblDistanceLimit=null,t.lblAtkTankMax=null,t.lblAtkChopperMax=null,t.lblAtkShipMax=null,t.edtAtkTank=null,t.edtAtkChopper=null,t.edtAtkShip=null,t.SldAtkTank=null,t.SldAtkChopper=null,t.SldAtkShip=null,t.lblDistance=null,t.lblMineRate=null,t.lblOccupantNickname=null,t.lblOccupantAddress=null,t.lblTotalMoney=null,t.lblWantToAttack=null,t.lblConfirmAttack=null,t.sprFlag=null,t.tankMax=0,t.chopperMax=0,t.shipMax=0,t}return __extends(t,e),(i=t).prototype.onLoad=function(){i.Instance=this},t.prototype.setAndRefreshUser=function(t,e){this.pirateData=null,this.islandData=null,this.user=t,this.lblTitle.string=t.nickname,this.lblLv.string=s.DataMgr.getUserLevel(t).toFixed();var a=s.DataMgr.getUserCurrentCargoData(t);switch(this.lblDefTank.string=(a.tank||0).toFixed(),this.lblDefChopper.string=(a.chopper||0).toFixed(),this.lblDefShip.string=(a.ship||0).toFixed(),this.lblDistanceLimit.string=i.attackUserDistanceLimit+"km",e){case"watch":var r=0;for(var n in a){var o=void 0;r<this.cargoFrameList.length?o=this.cargoFrameList[r]:((o=cc.instantiate(this.cargoFrameTemplate)).parent=this.cargoFrameContainer,this.cargoFrameList.push(o),o.active=!0),o.getChildByName("LblCargo").getComponent(cc.Label).string=s.DataMgr.getCargoInfo(n).Name+"  "+a[n].toFixed(),r++}for(;r<this.cargoFrameList.length;r++)this.cargoFrameList[r].destroy();this.grpWatch.active=!0,this.grpAttack.active=!1,this.grpWatchCity.active=!0,this.grpWatchIsland.active=!1,this.grpWatchCityUser.active=!0;break;case"attack":this.SldAtkTank.progress=0,this.SldAtkChopper.progress=0,this.SldAtkShip.progress=0,this.onSliderChange(null,"Tank"),this.onSliderChange(null,"Chopper"),this.onSliderChange(null,"Ship"),this.refreshDistance(),this.grpWatch.active=!1,this.grpAttack.active=!0}this.grpLv.active=!0,this.refreshDistance()},t.prototype.setAndRefreshPirate=function(t,e){switch(this.user=null,this.islandData=null,this.pirateData=t,this.lblTitle.string="海盗 #"+t.index.toString(),this.lblLv.string=t.lv.toString(),this.lblDefTank.string=(t.army.tank||0).toFixed(),this.lblDefChopper.string=(t.army.chopper||0).toFixed(),this.lblDefShip.string=(t.army.ship||0).toFixed(),this.lblDistanceLimit.string=i.attackPirateDistanceLimit+"km",e){case"watch":var a=t.cargo,r=0;for(var n in a){var o=void 0;r<this.cargoFrameList.length?o=this.cargoFrameList[r]:((o=cc.instantiate(this.cargoFrameTemplate)).parent=this.cargoFrameContainer,this.cargoFrameList.push(o),o.active=!0),o.getChildByName("LblCargo").getComponent(cc.Label).string=s.DataMgr.getCargoInfo(n).Name+"  "+a[n].toFixed(),r++}for(;r<this.cargoFrameList.length;r++)this.cargoFrameList[r].destroy();this.grpWatch.active=!0,this.grpAttack.active=!1,this.grpWatchCity.active=!0,this.grpWatchIsland.active=!1,this.grpWatchCityUser.active=!1;break;case"attack":this.SldAtkTank.progress=0,this.SldAtkChopper.progress=0,this.SldAtkShip.progress=0,this.onSliderChange(null,"Tank"),this.onSliderChange(null,"Chopper"),this.onSliderChange(null,"Ship"),this.refreshDistance(),this.grpWatch.active=!1,this.grpAttack.active=!0}this.grpLv.active=!0,this.refreshDistance()},t.prototype.setAndRefreshIsland=function(t,e){if(this.user=null,this.islandData=t,this.pirateData=null,this.lblTitle.string="钻石岛 sponsered by "+t.sponsorName,t.occupant&&0<t.occupant.length){var a=s.DataMgr.allUsers[t.occupant];d.FlagMgr.setFlag(this.sprFlag,a?a.country:null),this.lblOccupantNickname.string=a?a.nickname:""}else this.lblOccupantNickname.string="(无)";this.lblOccupantAddress.string=t.occupant,this.lblDefTank.string=(t.army.tank||0).toFixed(),this.lblDefChopper.string=(t.army.chopper||0).toFixed(),this.lblDefShip.string=(t.army.ship||0).toFixed(),this.lblDistanceLimit.string=i.attackIslandDistanceLimit+"km";var r=s.DataMgr.myUser.address==t.occupant;switch(e){case"watch":this.lblWantToAttack.string=r?"追加":"进攻",this.grpWatch.active=!0,this.grpAttack.active=!1,this.grpWatchCity.active=!1,this.grpWatchIsland.active=!0,this.grpWatchCityUser.active=!1;break;case"attack":this.lblConfirmAttack.string=r?"追加":"进攻";var n=(s.DataMgr.getBlockchainTimestamp()-t.lastCalcTime)/36e5,o=Math.exp(-.05*n);this.lblDefTank.string=((t.army.tank||0)*o).toFixed(),this.lblDefChopper.string=((t.army.chopper||0)*o).toFixed(),this.lblDefShip.string=((t.army.ship||0)*o).toFixed(),this.SldAtkTank.progress=0,this.SldAtkChopper.progress=0,this.SldAtkShip.progress=0,this.onSliderChange(null,"Tank"),this.onSliderChange(null,"Chopper"),this.onSliderChange(null,"Ship"),this.grpWatch.active=!1,this.grpAttack.active=!0}this.grpLv.active=!1,this.refreshDistance()},t.prototype.onSliderChange=function(t,e){switch(e){case"Tank":this.edtAtkTank.string=(this.SldAtkTank.progress*this.tankMax).toFixed();break;case"Chopper":this.edtAtkChopper.string=(this.SldAtkChopper.progress*this.chopperMax).toFixed();break;case"Ship":this.edtAtkShip.string=(this.SldAtkShip.progress*this.shipMax).toFixed()}this.refreshDistance()},t.prototype.onEditBoxChange=function(t,e){switch(e){case"Tank":var a=parseInt(this.edtAtkTank.string);a=Math.max(0,Math.min(this.tankMax,a)),this.edtAtkTank.string=a.toFixed(),this.SldAtkTank.progress=a/this.tankMax;break;case"Chopper":a=parseInt(this.edtAtkChopper.string),a=Math.max(0,Math.min(this.chopperMax,a)),this.edtAtkChopper.string=a.toFixed(),this.SldAtkChopper.progress=a/this.chopperMax;break;case"Ship":a=parseInt(this.edtAtkShip.string),a=Math.max(0,Math.min(this.shipMax,a)),this.edtAtkShip.string=a.toFixed(),this.SldAtkShip.progress=a/this.shipMax}this.refreshDistance()},t.prototype.update=function(t){switch(!0){case this.grpAttack.active:var e=s.DataMgr.getUserCurrentCargoData(s.DataMgr.myUser);this.tankMax=Math.floor(e.tank),this.lblAtkTankMax.string="/"+this.tankMax.toFixed(),this.chopperMax=Math.floor(e.chopper),this.lblAtkChopperMax.string="/"+this.chopperMax.toFixed(),this.shipMax=Math.floor(e.ship),this.lblAtkShipMax.string="/"+this.shipMax.toFixed(),this.refreshDistance()}if(this.islandData){var a=s.DataMgr.calcCurrentMoneyInIsland(this.islandData),r=this.islandData.miningRate*a/1e18;this.lblMineRate.string=c.default.formatNAS(r)+s.DataMgr.coinUnit+"/h",this.lblTotalMoney.string=c.default.formatNAS(a/1e18)+s.DataMgr.coinUnit}},t.prototype.refreshDistance=function(){var t;this.user?t=s.DataMgr.getUserCurrentLocation(this.user):this.pirateData?t=new cc.Vec2(this.pirateData.x,this.pirateData.y):this.islandData&&(t=new cc.Vec2(this.islandData.x,this.islandData.y));var e=t.sub(s.DataMgr.getUserCurrentLocation(s.DataMgr.myUser)).mag();this.lblDistance.string=e.toFixed()+"km"},t.prototype.onWantToAttackClick=function(){if(this.user)console.log("想要攻打玩家",this.user.address),(t=function(t){i.Instance.setAndRefreshUser(t,"attack")})(s.DataMgr.allUsers[this.user.address]),s.DataMgr.fetchUserDataFromBlockchain(this.user.address,t);else if(this.pirateData){console.log("想要攻打海盗",this.pirateData.index),(t=function(t){i.Instance.setAndRefreshPirate(t,"attack")})(s.DataMgr.getPirateData(this.pirateData.index)),s.DataMgr.fetchPirateDataFromBlockchain(this.pirateData.index,t)}else if(this.islandData){var t;console.log("想要攻打钻石岛",this.islandData.index),(t=function(t){i.Instance.setAndRefreshIsland(t,"attack")})(s.DataMgr.allIslandData[this.islandData.index])}},t.prototype.onConfirmAttackClick=function(){var t=s.DataMgr.getUserCurrentLocation(s.DataMgr.myUser);if(this.user)console.log("确认攻打玩家",this.user.address),100<s.DataMgr.getUserCurrentLocation(this.user).sub(t).mag()?l.default.PopupWith2Buttons("警告：可能失败的区块链调用","距离100km之内才能攻打其他玩家，强行发送交易可能会失败。","确定",null,"强行发送",this.confirmAttack.bind(this)):this.confirmAttack();else if(this.pirateData){if(console.log("确认攻打海盗",this.pirateData.index),300<new cc.Vec2(this.pirateData.x,this.pirateData.y).sub(t).mag())return void l.default.PopupWith2Buttons("警告：可能失败的区块链调用","距离300km之内才能攻打海盗，强行发送交易可能会失败。","确定",null,"强行发送",this.confirmAttack.bind(this));this.confirmAttack()}else if(this.islandData){100<new cc.Vec2(this.islandData.x,this.islandData.y).sub(t).mag()?l.default.PopupWith2Buttons("警告：可能失败的区块链调用","距离100km之内才能攻打其他玩家，强行发送交易可能会失败。","确定",null,"强行发送",this.confirmAttack.bind(this)):this.confirmAttack()}},t.prototype.confirmAttack=function(){var t=Math.round(this.SldAtkTank.progress*this.tankMax),e=Math.round(this.SldAtkChopper.progress*this.chopperMax),a=Math.round(this.SldAtkShip.progress*this.shipMax),r=function(t){"Error"!=t.toString().substr(0,5)?l.default.PopupWith2Buttons("正在递交作战计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):o.default.Toast("交易失败:"+t)};this.user?n.default.Instance.callFunction("attackUserCity",[this.user.address,{tank:t,chopper:e,ship:a}],0,r):this.pirateData?n.default.Instance.callFunction("attackPirate",[this.pirateData.index,{tank:t,chopper:e,ship:a}],0,r):this.islandData&&n.default.Instance.callFunction("attackIsland",[this.islandData.index,{tank:t,chopper:e,ship:a}],0,r)},t.prototype.onOccupantClick=function(){window.open(n.default.getExplorerOfAccount(this.islandData.occupant))},t.prototype.close=function(){this.node.destroy(),i.Instance=null},t.attackUserDistanceLimit=100,t.attackPirateDistanceLimit=300,t.attackIslandDistanceLimit=100,__decorate([u(cc.Label)],t.prototype,"lblTitle",void 0),__decorate([u(cc.Label)],t.prototype,"lblLv",void 0),__decorate([u(cc.Label)],t.prototype,"lblDefTank",void 0),__decorate([u(cc.Label)],t.prototype,"lblDefChopper",void 0),__decorate([u(cc.Label)],t.prototype,"lblDefShip",void 0),__decorate([u(cc.Sprite)],t.prototype,"sprPic",void 0),__decorate([u(cc.Node)],t.prototype,"grpWatch",void 0),__decorate([u(cc.Node)],t.prototype,"grpAttack",void 0),__decorate([u(cc.Node)],t.prototype,"grpWatchCity",void 0),__decorate([u(cc.Node)],t.prototype,"grpWatchIsland",void 0),__decorate([u(cc.Node)],t.prototype,"grpWatchCityUser",void 0),__decorate([u(cc.Node)],t.prototype,"grpLv",void 0),__decorate([u(cc.Label)],t.prototype,"lblHull",void 0),__decorate([u(cc.Node)],t.prototype,"cargoFrameTemplate",void 0),__decorate([u(cc.Node)],t.prototype,"cargoFrameContainer",void 0),__decorate([u(cc.Label)],t.prototype,"lblDistanceLimit",void 0),__decorate([u(cc.Label)],t.prototype,"lblAtkTankMax",void 0),__decorate([u(cc.Label)],t.prototype,"lblAtkChopperMax",void 0),__decorate([u(cc.Label)],t.prototype,"lblAtkShipMax",void 0),__decorate([u(cc.EditBox)],t.prototype,"edtAtkTank",void 0),__decorate([u(cc.EditBox)],t.prototype,"edtAtkChopper",void 0),__decorate([u(cc.EditBox)],t.prototype,"edtAtkShip",void 0),__decorate([u(cc.Slider)],t.prototype,"SldAtkTank",void 0),__decorate([u(cc.Slider)],t.prototype,"SldAtkChopper",void 0),__decorate([u(cc.Slider)],t.prototype,"SldAtkShip",void 0),__decorate([u(cc.Label)],t.prototype,"lblDistance",void 0),__decorate([u(cc.Label)],t.prototype,"lblMineRate",void 0),__decorate([u(cc.Label)],t.prototype,"lblOccupantNickname",void 0),__decorate([u(cc.Label)],t.prototype,"lblOccupantAddress",void 0),__decorate([u(cc.Label)],t.prototype,"lblTotalMoney",void 0),__decorate([u(cc.Label)],t.prototype,"lblWantToAttack",void 0),__decorate([u(cc.Label)],t.prototype,"lblConfirmAttack",void 0),__decorate([u(cc.Sprite)],t.prototype,"sprFlag",void 0),t=i=__decorate([h],t);var i}(cc.Component);a.default=i,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","../DataMgr":"DataMgr","../Utils/CurrencyFormatter":"CurrencyFormatter","./DialogPanel":"DialogPanel","./FlagMgr":"FlagMgr","./ToastPanel":"ToastPanel"}],CityUI:[function(t,e,a){"use strict";cc._RF.push(e,"e7f42dM68VAz487nLcu3wTI","CityUI"),Object.defineProperty(a,"__esModule",{value:!0});var n=t("./CvsMain"),r=t("./BaseUI"),o=t("./WorldUI"),f=t("./DataMgr"),d=t("./City/Building"),l=t("./UI/DialogPanel"),i=t("./UI/BuildingInfoPanel"),c=t("./BlockchainMgr"),h=t("./UI/ToastPanel"),s=t("./UI/ProductionPanel"),g=t("./City/ProducerBuilding"),u=t("./City/ExpandModeContainer"),p=cc._decorator,m=p.ccclass,v=p.property,y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.cityMap=null,t.city=null,t.lblLv=null,t.lblHull=null,t.cargoLabelContainer=null,t.cargoLabelTemplate=null,t.cargoLabels={},t.panPad=null,t.focusFrame=null,t.sldZoom=null,t.pressingZoomSlider=!1,t.zoomScale=1,t._lastRefreshTicks=-1,t.expandModeContainer=null,t.lblExpandCost=null,t.floorTemplate=null,t.floorContainer=null,t.hqTemplate=null,t.collectorTemplate=null,t.producerTemplate=null,t.warehouseTemplate=null,t.launchsiloTemplate=null,t.buildingContainer=null,t.blueprint=null,t.blueprintIndicator=null,t.canBuildColor=new cc.Color(0,190,0),t.cannotBuildColor=new cc.Color(190,0,0),t.currentHoldingBlueprint=null,t.grpBuild=null,t.btnConfirmBuild=null,t.selectedBuilding=null,t.grpBuildingInfo=null,t.nodProduceButton=null,t.togShowBuildingInfo=null,t}return __extends(t,e),(r=t).prototype.onLoad=function(){(r.Instance=this).node.active=!1;var e=this;this.sldZoom.node.getChildByName("Handle").on(cc.Node.EventType.TOUCH_START,function(t){e.pressingZoomSlider=!0}),this.sldZoom.node.getChildByName("Handle").on(cc.Node.EventType.TOUCH_END,function(t){e.pressingZoomSlider=!1}),this.sldZoom.node.getChildByName("Handle").on(cc.Node.EventType.TOUCH_CANCEL,function(t){e.pressingZoomSlider=!1}),this.panPad.on(cc.Node.EventType.TOUCH_MOVE,this.onPanPadTouchMove,this),this.panPad.on(cc.Node.EventType.MOUSE_WHEEL,this.onMouseWheel,this),this.panPad.on(cc.Node.EventType.TOUCH_END,this.deselectBuilding,this),this.blueprint.on(cc.Node.EventType.TOUCH_MOVE,this.dragBlueprint.bind(this)),this.floorTemplate.active=!1,this.hqTemplate.active=!1,this.producerTemplate.active=!1,this.collectorTemplate.active=!1,this.warehouseTemplate.active=!1,this.launchsiloTemplate.active=!1,this.expandModeContainer.active=!1},t.prototype.start=function(){var r=this;f.DataMgr.CargoConfig.forEach(function(t){var e=cc.instantiate(r.cargoLabelTemplate);e.parent=r.cargoLabelContainer;var a=e.getComponent(cc.Label);a.string=t.Name,r.cargoLabels[t.id]=a}),this.cargoLabelTemplate.active=!1},t.prototype.onEnable=function(){this.refreshAll()},t.prototype.refreshZoom=function(){this.cityMap.scale=this.zoomScale},t.prototype.update=function(t){f.DataMgr.myUser.ticks>this._lastRefreshTicks&&(this._lastRefreshTicks=f.DataMgr.myUser.ticks,this.refreshAll());for(var e=f.DataMgr.getUserCurrentCargoData(f.DataMgr.myUser),a=0;a<f.DataMgr.CargoConfig.length;a++){var r=f.DataMgr.CargoConfig[a],n=r.id,o=void 0,i=f.DataMgr.getUserWarehouseCap(f.DataMgr.myUser,n).toFixed();if(o=r.Name+"   "+Math.floor(e[r.id]||0).toFixed()+"/"+i,f.DataMgr.getBuildingInfo(n+"coll"))o+="(+"+f.DataMgr.getUserCollectorRate(f.DataMgr.myUser,n).toFixed()+"/min)";this.cargoLabels[r.id].string=o}this.lblLv.string="Level "+f.DataMgr.getUserLevel(f.DataMgr.myUser);var s=f.DataMgr.getUserHull(f.DataMgr.myUser),l="完整度 "+(100*s).toFixed()+"%";s<1&&(l+="(+"+(100*f.DataMgr.damagePerAttackCity).toFixed()+"%/h)"),this.lblHull.string=l,this.lblHull.node.color=.3<s?cc.Color.WHITE:cc.Color.RED;var c=this.sldZoom.progress;if(this.pressingZoomSlider||(.5<c?((c-=5*t)<.5&&(c=.5),this.sldZoom.progress=c):c<.5&&(.5<(c+=5*t)&&(c=.5),this.sldZoom.progress=c)),.5!=c){var d=this.zoomScale;this.zoomScale*=Math.pow(1.5,2*(c-.5)*5*t),this.clampZoom();var h=this.zoomScale/d;this.cityMap.position=this.cityMap.position.mul(h),this.refreshZoom()}if(this.currentHoldingBlueprint){this.blueprint.active=!0,this.blueprint.position=new cc.Vec2(100*this.currentBlueprintIJ.i,100*this.currentBlueprintIJ.j);var u=!0;this.grpBuild.active=!0;var p=this.currentBlueprintIJ.i+","+this.currentBlueprintIJ.j;f.DataMgr.myUser.buildingMap[p]?u=!1:f.DataMgr.getCityIJExpanded(f.DataMgr.myUser,this.currentBlueprintIJ.i,this.currentBlueprintIJ.j)||(u=!1),this.btnConfirmBuild.interactable=u,this.blueprintIndicator.node.color=u?this.canBuildColor:this.cannotBuildColor}else this.expandModeContainer.active?this.grpBuild.active=!0:(this.blueprint.active=!1,this.grpBuild.active=!1);this.lblExpandCost.node.active=this.expandModeContainer.active,this.selectedBuilding?(this.grpBuildingInfo.active=!0,this.nodProduceButton.active=null!=this.selectedBuilding.getComponent(g.default),this.focusFrame.position=this.selectedBuilding.node.position,this.focusFrame.active=!0):(this.grpBuildingInfo.active=!1,this.focusFrame.active=!1)},t.prototype.refreshAll=function(){this.refreshBuildingData(),this.refreshZoom()},t.prototype.refreshBuildingData=function(){var a=f.DataMgr.myUser.expandMap;for(var t in a)a[t].tmpDirty=!0;for(var t in this.floorContainer.children.forEach(function(t){var e=t.name;a[e]?delete a[e].tmpDirty:t.destroy()}),a)if(a[t].tmpDirty){var e=cc.instantiate(this.floorTemplate);e.parent=this.floorContainer,e.name=t;var r=JSON.parse("["+t+"]");e.position=new cc.Vec2(100*r[0],100*r[1]),e.active=!0,console.log("createfloor",t,r),delete a[t].tmpDirty}var n=f.DataMgr.myUser.buildingMap;for(var t in n)n[t]&&(n[t].tmpDirty=!0);for(var t in this.buildingContainer.children.forEach(function(t){var e=t.getComponent(d.default),a=t.name,r=n[a];r&&e.info.id==r.id?(e.setInfo(e.info,r),delete r.tmpDirty):t.destroy()}),n)if(n[t]&&n[t].tmpDirty){var o=n[t],i=f.DataMgr.getBuildingInfo(o.id),s=i.Type+"Template",l=cc.instantiate(this[s]);l.parent=this.buildingContainer,l.name=t;var c=l.getComponent(d.default);r=JSON.parse("["+t+"]");c.setInfo(i,o),c.setIJ(r[0],r[1]),l.position=new cc.Vec2(100*r[0],100*r[1]),l.active=!0,delete n[t].tmpDirty}},t.prototype.onGotoWorldClick=function(){this.deselectBuilding(),n.default.EnterUI(o.default)},t.prototype.onBuildBtnClick=function(){this.deselectBuilding(),n.default.OpenPanel("BuildPanel")},t.prototype.onCommanderClick=function(){},t.prototype.onCenterBtnClick=function(){this.cityMap.position=new cc.Vec2(200,0)},t.prototype.onPanPadTouchMove=function(t){var e=t.getDelta();this.cityMap.position=this.cityMap.position.add(new cc.Vec2(e.x,e.y))},t.prototype.onMouseWheel=function(t){var e=t.getScrollY(),a=this.zoomScale;this.zoomScale*=Math.pow(1.5,e/120),this.clampZoom();var r=this.zoomScale/a;this.cityMap.position=this.cityMap.position.mul(r),this.refreshZoom()},t.prototype.onZoomSliderChange=function(t){},t.prototype.clampZoom=function(){3<this.zoomScale&&(this.zoomScale=3),this.zoomScale<.3&&(this.zoomScale=.3)},t.prototype.enterExpandMode=function(){this.expandModeContainer.active=!0},t.prototype.enterBuildMode=function(t){this.currentHoldingBlueprint=t;this.currentBlueprintIJ=function(){for(var t=1;;t++)for(var e=1;;e++)for(var a=-1;a<=1;a+=2)for(var r=-1;r<=1;r+=2){var n=(t*a).toFixed()+","+(e*r).toFixed();if(!f.DataMgr.myUser.buildingMap[n]){var o=new f.IJ;return o.i=t*a,o.j=e*r,o}}}()},t.prototype.dragBlueprint=function(t){var e=t.getLocation(),a=this.cityMap.convertToNodeSpaceAR(e);this.currentBlueprintIJ.i=Math.round(a.x/100),this.currentBlueprintIJ.j=Math.round(a.y/100)},t.prototype.onBtnConfirmBuildClick=function(){var e=this;if(console.log("onBtnConfirmBuildClick",this.currentHoldingBlueprint,this.currentHoldingBlueprint instanceof f.BuildingInfo),this.expandModeContainer.active){var t=this.expandModeContainer.getComponent(u.ExpandModeContainer),a=t.getIJList(),r=t.getCost(),n=f.DataMgr.getUserCurrentCargoData(f.DataMgr.myUser).floatmod||0,o=this,i=function(){return c.default.Instance.callFunction("expand",[a],0,function(t){"Error"!=t.toString().substr(0,5)?(l.default.PopupWith2Buttons("正在递交扩建计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null),o.expandModeContainer.active=!1):h.default.Toast("交易失败:"+t)})};r<=n?i():l.default.PopupWith2Buttons("浮力模块存货不足","强行发送区块链交易可能失败","确定",null,"强行发送",i)}else if(this.currentHoldingBlueprint&&this.currentHoldingBlueprint.id){var s=this.currentHoldingBlueprint.Money;c.default.Instance.callFunction("build",[this.currentBlueprintIJ.i,this.currentBlueprintIJ.j,this.currentHoldingBlueprint.id],s,function(t){"Error"!=t.toString().substr(0,5)?(l.default.PopupWith2Buttons("正在递交建造计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null),e.currentHoldingBlueprint=null):h.default.Toast("交易失败:"+t)})}else this.currentHoldingBlueprint instanceof f.IJ&&c.default.Instance.callFunction("moveBuilding",[this.currentHoldingBlueprint.i,this.currentHoldingBlueprint.j,this.currentBlueprintIJ.i,this.currentBlueprintIJ.j],0,function(t){"Error"!=t.toString().substr(0,5)?(l.default.PopupWith2Buttons("正在递交搬迁计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null),e.currentHoldingBlueprint=null):h.default.Toast("交易失败:"+t)})},t.prototype.onBtnCancelBuildClick=function(){this.currentHoldingBlueprint=null,this.expandModeContainer.active=!1},t.prototype.selectBuilding=function(t){console.log("选中建筑",t.name),this.selectedBuilding=t},t.prototype.deselectBuilding=function(){this.selectedBuilding=null},t.prototype.onMoveBuildingClick=function(){if(this.selectedBuilding){var t=this.selectedBuilding.ij;this.currentHoldingBlueprint=t,this.currentBlueprintIJ=new f.IJ,this.currentBlueprintIJ.i=t.i,this.currentBlueprintIJ.j=t.j,this.deselectBuilding()}},t.prototype.onDemolishBtnClick=function(){var e=this,a=r.Instance;this.selectedBuilding&&("hq"===this.selectedBuilding.info.id?l.default.PopupWith1Button("确定拆除总部吗？","这玩意儿可不能拆！","不拆不拆",null):l.default.PopupWith2Buttons("确定拆除建筑吗",a.selectedBuilding.info.Name+"\n可回收部分建筑材料","取消",null,"拆除",function(){var t=JSON.parse("["+e.selectedBuilding.node.name+"]");c.default.Instance.callFunction("demolish",t,0,function(t){"Error"!=t.toString().substr(0,5)?l.default.PopupWith2Buttons("正在递交拆除计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):h.default.Toast("交易失败:"+t)}),a.deselectBuilding()}))},t.prototype.onBuildingInfoBtnClick=function(){if(this.selectedBuilding){var t=this.selectedBuilding.ij;i.default.ShowBuildingData(t,this.selectedBuilding.data),this.deselectBuilding()}},t.prototype.onUpgradeBtnClick=function(){if(this.selectedBuilding){var t=this.selectedBuilding.ij;i.default.ShowBuildingData(t,this.selectedBuilding.data),this.deselectBuilding()}},t.prototype.onProduceBtnClick=function(){var t=this;n.default.OpenPanel("ProductionPanel",function(){return s.default.Instance.setAndRefresh(t.selectedBuilding,f.DataMgr.myUser.buildingMap[t.selectedBuilding.node.name])})},t.prototype.onTradeBtnClick=function(){},t.prototype.onFilterToggle=function(){this.refreshAll()},__decorate([v(cc.Node)],t.prototype,"cityMap",void 0),__decorate([v(cc.Node)],t.prototype,"city",void 0),__decorate([v(cc.Label)],t.prototype,"lblLv",void 0),__decorate([v(cc.Label)],t.prototype,"lblHull",void 0),__decorate([v(cc.Node)],t.prototype,"cargoLabelContainer",void 0),__decorate([v(cc.Node)],t.prototype,"cargoLabelTemplate",void 0),__decorate([v(cc.Node)],t.prototype,"panPad",void 0),__decorate([v(cc.Node)],t.prototype,"focusFrame",void 0),__decorate([v(cc.Slider)],t.prototype,"sldZoom",void 0),__decorate([v(cc.Node)],t.prototype,"expandModeContainer",void 0),__decorate([v(cc.Label)],t.prototype,"lblExpandCost",void 0),__decorate([v(cc.Node)],t.prototype,"floorTemplate",void 0),__decorate([v(cc.Node)],t.prototype,"floorContainer",void 0),__decorate([v(cc.Node)],t.prototype,"hqTemplate",void 0),__decorate([v(cc.Node)],t.prototype,"collectorTemplate",void 0),__decorate([v(cc.Node)],t.prototype,"producerTemplate",void 0),__decorate([v(cc.Node)],t.prototype,"warehouseTemplate",void 0),__decorate([v(cc.Node)],t.prototype,"launchsiloTemplate",void 0),__decorate([v(cc.Node)],t.prototype,"buildingContainer",void 0),__decorate([v(cc.Node)],t.prototype,"blueprint",void 0),__decorate([v(cc.Sprite)],t.prototype,"blueprintIndicator",void 0),__decorate([v(cc.Node)],t.prototype,"grpBuild",void 0),__decorate([v(cc.Button)],t.prototype,"btnConfirmBuild",void 0),__decorate([v(cc.Node)],t.prototype,"grpBuildingInfo",void 0),__decorate([v(cc.Node)],t.prototype,"nodProduceButton",void 0),__decorate([v(cc.Toggle)],t.prototype,"togShowBuildingInfo",void 0),t=r=__decorate([m],t);var r}(r.default);a.default=y,cc._RF.pop()},{"./BaseUI":"BaseUI","./BlockchainMgr":"BlockchainMgr","./City/Building":"Building","./City/ExpandModeContainer":"ExpandModeContainer","./City/ProducerBuilding":"ProducerBuilding","./CvsMain":"CvsMain","./DataMgr":"DataMgr","./UI/BuildingInfoPanel":"BuildingInfoPanel","./UI/DialogPanel":"DialogPanel","./UI/ProductionPanel":"ProductionPanel","./UI/ToastPanel":"ToastPanel","./WorldUI":"WorldUI"}],CollectorBuilding:[function(t,e,a){"use strict";cc._RF.push(e,"2ffd4wRHIRBKbqpQioNYuQn","CollectorBuilding"),Object.defineProperty(a,"__esModule",{value:!0});var n=t("../DataMgr"),r=t("./Building"),o=t("../MainCtrl"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblOutput=null,t.nodeGear=null,t}return __extends(t,e),t.prototype.update=function(t){o.default.Ticks%200==0&&this.refresh(),this.nodeGear.rotation+=360*t},t.prototype.refresh=function(){var t=this.info,e=(n.DataMgr.myUser,Number(new Date),t.Out0),a=n.DataMgr.getBuildingInfoItemWithLv(this.info.id,"Out0Rate",this.data.lv),r=n.DataMgr.getCargoInfo(e).Name;this.lblOutput.string=" "+a.toPrecision(3)+r+"/h"},__decorate([l(cc.Label)],t.prototype,"lblOutput",void 0),__decorate([l(cc.Node)],t.prototype,"nodeGear",void 0),t=__decorate([s],t)}(r.default);a.default=c,cc._RF.pop()},{"../DataMgr":"DataMgr","../MainCtrl":"MainCtrl","./Building":"Building"}],Contract:[function(t,e,a){"use strict";cc._RF.push(e,"904f11Xrm5Ddo9obc2ZKxRs","Contract");var i=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else this.nickname="",this.address="",this.country="",this.healMaxTimestamp=0,this.expandCnt=0,this.expandMap={},this.buildingMap={"0,0":{id:"hq",lv:0}},this.cargoData={sand:1e3,silicon:1e3,ch4:1e6,tank:1e6},this.myNukeList=[],this.lastCalcTime=(new Date).valueOf()};i.prototype={toString:function(){return JSON.stringify(this)}};var o=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else this.index=0,this.x=0,this.y=0,this.occupant="",this.lastMineTime=0,this.army={},this.money=0,this.sponsor="",this.sponsorName="",this.sponsorLink="",this.sponsorPic="",this.miningRate=.02,this.mineBalance=0,this.lastCalcTime=0};o.prototype={toString:function(){return JSON.stringify(this)}};var m=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else this.index=0,this.respawnTimestamp=0,this.army=null,this.alive=!0};m.prototype={toString:function(){return JSON.stringify(this)}};var s=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else{var r={speed:0};r.lastLocationX=5e3*Math.cos(rad),r.lastLocationY=5e3*Math.sin(rad),r.destinationX=null,r.destinationY=null,r.lastLocationTime=(new Date).valueOf(),this.locationData=r,this.owner="",this.alive=!0,this.affectedCities=[]}};s.prototype={toString:function(){return JSON.stringify(this)}};var r={parse:function(t){return new BigNumber(t)},stringify:function(t){return t.toString()}},n=function(){LocalContractStorage.defineProperty(this,"adminAddress"),LocalContractStorage.defineProperty(this,"totalIslandCnt"),LocalContractStorage.defineProperty(this,"totalNas",r),LocalContractStorage.defineProperty(this,"cityMoveSpeed"),LocalContractStorage.defineProperty(this,"raidCityCargoRate"),LocalContractStorage.defineProperty(this,"safeZoneLine"),LocalContractStorage.defineProperty(this,"damagePerAttackCity"),LocalContractStorage.defineProperty(this,"energyCostPerLyExpand"),LocalContractStorage.defineProperty(this,"nukemissSpeed"),LocalContractStorage.defineProperty(this,"nukeRadius"),LocalContractStorage.defineProperty(this,"totalPirateCnt"),LocalContractStorage.defineProperty(this,"pirateCargoC0"),LocalContractStorage.defineProperty(this,"pirateArmyC0"),LocalContractStorage.defineProperty(this,"piratePeriodTimestamp"),LocalContractStorage.defineProperty(this,"allUserList",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),LocalContractStorage.defineMapProperty(this,"allUsers",{parse:function(t){return new i(t)},stringify:function(t){return t.toString()}}),LocalContractStorage.defineMapProperty(this,"allBuildingInfos",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),LocalContractStorage.defineProperty(this,"allBuildingIDList"),LocalContractStorage.defineMapProperty(this,"allCargoInfos",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),LocalContractStorage.defineProperty(this,"allCargoNameList"),LocalContractStorage.defineProperty(this,"allIslands",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),LocalContractStorage.defineMapProperty(this,"allPirates",{parse:function(t){return new m(t)},stringify:function(t){return t.toString()}}),LocalContractStorage.defineMapProperty(this,"allOrders",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),LocalContractStorage.defineMapProperty(this,"bancorInfos",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}})};n.prototype={init:function(){this.adminAddress=Blockchain.transaction.from,this.totalNas=new BigNumber(0),this.cityMoveSpeed=150,this.raidCityCargoRate=.1,this.safeZoneLine=1567,this.damagePerAttackCity=.1,this.energyCostPerLyExpand=.01,this.nukemissSpeed=3600,this.nukeRadius=120,this.totalPirateCnt=1e3,this.pirateCargoC0=100,this.pirateArmyC0=10,this.piratePeriodTimestamp=0,this.allUserList=[],this.allIslands=[],this.allBuildingIDList=[],this.allCargoNameList=[],this.bancorInfos.set("floatmodA",.01),this.bancorInfos.set("floatmodK",.001),this.bancorInfos.set("floatmodX",0),this.bancorInfos.set("floatmodFee",.001)},claimNewUser:function(t,e){if(100<t.length)throw new Error("Nickname is too long.");if(20<e.length)throw new Error("Country name is too long.");var a=Blockchain.transaction.from,r=Blockchain.transaction.value;if(null!==this.allUsers.get(a))throw new Error("Has claim new user before.");this.totalNas=this.totalNas.plus(r);var n=new i;n.nickname=t,n.country=e,n.address=a,n.locationData=this.getRandomSpawnLocation(),this.fillCargoData(n),this.allUsers.set(a,n);var o=this.allUserList;return o.push(a),this.allUserList=o,{success:!0,result_data:n}},editUser:function(t,e){if(100<t.length)throw new Error("Nickname is too long.");if(20<e.length)throw new Error("Country name is too long.");var a=Blockchain.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");return r.nickname=t,r.country=e,this.allUsers.set(a,r),{success:!0,result_data:r}},move:function(t,e){var a=Blockchain.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");if(null===t||null===e)throw new Error("Parameters INVALID.");this._recalcUser(r);var n=r.locationData;n.speed=this.cityMoveSpeed,n.destinationX=t,n.destinationY=e;var o=this.getSailEnergyCost(r);if(r.cargoData.ch4<o)throw new Error("User energy NOT enough.");return r.cargoData.ch4-=o,this.allUsers.set(a,r),{success:!0,result_data:r}},expand:function(t){var e=Blockchain.transaction.from,a=this.allUsers.get(e);if(null===a)throw new Error("User NOT FOUND.");this._recalcUser(a);for(var r=0,n=0,o=0;o<t.length;o++){var i=+t[o][0],s=+t[o][1];this._getCityIJExpanded(a,i,s)||(a.expandMap[i+","+s]={order:a.expandCnt+r},r+=1,n+=this.getExpandNeedFloatmod(i,s))}if(0==r)throw new Error("All ij are expanded:"+t);if(a.cargoData.floatmod-=n,a.cargoData.floatmod<0)throw new Error("floatmod NOT enough to expand."+n);return a.expandCnt+=r,this.allUsers.set(e,a),{success:!0,result_data:a,newExpandCnd:r}},build:function(t,e,a){var r=Blockchain.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");if(this._recalcUser(n),!this._getCityIJExpanded(n,t,e))throw new Error("Build Failed. ("+t+","+e+") has not yet expanded.");if(n.buildingMap[t+","+e])throw new Error("Build Failed. ("+t+","+e+") has a building.");var o=this.allBuildingInfos.get(a);if(!o)throw new Error("Build Failed. CANNOT find buildingID."+a);if("1"!==o.CanBuild)throw new Error("Build Failed. CANNOT build this buildingID."+a);for(var i=0;i<3;i++){var s="BuildMat"+i,l=o[s];if(l){var c=o[s+"Cnt"];if(!n.cargoData[l]||n.cargoData[l]<c)throw new Error("Build Failed. Cargo NOT ENOUGH."+l+"|"+n.cargoData[l]+"<"+c);n.cargoData[l]-=c}}var d=o.Money,h=Blockchain.transaction.value;if(d&&0<d&&h<1e18*d)throw new Error("Build Failed. Money NOT ENOUGH. "+d);this.totalNas=this.totalNas.plus(h);var u=(new Date).valueOf();return n.buildingMap[t+","+e]={id:a,lv:0,recoverTime:u+o.MaxCD/4,justBuildOrUpgrade:!0,money:h.valueOf()/1e18},this.allUsers.set(r,n),{success:!0,result_data:n,newBuilding:[t,e,a]}},upgradeBuilding:function(t,e){var a=Blockchain.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");this._recalcUser(r);var n=r.buildingMap[t+","+e];if(!n)throw new Error("Upgrade Failed. ("+t+","+e+") has no building.");var o=n.id,i=this.allBuildingInfos.get(o);if(!i)throw new Error("Build Failed. CANNOT find buildingID."+o);if("1"!==i.CanBuild)throw new Error("Upgrade Failed. CANNOT build or upgrade this buildingID."+o);var s=n.lv;if(s>=i.MaxLevel)throw new Error("Upgrade Failed. Building level is MAX.");for(var l=0;l<3;l++){var c="BuildMat"+l,d=i[c];if(d){var h=c+"Cnt",u=this.getBuildingInfoItemWithLv(o,h,s+1);if(!r.cargoData[d]||r.cargoData[d]<u)throw new Error("Upgrade Failed. Cargo NOT ENOUGH."+d+"|"+r.cargoData[d]+"<"+u);r.cargoData[d]-=u}}var p=(new Date).valueOf();n.lv+=1;var f=this.allBuildingInfos.get("_upgradeRate").MaxCD,g=i.MaxCD*Math.pow(f,s+1);return n.recoverTime=p+g,n.justBuildOrUpgrade=!0,this.allUsers.set(a,r),{success:!0,result_data:r,newBuilding:[t,e,o]}},moveBuilding:function(t,e,a,r){var n=Blockchain.transaction.from,o=this.allUsers.get(n);if(null===o)throw new Error("User NOT FOUND.");this._recalcUser(o);var i=t+","+e,s=a+","+r;if(!o.buildingMap[i])throw new Error("moveBuilding Failed. ("+i+") has no building.");if(o.buildingMap[s])throw new Error("moveBuilding Failed. ("+s+") has already had a building.");return o.buildingMap[s]=o.buildingMap[i],delete o.buildingMap[i],this.allUsers.set(n,o),{success:!0}},demolish:function(t,e){var a=Blockchain.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");this._recalcUser(r);var n=r.buildingMap[t+","+e];if(!n)throw new Error("Demolish Failed. ("+t+","+e+") has no building.");var o=n.id,i=this.allBuildingInfos.get(o);if("1"!==i.CanBuild)throw new Error("Build Failed. CANNOT build or demolish this buildingID."+o);for(var s=n.lv,l=0;l<3;l++){var c="BuildMat"+l,d=i[c];if(d){var h=c+"Cnt",u=this.getBuildingInfoItemWithLv(o,h,s+1);this._userAddCargo(r,d,.5*u)}}return 0<n.money&&this._transaction(a,new BigNumber(n.money).mul(new BigNumber(1e18))),r.buildingMap[t+","+e]=null,this.allUsers.set(a,r),{success:!0}},produce:function(t,e,a){if(a!=Math.floor(a))throw new Error("amount must be Integer."+a);var r=Blockchain.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(n);var o=n.buildingMap[t+","+e],i=o.id;if(!o)throw new Error("Building NOT FOUND."+t+","+e);var s=(new Date).valueOf();if(o.recoverTime>s)throw new Error("Production is still in Cooldown."+t+","+e+" recoverTime:"+o.recoverTime+" curTime:"+s);var l=o.lv,c=this.getBuildingInfoItemWithLv(i,"MaxQueue",l);if(c<a)throw new Error("Produce failed because amount > maxQueue."+c);var d=this.allBuildingInfos.get(i);if(!d)throw new Error("CANNOT find buildingInfo."+i);for(var h=0;h<4;h++){var u="In"+h,p=d[u];if(p){var f=u+"Amt",g=this.getBuildingInfoItemWithLv(i,f,l+1)*a;if(n.cargoData[p]-=g,n.cargoData[p]<0)throw new Error("Produce Failed. Cargo NOT ENOUGH."+p+"|"+n.cargoData[p]+"<"+g)}}var m=d.Out0;this._userAddCargo(n,m,a);var v=a*this.getBuildingInfoItemWithLv(i,"CDPerUnit",o.lv);return o.recoverTime=s+6e4*v,o.justBuildOrUpgrade=null,this.allUsers.set(r,n),{success:!0,result_data:n,newCargo:[m,a]}},attackPirate:function(t,e){var a=this.getPirateInfo(t),r=Blockchain.transaction.from,n=this.allUsers.get(r);(new Date).valueOf();if(null===a)throw new Error("Error pirate index."+t);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(n);var o=n.locationData,i=o.x-a.x,s=o.y-a.y,l=Math.sqrt(i*i+s+s);if(300<l)throw new Error("Too far from the pirate."+t+", distance:"+l);var c=this.allPirates.get(t);if(c||((c=new m).index=t,c.respawnTimestamp=0),c.respawnTimestamp<this.piratePeriodTimestamp&&(c.respawnTimestamp=this.piratePeriodTimestamp,c.army=a.army,c.alive=!0),c.alive){var d=this._battle(c.army.tank,c.army.chopper,c.army.ship,e.tank,e.chopper,c.army.ship);for(var h in e){if((n.cargoData[h]||0)<e[h])throw new Error("Army NOT ENOUGH."+h);n.cargoData[h]-=e[h]}var u={};if(u.tank=d.left[0],u.chopper=d.left[1],u.ship=d.left[2],d.win){c.alive=!1;var p=a.cargo;for(var f in p)this._userAddCargo(n,f,p[f]);for(var g in u)this._userAddCargo(n,g,u[g])}else c.army=u;return this.allUsers.set(r,n),this.allPirates.set(t,c),{success:d.win,result_data:c}}throw new Error("Pirate NOT Alive."+t)},attackUserCity:function(t,e){var a=this.allUsers.get(t),r=Blockchain.transaction.from,n=this.allUsers.get(r),o=(new Date).valueOf();if(null===a)throw new Error("CANNOT find enemy."+t);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(a),this._recalcUser(n);var i=n.locationData,s=a.locationData;if(i.y>=this.safeZoneLine)throw new Error("CANNOT attack other city when you are in Safe Zone."+i);if(s.y>=this.safeZoneLine)throw new Error("CANNOT attack the enemy in Safe Zone."+s);var l=i.x-s.x,c=i.y-s.y,d=Math.sqrt(l*l+c+c);if(100<d)throw new Error("Too far from the enemy."+a+", distance:"+d);for(var h in e)if(n.cargoData[h]-=e[h],n.cargoData[h]<0)throw new Error("Army NOT ENOUGH."+h);var u=this._battle(a.cargoData.tank,a.cargoData.chopper,a.cargoData.ship,e.tank,e.chopper,e.ship);if(a.cargoData.tank=0,a.cargoData.chopper=0,a.cargoData.ship=0,u.win){for(var p in n.cargoData.tank+=u.left[0],n.cargoData.chopper+=u.left[1],n.cargoData.ship+=u.left[2],a.cargoData){if(this.allCargoInfos.get(p).CanRaid){var f=this.getUserWarehouseCap(n.address,p),g=Math.min(a.cargoData[p]*this.raidCityCargoRate,f-(n.cargoData[p]||0));0<g&&(a.cargoData[p]-=g,this._userAddCargo(n,p,g))}}var m=Math.min(1,1-(a.healMaxTimestamp-o)/36e5*this.damagePerAttackCity);0<(m-=this.damagePerAttackCity)?a.healMaxTimestamp=o+(1-m)/this.damagePerAttackCity*36e5:this._cityDestroy(a)}else a.cargoData.tank+=u.left[0],a.cargoData.chopper+=u.left[1],a.cargoData.ship+=u.left[2];return this.allUsers.set(t,a),this.allUsers.set(r,n),{success:u.win}},attackIsland:function(t,e){var a=this.allIslands,r=a[t],n=Blockchain.transaction.from,o=this.allUsers.get(n),i=(new Date).valueOf();if(null===r)throw new Error("Error island index."+t);if(null===o)throw new Error("User NOT FOUND.");this._recalcUser(o);var s=o.locationData,l=s.x-r.x,c=s.y-r.y,d=Math.sqrt(l*l+c+c);if(100<d)throw new Error("Too far from the island."+t+", distance:"+d);if(""!==r.occupant){var h=new BigNumber(.05),u=new BigNumber(i-r.lastCalcTime).div(36e5),p=Math.exp(h.times(u).negated());for(var f in r.army)r.army[f]=Math.round(r.army[f]*p)}if(r.lastCalcTime=i,""===r.occupant||r.occupant===n){for(var g in""===r.occupant&&(r.lastMineTime=i),r.occupant=n,e){if((o.cargoData[g]||0)<e[g])throw new Error("Army NOT ENOUGH."+g);if(r.army[g]=(r.army[g]||0)+e[g],o.cargoData[g]-=e[g],o.cargoData[g]<0)throw new Error("NOT ENOUGH army."+g+", "+e[g])}return a[t]=r,this.allUsers.set(n,o),a[t]=r,this.allIslands=a,{success:!0,result_data:o,island:r}}var m=this._battle(r.army.tank,r.army.chopper,0,e.tank,e.chopper,0);for(var v in m.win&&(this._collectIslandMoneyInternal(r),(r=a[t]).occupant=n),r.army.tank=m.left[0],r.army.chopper=m.left[1],r.army.ship=m.left[2],e){if(o.cargoData[v]<e[v])throw new Error("Army NOT ENOUGH."+v);o.cargoData[v]-=e[v]}return this.allUsers.set(n,o),a[t]=r,this.allIslands=a,{success:m.win,result_data:r}},collectIslandMoney:function(t){var e=this.allIslands,a=e[t],r=Blockchain.transaction.from;if(null===a||a.occupant!==r)throw new Error("Error island."+a);var n=this._collectIslandMoneyInternal(a);return e[t]=a,this.allIslands=e,{success:!0,result_data:n}},_collectIslandMoneyInternal:function(t){var e=(new Date).valueOf(),a=new BigNumber(e-t.lastMineTime).div(36e5),r=t.money*Math.exp(-t.miningRate*a),n=1e9*Math.floor((t.money-r)/1e9);return t.money=r,t.lastMineTime=e,this.allIslands[t.id]=t,0<n&&this._transaction(t.occupant,n),n},getSailEnergyCost:function(t){var e=t.locationData;if(null===e.destinationX||null===e.destinationY)return 0;var a=e.destinationX-e.lastLocationX,r=e.destinationY-e.lastLocationY;return Math.sqrt(a*a+r*r)*Math.sqrt(t.expandCnt+81)*this.energyCostPerLyExpand},launchNuke:function(t,e){var a=Blockchain.transaction.from,r=this.allUsers.get(a),n=(new Date).valueOf();if(null===r)throw new Error("User NOT FOUND.");if(this._recalcUser(r),r.locationData.y>=this.safeZoneLine)throw new Error("CANNOT launch nuke when you are in Safe Zone."+r.locationData);if(r.cargoData.nukemiss<1)throw new Error("nukemiss NOT ENOUGH.",r.cargoData.nukemiss);r.cargoData.nukemiss-=1;var o=new s;o.owner=a;var i={};return i.speed=this.nukemissSpeed,i.lastLocationX=r.locationData.lastLocationX,i.lastLocationY=r.locationData.lastLocationY,i.destinationX=t,i.destinationY=e,i.lastLocationTime=n,o.locationData=o,r.myNukeList.push(o),this.allUsers.set(a,r),{success:!0,result_data:o,index:r.myNukeList.length-1}},triggerNuke:function(t,e){var a=Blockchain.transaction.from,r=this.allUsers.get(a),n=(new Date).valueOf();if(null===r)throw new Error("User NOT FOUND.");if(this._recalcLocationData(r.locationData),r.locationData.y>=this.safeZoneLine)throw new Error("CANNOT trigger nuke when you are in Safe Zone."+r.locationData);var o=r.myNukeList[t];if(!o.alive)throw new Error("Nuke is NOT alive."+t);var i=o.locationData,s=this._recalcLocationData(i);if(s.t<1)throw new Error("The nuke has NOT yet arrive at the destination.");if(s.eta>n+12e5)throw new Error("The nuke is EXPIRED.");o.alive=!1;for(var l=0;l<e.length;l++){var c=e[l],d=this.allUsers.get(c);if(null!==d){this._recalcUser(d);var h=d.locationData;if(!(h.y>=this.safeZoneLine)){var u=i.x-h.x,p=i.y-h.y;Math.sqrt(u*u+p+p)>this.nukeRadius||(this._cityDestroy(d),this.allUsers.set(c,d),o.affectedCities.push(c))}}}this.allUsers.set(a,r)},_recalcLocationData:function(t){var e=(new Date).valueOf();if(null===t.destinationX||null===t.destinationY)return 0;var a=t.destinationX-t.lastLocationX,r=t.destinationY-t.lastLocationY,n=Math.sqrt(a*a+r*r)/(t.speed/36e5),o=t.lastLocationTime+n,i=(e-t.lastLocationTime)/n;if(i<1){var s=this._lerpVec2({x:t.lastLocationX,y:t.lastLocationY},{x:t.destinationX,y:t.destinationY},i,!1);t.lastLocationX=s.x,t.lastLocationY=s.y}else t.lastLocationX=t.destinationX,t.lastLocationY=t.destinationY,t.destinationX=null,t.destinationY=null;return t.lastLocationTime=e,{t:i,eta:o}},_recalcUser:function(t){var e=(new Date).valueOf();this._recalcLocationData(t.locationData);var a={};for(var r in t.buildingMap){var n=t.buildingMap[r];if(n){var o=this.allBuildingInfos.get(n.id);if(o.Out0&&0<o.Out0Rate){var i=o.Out0;a[i]||(a[i]=0),a[i]+=this.getBuildingInfoItemWithLv(n.id,"Out0Rate",n.lv)}}}var s=(e-t.lastCalcTime)/6e4;for(var l in a)this._userAddCargo(t,l,a[l]*s);t.lastCalcTime=e,this.allUsers.set(t.address,t)},_userAddCargo:function(t,e,a){if(a<0)throw new Error("_userAddCargo() cargoAmount must >= 0"+a);var r=this.getUserWarehouseCap(t.address,e),n=t.cargoData;if(n[e]||(n[e]=0),n[e]<r){var o=Math.min(a,r-n[e]);return t.cargoData[e]=n[e]+o,o}return 0},_battle:function(t,e,a,r,n,o){var i,s,l,c=void 0,d=void 0,h=void 0,u=void 0,p=void 0,f=void 0;return 0==(h=!(0<=(i=(s=(20*Math.pow(t,1)+50*Math.pow(e,1)+100*Math.pow(a,1))*(100*t+40*e+20*a))-(l=1*(20*r+50*Math.pow(n,1)+100*Math.pow(o,1))*(100*r+40*n+20*o)))))?(d=i/s,c=1-.3*Math.random(),u=Math.floor(t*d*c),p=Math.min(e,Math.floor(e*d+t*d*(1-c)*100/2/40)),f=Math.min(a,Math.floor(a*d+t*d*(1-c)*100/2/20))):(d=-i/l,c=1-.3*Math.random(),u=Math.floor(r*d*c),p=Math.min(n,Math.floor(n*d+r*d*(1-c)*100/2/40)),f=Math.min(o,Math.floor(o*d+r*d*(1-c)*100/2/20))),console.log(t,e,a,"|",r,n,o,"获胜方",h,"剩余",u,p,f),{win:h,left:[u,p,f]}},_cityDestroy:function(t){t.healMaxTimestamp=0,t.cargoData={},this._userAddCargo(t,"sand",100),this.locationData=this.getRandomSpawnLocation()},_transaction:function(t,e){var a=Blockchain.transfer(t,e);console.log("transfer result:",a,e,e/1e18)},sponsor:function(t,e,a,r){var n=this.allIslands,o=n[t],i=Blockchain.transaction.value,s=Blockchain.transaction.from;if(null===o)throw new Error("Error island index."+t);if(console.log("sponsor1178|",1.2*o.money),this._collectIslandMoneyInternal(o),o.sponsor!==s&&i<1.2*o.money)throw new Error("value must > current money * 1.2. value:"+i+", island.money:"+o.money);return o.sponsor!==s?(this._transaction(o.sponsor,o.money),this.totalNas=this.totalNas.minus(o.money),o.sponsor=s,o.money=i):o.money=o.money+o.money,this.totalNas=this.totalNas.plus(i),o.sponsorName=e,o.sponsorLink=a,o.sponsorPic=r,n[t]=o,this.allIslands=n,{success:!0,island:o}},transfer:function(t,e,a){if(a<0)throw new Error("amount must >= 0.");var r=Blockchain.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(n);var o=this.allUsers.get(t);if(null===o)throw new Error("Receiver NOT FOUND.");if(this._recalcUser(o),n.cargoData[e]=(n.cargoData[e]||0)-a,this._userAddCargo(o,e,a),n.cargoData[e]<0)throw new Error("user's cargo NOT ENOUGH to transfer."+n.cargoData[e]);return this.allUsers.set(r,n),this.allUsers.set(t,o),{success:!0}},makeOrder:function(t,e,a,r){var n=Blockchain.transaction.from;if(null===this.allUsers.get(n))throw new Error("User NOT FOUND.");var o=this.allOrders.get(t);if(o)throw new Error("orderID is occupied. Change orderID!"+t);if(a<0&&Blockchain.transaction.value<-a)throw new Error("Paid coin not enough.");return o={maker:n,cargos:e,valueWei:a,valid:!0},r&&(o.assignedTaker=r),this.allOrders.set(t,o),{success:!0}},takeOrder:function(t){var e=Blockchain.transaction.from,a=this.allOrders.get(t);if(null===a)throw new Error("Order NOT FOUND");if(!a.valid)throw new Error("order is INVALID!");if(a.assignedTaker&&e!=a.assignedTaker)throw new Error("Only assignedTaker can take this order!"+a.assignedTaker);if(0<a.valueWei){if(Blockchain.transaction.value<a.valueWei)throw new Error("Paid coin not enough.");this._transaction(a.maker,a.valueWei)}var r=this.allUsers.get(a.maker),n=this.allUsers.get(e);for(var o in a.cargos){var i=a.cargos[o];if(i<0){if(r.cargoData[o]+=i,r.cargoData[o]<0)throw new Error("maker's cargo NOT ENOUGH!");this._userAddCargo(n,o,-i)}else if(0<i&&(this._userAddCargo(r,o,i),n.cargoData[o]-=i,n.cargoData[o]<0))throw new Error("taker's cargo NOT ENOUGH!")}return a.taker=e,a.valid=!1,this.allOrders.set(t,a),this.allUsers.set(e,n),this.allUsers.set(a.maker,r),{success:!0}},cancelOrder:function(t){var e=Blockchain.transaction.from,a=this.allOrders.get(t);if(null===a)throw new Error("Order NOT FOUND");if(!a.valid)throw new Error("order is INVALID!");if(e!=a.maker)throw new Error("Only order-maker can cancel order!"+a.maker);if(a.valueWei<0){var r=-a.valueWei;this._transaction(a.maker,r)}return a.valid=!1,this.allOrders.set(t,a),{success:!0}},bancorTrade:function(t,e){var a=Blockchain.transaction.value,r=Blockchain.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");var o=this.bancorInfos.get(t+"A"),i=this.bancorInfos.get(t+"K"),s=this.bancorInfos.get(t+"X");if(0<e){var l=o/i*(Math.exp(i*(s+e))-Math.exp(i*s));if(a<1e18*l)throw new Error("Value NOT ENOUGH to buy. need "+l+".You give "+a);var c=a-1e18*l;if(1e-4<c){var d=new BigNumber(1e8*Math.floor(c/1e8));this._transaction(r,d)}this._userAddCargo(n,t,e)}else if(e<0){if(n.cargoData[t]-=e,n.cargoData[t]<0)throw new Error("Your cargo NOT ENOUGH "+(n.cargoData[t]+e));var h=this.bancorInfos.get(t+"Fee"),u=o/i*(Math.exp(i*s)-Math.exp(i*(s+e))),p=new BigNumber(1e8*Math.floor(u*(1-h)*1e10));this._transaction(r,p)}if((s+=e)<0&&e<0)throw new Error("Bid demand NOT ENOUGH."+s);return this.bancorInfos.set(t+"X",s),this.allUsers.set(r,n),{success:!0}},setBancorInfo:function(t,e,a,r,n){if(Blockchain.transaction.from!=this.adminAddress)throw new Error("Permission denied.");return this.bancorInfos.set(t+"A",e),this.bancorInfos.set(t+"K",a),this.bancorInfos.set(t+"X",r),this.bancorInfos.set(t+"Fee",n),{success:!0}},getBancorInfo:function(t){return{cargoName:t,A:this.bancorInfos.get(t+"A"),K:this.bancorInfos.get(t+"K"),X:this.bancorInfos.get(t+"X"),Fee:this.bancorInfos.get(t+"Fee")}},getRandomSpawnLocation:function(){var t=(.25+.5*Math.random())*Math.PI,e={speed:0};return e.lastLocationX=5e3*Math.cos(t),e.lastLocationY=5e3*Math.sin(t),e.destinationX=null,e.destinationY=null,e.lastLocationTime=(new Date).valueOf(),e},_getCityIJExpanded:function(t,e,a){return Math.abs(e)<=4&&Math.abs(a)<=4?{}:t.expandMap[e+","+a]},getMapInfo:function(){for(var a=this.allUsers,t=this.allUserList.map(function(t){var e=a.get(t);return{nickname:e.nickname,address:e.address,country:e.country,healMaxTimestamp:e.healMaxTimestamp,expandCnt:e.expandCnt,locationData:e.locationData,myNukeList:e.myNukeList}}),e=[],r=0;r<this.allIslands.length;r++)e.push(this.allIslands[r]);return{success:!0,result_data:{users:t,islands:e}}},getUserList:function(){return this.allUserList},getUser:function(t){return this.allUsers.get(t)},getPirateInfo:function(t){if(t>=this.totalPirateCnt)throw new Error("index must < totalPirateCnt."+t+"<"+this.totalPirateCnt);var e=this.piratePeriodTimestamp,a=(new Date).valueOf();a/36e5>=Math.floor(e/36e5+1)&&(e=36e5*Math.floor(a/36e5),this.piratePeriodTimestamp=e);var r=e.toString()+t.toString(),n=this.APHash1(r),o=Math.floor(15*Math.pow(n,3))+1,i=o*o,s=o*o*o,l=this.APHash1(r+"theta"),c=this.APHash1(r+"rho"),d=l*Math.PI*2,h=5700*Math.sqrt(c),u=Math.cos(d)*h,p=Math.sin(d)*h,f={};f.x=u,f.y=p,f.lv=o;var g={},m={silicon:1,carbon:.7,iron:.5,chip:.05,deuter:1e-4};for(var v in m){var y=this.APHash1(r+v);g[v]=Math.round(this.pirateCargoC0*i*y*m[v])}g.floatmod=i,f.cargo=g;var C={},M={tank:1,chopper:.8,ship:.2};for(var _ in M){var D=this.APHash1(r+_);C[_]=Math.round(this.pirateArmyC0*s*D*M[_])}return f.army=C,f},getPirateData:function(t){if(t>=this.totalPirateCnt)throw new Error("index must < totalPirateCnt."+t+"<"+this.totalPirateCnt);return this.allPirates.get(t)},getExpandNeedFloatmod:function(t,e){var a=Math.max(Math.abs(t),Math.abs(e))-3;return a*a*a},getBuildingInfoItemWithLv:function(t,e,a){var r=this.allBuildingInfos.get(t)[e],n=this.allBuildingInfos.get("_upgradeRate")[e];return r?(!isNaN(n)&&0<n&&(r*=Math.pow(n,a)),r):0},getUserWarehouseCap:function(t,e){var a=this.allUsers.get(t);if(null===a)throw new Error("User NOT FOUND.");var r=0;for(var n in a.buildingMap){var o=a.buildingMap[n];if(o)this.allBuildingInfos.get(o.id).HouseOf===e&&(r+=this.getBuildingInfoItemWithLv(o.id,"Capacity",o.lv))}return r},getOrder:function(t){return this.allOrders.get(t)},getConst:function(t){return this[t]},getTimestamp:function(){return(new Date).valueOf()},_lerpVec2:function(t,e,a,r){r&&(a=Math.max(0,Math.min(1,a)));var n={};return n.x=t.x*(1-a)+e.x*a,n.y=t.y*(1-a)+e.y*a,n},APHash1:function(t){for(var e=2863311530,a=0;a<t.length;a++)e^=0==(1&a)?e<<7^t.charCodeAt(a)*(e>>3):~((e<<11)+t.charCodeAt(a)^e>>5);return e/2863311530/1.5+.5},takeRedundantNas:function(t,e){if(Blockchain.transaction.from!=this.adminAddress)throw new Error("Permission denied.");if(0==Blockchain.verifyAddress(t))throw new Error("Illegal Address.");return this.totalNas=this.totalNas.minus(e),this._transaction(t,new BigNumber(e)),{success:!0}},changeConst:function(t,e){if(Blockchain.transaction.from!==this.adminAddress)throw new Error("Permission denied.");return this[t]=e,{success:!0}},setBuildingInfo:function(t){var e=this;if(Blockchain.transaction.from!=this.adminAddress)throw new Error("Permission denied.");this.allBuildingIDList.forEach(function(t){e.allBuildingInfos.del(t)});for(var a=[],r=0;r<t.length;r++){var n=t[r];this.allBuildingInfos.set(n.id,n),a.push(n.id)}return this.allBuildingIDList=a,{success:!0,length:this.allBuildingIDList.length}},getBuildingInfo:function(t){return this.allBuildingInfos.get(t)},setCargoInfo:function(t){var e=this;if(Blockchain.transaction.from!=this.adminAddress)throw new Error("Permission denied.");this.allCargoNameList.forEach(function(t){e.allCargoInfos.del(t)});for(var a=[],r=0;r<t.length;r++){var n=t[r];this.allCargoInfos.set(n.id,n),a.push(n.id)}return this.allCargoNameList=a,{success:!0,length:this.allCargoNameList.length}},getCargoInfo:function(t){return this.allCargoInfos.get(t)},setIslandInfo:function(t){if(Blockchain.transaction.from!=this.adminAddress)throw new Error("Permission denied.");var e=this.allIslands;if(t.length<e.length)throw new Error("You can only set longer infoArray. >="+e.length);for(var a=0;a<t.length;a++){var r=t[a];if(a<e.length)e[a].x=r.x,e[a].y=r.y;else{var n=new o;n.index=a,n.x=r.x,n.y=r.y,e.push(n)}}return this.allIslands=e,{success:!0,length:t.length}},getIslandInfo:function(t){return this.allIslands[t]},fillCargoData:function(e,t){this.allCargoNameList.forEach(function(t){e.cargoData[t]||(e.cargoData[t]=0)}),t&&this.allUsers.set(e.address,e)}},e.exports=n,cc._RF.pop()},{}],CurrencyFormatter:[function(t,e,a){"use strict";cc._RF.push(e,"4455937OnBAOLdRb9e7YASo","CurrencyFormatter"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=(r.property,function(){function t(){}return t.formatBTC=function(t){if(Math.abs(t)<1e-7)return"0";var e=Math.max(0,Math.floor(Math.log(t)/Math.LN10));return t.toFixed(Math.max(0,5-e))},t.formatNAS=function(t){var e=Math.max(0,Math.floor(Math.log(t)/Math.LN10));return t.toFixed(Math.min(3,Math.max(0,4-e)))},t.formatCNY=function(t){if(Math.abs(t)<.005)return"0";var e=Math.max(0,Math.floor(Math.log(t)/Math.LN10));return t.toFixed(Math.min(2,Math.max(0,4-e)))},t=__decorate([n],t)}());a.default=o,cc._RF.pop()},{}],CvsMain:[function(t,e,a){"use strict";cc._RF.push(e,"69237yn4edJBK/5XvDAGlzX","CvsMain"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.fitter=null,t.uiContainer=null,t.panelContainer=null,t}return __extends(t,e),(r=t).prototype.onLoad=function(){(r.Instance=this).uiContainer.children.forEach(function(t){return t.active=!0})},t.EnterUI=function(e){r.Instance.uiContainer.children.forEach(function(t){t.getComponent(e)?t.active=!0:t.active=!1})},t.OpenPanel=function(t,a){try{if(t.Instance)return void(t.Instance.node.active=!0);cc.loader.loadRes("Prefabs/Panels/"+t,cc.Prefab,function(t,e){t?console.error("err45",t):(cc.instantiate(e).parent=r.Instance.panelContainer,a&&a())})}catch(t){console.error(t)}},t.ClosePanel=function(t){try{t.Instance&&(t.Instance.node.destroy(),t.Instance=null)}catch(t){console.error(t)}},t.prototype.update=function(){var t=cc.view.getVisibleSize();this.lastVisibleSize&&t.equals(this.lastVisibleSize)||(t.width>=t.height?(this.fitter.rotation=0,this.fitter.scale=1,this.fitter.setContentSize(1080/t.height*t.width,1080)):(this.fitter.rotation=90,this.fitter.setContentSize(1080/t.width*t.height,1080),this.fitter.scale=t.width/1080),this.lastVisibleSize=t)},__decorate([o(cc.Node)],t.prototype,"fitter",void 0),__decorate([o(cc.Node)],t.prototype,"uiContainer",void 0),__decorate([o(cc.Node)],t.prototype,"panelContainer",void 0),t=r=__decorate([n],t);var r}(cc.Component);a.default=i,cc._RF.pop()},{}],DataMgr:[function(t,e,a){"use strict";cc._RF.push(e,"c6c13KfXfRK06sYYQzi7BU0","DataMgr"),Object.defineProperty(a,"__esModule",{value:!0});var i=t("./Utils/MathUtil"),s=t("./BlockchainMgr"),r=function(){function o(){}return o.init=function(){this.inited||(this.inited=!0)},o.getBlockchainTimestamp=function(){return Number(new Date)+this.timestampOffset},o.getUserLevel=function(t){return Math.floor(Math.pow(t.expandCnt,.5))+1},o.getUserHull=function(t){return Math.min(1,1-(t.healMaxTimestamp-o.getBlockchainTimestamp())/36e5*this.damagePerAttackCity)},o.getUserCurrentLocation=function(t){var e=new cc.Vec2(t.locationData.lastLocationX,t.locationData.lastLocationY);if(null==t.locationData.destinationX||null==t.locationData.destinationY)return e;var a=new cc.Vec2(t.locationData.destinationX,t.locationData.destinationY),r=e.sub(a).mag()/(t.locationData.speed/60/1e3),n=(Number(new Date)-t.locationData.lastLocationTime)/r;return i.default.lerpVec2(e,a,n,!0)},o.getSailEnergyCost=function(t,e){return e*Math.sqrt(t.expandCnt+81)*this.energyCostPerLyExpand},o.getEnergyCostOfAttack=function(t,e,a,r){return 1*(e+a+r)},o.calcCurrentMoneyInIsland=function(t){var e=t.occupant&&0<t.occupant.length;return t.money*(e?Math.exp(-t.miningRate*(Number(new Date)-t.lastMineTime)/36e5):1)},o.getBuildingInfo=function(e){return o.BuildingConfig.find(function(t){return t.id==e})},o.getCargoInfo=function(e){return o.CargoConfig.find(function(t){return t.id==e})},o.getCityIJExpanded=function(t,e,a){return Math.abs(e)<=4&&Math.abs(a)<=4?{}:t.expandMap[e+","+a]},o.fetchUserDataFromBlockchain=function(a,r){var n=this;s.default.Instance.getFunction("getUser",[a],function(t){console.log("getUser resp:",t);try{var e=JSON.parse(t.result);e&&(n.allUsers[a]=e,r&&r(e))}catch(t){console.error(t)}})},o.getPirateInfo=function(t){if(t>=this.totalPirateCnt)throw new Error("index must < totalPirateCnt."+t+"<"+this.totalPirateCnt);var e=this.piratePeriodTimestamp,a=(new Date).valueOf();a/36e5>=Math.floor(e/36e5+1)&&(e=36e5*Math.floor(a/36e5),this.piratePeriodTimestamp=e);var r=e.toString()+t.toString(),n=this.APHash1(r),o=Math.floor(15*Math.pow(n,3))+1,i=o*o,s=o*o*o,l=this.APHash1(r+"theta"),c=this.APHash1(r+"rho"),d=l*Math.PI*2,h=5700*Math.sqrt(c),u=Math.cos(d)*h,p=Math.sin(d)*h,f={};f.x=u,f.y=p,f.lv=o;var g={},m={silicon:1,carbon:.7,iron:.5,chip:.05,deuter:1e-4};for(var v in m){var y=this.APHash1(r+v);g[v]=Math.round(this.pirateCargoC0*i*y*m[v])}g.floatmod=i,f.cargo=g;var C={},M={tank:1,chopper:.8,ship:.2};for(var v in M){y=this.APHash1(r+v);C[v]=Math.round(this.pirateArmyC0*s*y*M[v])}return f.army=C,f},o.getPirateData=function(t){var e=this.piratePeriodTimestamp,a=this.getBlockchainTimestamp();a/36e5>=Math.floor(e/36e5+1)&&(e=36e5*Math.floor(a/36e5),this.piratePeriodTimestamp=e);var r=this.allPirates[t];r||(r={respawnTimestamp:0}),r.index=t;var n=this.getPirateInfo(t);return r.__proto__=n,r.respawnTimestamp<this.piratePeriodTimestamp&&(delete r.army,r.alive=!0),r},o.fetchPirateDataFromBlockchain=function(a,r){var n=this;s.default.Instance.getFunction("getPirateInfo",[a],function(t){console.log("getPirateInfo resp:",t);try{var e=JSON.parse(t.result);e&&(n.allPirates[a]=e,r&&r(o.getPirateData(a)))}catch(t){console.error(t)}})},o.APHash1=function(t){for(var e=2863311530,a=0;a<t.length;a++)e^=0==(1&a)?e<<7^t.charCodeAt(a)*(e>>3):~((e<<11)+t.charCodeAt(a)^e>>5);return e/2863311530/1.5+.5},o.getExpandNeedFloatmod=function(t,e){var a=Math.max(Math.abs(t),Math.abs(e))-3;return a*a*a},o.getBuildingInfoItemWithLv=function(t,e,a){var r=o.getBuildingInfo(t)[e],n=o.getBuildingInfo("_upgradeRate")[e];return r?(r=Number(r),!isNaN(n)&&0<n&&(r*=Math.pow(n,a)),r):0},o.getUserWarehouseCap=function(t,e){var a=0;for(var r in t.buildingMap){var n=t.buildingMap[r];if(n){var o=this.getBuildingInfo(n.id);o&&o.HouseOf==e&&(a+=this.getBuildingInfoItemWithLv(n.id,"Capacity",n.lv))}}return a},o.getUserCurrentCargoData=function(t){var e={};for(var a in t.cargoData)e[a]=t.cargoData[a];var r={};for(var a in t.buildingMap){var n=t.buildingMap[a];if(n){var o=this.getBuildingInfo(n.id);if(o.Out0&&0<o.Out0Rate)r[s=o.Out0]||(r[s]=0),r[s]+=this.getBuildingInfoItemWithLv(n.id,"Out0Rate",n.lv)}}var i=(this.getBlockchainTimestamp()-t.lastCalcTime)/6e4;for(var s in r){var l=r[s]*i,c=this.getUserWarehouseCap(t,s);if(e[s]<c){var d=Math.min(l,c-e[s]);e[s]=e[s]+d}}return e},o.getUserCollectorRate=function(t,e){if(null===t)throw new Error("User NOT FOUND.");var a=0;for(var r in t.buildingMap){var n=t.buildingMap[r];if(n)if(this.getBuildingInfo(n.id).Out0===e)a+=this.getBuildingInfoItemWithLv(n.id,"Out0Rate",n.lv)}return a},o.coinUnit="GAS",o.allUsers={},o.allIslandData={},o.outputRates={},o.allPirates={},o.cityMoveSpeed=150,o.raidCityCargoRate=.1,o.safeZoneLine=1567,o.damagePerAttackCity=.1,o.energyCostPerLyExpand=.01,o.nukemissSpeed=3600,o.nukeRadius=120,o.totalPirateCnt=1e3,o.pirateCargoC0=100,o.pirateArmyC0=10,o.piratePeriodTimestamp=0,o.timestampOffset=0,o.inited=!1,o}();a.DataMgr=r;var n=function(){};a.StarInfo=n;var o=function(){};a.LocationData=o;var l=function(){this.expandCnt=0,this.state=0,this.hull=1,this.expandMap={},this.buildingMap={},this.cargoData={iron:0,energy:0},this.collectingStarIndex=null,this.lastCalcTime=(new Date).valueOf()};a.UserData=l;var c=function(){};a.BuildingInfo=c;var d=function(){};a.BuildingData=d;var h=function(){};a.CargoInfo=h;var u=function(){this.amount=0};a.CargoData=u;var p=function(){};a.TechInfo=p;var f=function(){};a.TechData=f;var g=function(){};a.MineInfo=g;var m=function(){this.money=0,this.sponsorName="",this.miningRate=.02,this.mineBalance=0};a.IslandData=m;var v=function(){function e(){this.i=0,this.j=0}return e.prototype.clone=function(){var t=new e;return t.i=this.i,t.j=this.j,t},Object.defineProperty(e,"ZERO",{get:function(){return new e},enumerable:!0,configurable:!0}),e}();a.IJ=v,cc._RF.pop()},{"./BlockchainMgr":"BlockchainMgr","./Utils/MathUtil":"MathUtil"}],DialogPanel:[function(t,e,a){"use strict";cc._RF.push(e,"c0958fmSyFAp6wyHbHS0e10","DialogPanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblTitle=null,t.lblContext=null,t.btn0=null,t.lblBtn0=null,t.btn1=null,t.lblBtn1=null,t}return __extends(t,e),(a=t).prototype.onLoad=function(){(a.Instance=this).hide()},t.PopupWithOKButton=function(t,e){a.PopupWith1Button(t,e,"确定",null)},t.PopupWith1Button=function(t,e,a,r){this.Instance.show(),this.Instance.lblTitle.string=t,this.Instance.lblContext.string=e,this.Instance.func0=r,this.Instance.lblBtn0.string=a,this.Instance.btn0.active=!0,this.Instance.btn0.position=new cc.Vec2(0,0),this.Instance.btn1.active=!1},t.PopupWith2Buttons=function(t,e,a,r,n,o){this.Instance.show(),this.Instance.lblTitle.string=t,this.Instance.lblContext.string=e,this.Instance.func0=r,this.Instance.lblBtn0.string=a,this.Instance.btn0.active=!0,this.Instance.btn0.position=new cc.Vec2(-150,0),this.Instance.func1=o,this.Instance.lblBtn1.string=n,this.Instance.btn1.active=!0,this.Instance.btn1.position=new cc.Vec2(150,0)},t.prototype.onBtn0Click=function(){this.func0&&this.func0(),this.hide()},t.prototype.onBtn1Click=function(){this.func1&&this.func1(),this.hide()},t.prototype.show=function(){this.node.active=!0},t.prototype.hide=function(){this.node.active=!1},__decorate([o(cc.Label)],t.prototype,"lblTitle",void 0),__decorate([o(cc.Label)],t.prototype,"lblContext",void 0),__decorate([o(cc.Node)],t.prototype,"btn0",void 0),__decorate([o(cc.Label)],t.prototype,"lblBtn0",void 0),__decorate([o(cc.Node)],t.prototype,"btn1",void 0),__decorate([o(cc.Label)],t.prototype,"lblBtn1",void 0),t=a=__decorate([n],t);var a}(cc.Component);a.default=i,cc._RF.pop()},{}],EditNicknamePanel:[function(t,e,a){"use strict";cc._RF.push(e,"abc4c7by+pEG49b6MBNEz6Y","EditNicknamePanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../DataMgr"),n=t("./ToastPanel"),o=t("../HomeUI"),i=t("./FlagMgr"),s=t("./DialogPanel"),l=t("../BlockchainMgr"),c=cc._decorator,d=c.ccclass,h=c.property,u=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.edtNickname=null,t.flagContainer=null,t.flagTemplate=null,t.selectFrame=null,t}return __extends(t,e),(a=t).prototype.onLoad=function(){(a.Instance=this).init()},t.prototype.init=function(){var r=this;this.flagTemplate.active=!0,i.FlagMgr.flagNames.forEach(function(t){var e=cc.instantiate(r.flagTemplate);e.name=t,e.parent=r.flagContainer;var a=e.getComponent(cc.Sprite);i.FlagMgr.setFlag(a,t),e.on(cc.Node.EventType.TOUCH_END,function(){return r.onFlagClick(e)})}),this.flagTemplate.active=!1},t.prototype.onEnable=function(){var e=this;this.edtNickname.string=r.DataMgr.myUser?r.DataMgr.myUser.nickname:o.default.Instance.lblNickname.string,this.selectedCountry=o.default.Instance.country?o.default.Instance.country:r.DataMgr.myUser?r.DataMgr.myUser.country:null;var t=this.flagContainer.children.find(function(t){return t.name==e.selectedCountry});t?(this.selectFrame.active=!0,this.selectFrame.position=this.selectFrame.parent.convertToNodeSpaceAR(this.flagContainer.convertToWorldSpaceAR(t.position))):this.selectFrame.active=!1},t.prototype.onFlagClick=function(t){this.selectFrame.active=!0,this.selectFrame.position=this.selectFrame.parent.convertToNodeSpaceAR(this.flagContainer.convertToWorldSpaceAR(t.position)),this.selectedCountry=t.name},t.prototype.onConfirmClick=function(){r.DataMgr.myUser&&(r.DataMgr.myUser.nickname=this.edtNickname.string,r.DataMgr.myUser.country=this.selectedCountry),o.default.Instance.lblNickname.string=this.edtNickname.string,o.default.Instance.country=this.selectedCountry,n.default.Toast("昵称、国家设置成功"),r.DataMgr.myUser?l.default.Instance.callFunction("editUser",[o.default.Instance.lblNickname.string,o.default.Instance.country],0,function(t){"Error"!=t.toString().substr(0,5)?s.default.PopupWith2Buttons("正在修改昵称","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):n.default.Toast("交易失败:"+t)}):o.default.Instance.node.active&&o.default.Instance.onClaim(),this.close()},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([h(cc.EditBox)],t.prototype,"edtNickname",void 0),__decorate([h(cc.Node)],t.prototype,"flagContainer",void 0),__decorate([h(cc.Node)],t.prototype,"flagTemplate",void 0),__decorate([h(cc.Node)],t.prototype,"selectFrame",void 0),t=a=__decorate([d],t);var a}(cc.Component);a.default=u,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","../DataMgr":"DataMgr","../HomeUI":"HomeUI","./DialogPanel":"DialogPanel","./FlagMgr":"FlagMgr","./ToastPanel":"ToastPanel"}],ExpandBlueprintCell:[function(t,e,a){"use strict";cc._RF.push(e,"d2a19m02IZHwZRo4uLkIBYu","ExpandBlueprintCell"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../DataMgr"),n=cc._decorator,o=n.ccclass,i=n.property,s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.spr=null,t.lblInfo=null,t}return __extends(t,e),t.prototype.refresh=function(t){this.spr.node.active=!!t,this.lblInfo.string=r.DataMgr.getExpandNeedFloatmod(this.i,this.j)+" 浮力模块"},__decorate([i(cc.Sprite)],t.prototype,"spr",void 0),__decorate([i(cc.Label)],t.prototype,"lblInfo",void 0),t=__decorate([o],t)}(cc.Component);a.default=s,cc._RF.pop()},{"../DataMgr":"DataMgr"}],ExpandModeContainer:[function(t,e,a){"use strict";cc._RF.push(e,"162a2SGw2ZAwbUECSlMqk0J","ExpandModeContainer"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../CityUI"),c=t("../DataMgr"),o=t("./ExpandBlueprintCell"),n=cc._decorator,i=n.ccclass,s=n.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.cityUI=null,t.expandBlueprintCellTemplate=null,t.sprGrid=null,t.expandBlueprintCellMap={},t.clrLabelNotEnough=cc.Color.RED,t.willExpandMap={},t}return __extends(t,e),t.prototype.onLoad=function(){this.cityUI=r.default.Instance,this.node.on(cc.Node.EventType.TOUCH_MOVE,this.cityUI.onPanPadTouchMove,this.cityUI),this.node.on(cc.Node.EventType.MOUSE_WHEEL,this.cityUI.onMouseWheel,this.cityUI),this.node.on(cc.Node.EventType.MOUSE_MOVE,this.cityUI.onMouseWheel,this.cityUI),this.node.on(cc.Node.EventType.TOUCH_END,this.onTouchUp,this),this.expandBlueprintCellTemplate.active=!1,this.clrLabelEnough=this.cityUI.lblExpandCost.node.color},t.prototype.onEnable=function(){this.willExpandMap={};var t=4,e=c.DataMgr.myUser.expandMap;for(var a in e){var r=JSON.parse("["+a+"]"),n=Math.max(Math.abs(r[0]),Math.abs(r[1]));t<n&&(t=n)}for(var o=-t-3;o<=t+3;o++)for(var i=-t-3;i<=t+3;i++){a=o+","+i;var s=this.checkAndCreateCell(o,i,a);s&&s.refresh(!1)}var l=100*(2*(t+3)+1);this.sprGrid.setContentSize(l+1,l+1),this.node.setContentSize(l+500,l+500),this.refreshCost()},t.prototype.onTouchUp=function(t){var e=t.getLocation();if(new cc.Vec2(e.x,e.y).sub(t.getStartLocation()).mag()<20){var a=this.node.convertTouchToNodeSpaceAR(t.touch),r=Math.floor((a.x+50)/100),n=Math.floor((a.y+50)/100),o=r+","+n,i=this.checkAndCreateCell(r,n,o);if(i)if(this.willExpandMap[o])delete this.willExpandMap[o],i.refresh(!1);else c.DataMgr.getCityIJExpanded(c.DataMgr.myUser,r,n)||(this.willExpandMap[o]=!0,i.refresh(!0));this.refreshCost()}},t.prototype.refreshCost=function(){var t=this.getCost();this.cityUI.lblExpandCost.string="消耗 "+t.toFixed()+" 浮力模块";var e=c.DataMgr.getUserCurrentCargoData(c.DataMgr.myUser).floatmod||0;this.cityUI.lblExpandCost.node.color=e<t?this.clrLabelNotEnough:this.clrLabelEnough},t.prototype.checkAndCreateCell=function(t,e,a){if(c.DataMgr.getCityIJExpanded(c.DataMgr.myUser,t,e))return null;a||(a=t+","+e);var r=this.expandBlueprintCellMap[a];if(!r){var n=cc.instantiate(this.expandBlueprintCellTemplate);n.parent=this.node,n.position=new cc.Vec2(100*t,100*e),(r=n.getComponent(o.default)).i=t,r.j=e,this.expandBlueprintCellMap[a]=r,n.active=!0}return r},t.prototype.getCost=function(){var t=0;for(var e in this.willExpandMap){var a=JSON.parse("["+e+"]");t+=c.DataMgr.getExpandNeedFloatmod(a[0],a[1])}return t},t.prototype.getIJList=function(){var t=[];for(var e in this.willExpandMap){var a=JSON.parse("["+e+"]");t.push(a)}return t},__decorate([s(cc.Node)],t.prototype,"expandBlueprintCellTemplate",void 0),__decorate([s(cc.Node)],t.prototype,"sprGrid",void 0),t=__decorate([i],t)}(cc.Component);a.ExpandModeContainer=l,cc._RF.pop()},{"../CityUI":"CityUI","../DataMgr":"DataMgr","./ExpandBlueprintCell":"ExpandBlueprintCell"}],FakeBC:[function(t,e,a){"use strict";cc._RF.push(e,"7a51exBj71IfqF7nN/FO/aj","FakeBC"),Object.defineProperty(a,"__esModule",{value:!0});var r=function(){function t(){}return Object.defineProperty(t,"instance",{get:function(){return t._instance||(t._instance=new t).init(),t._instance},enumerable:!0,configurable:!0}),t.prototype.callFunction=function(t,e,a,r){try{var n=JSON.parse(a);this.Blockchain.transaction={},this.Blockchain.transaction.value=r,this.Blockchain.transaction.from=t;var o=(s=this.gameContract)[e].apply(s,n),i={};return i.result=o?JSON.stringify(o):null,i}catch(t){console.error(t)}var s},t.prototype.init=function(){console.log("init BC"),this.Blockchain={transfer:function(){}};var y=this.Blockchain,t=function(t,e,a){t[e]=a},e=function(a,r,t){a[r]=t,a[r].get=function(t){return a[r][t]||null},a[r].set=function(t,e){a[r][t]=e}},i=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else this.nickname="",this.address="",this.country="",this.healMaxTimestamp=0,this.expandCnt=0,this.expandMap={},this.buildingMap={"0,0":{id:"hq",lv:0}},this.cargoData={sand:40,silicon:0,ch4:0,tank:0},this.myNukeList=[],this.lastCalcTime=(new Date).valueOf()};i.prototype={toString:function(){return JSON.stringify(this)}};var o=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else this.index=0,this.x=0,this.y=0,this.occupant="",this.lastMineTime=0,this.army={},this.money=0,this.sponsor="",this.sponsorName="",this.sponsorLink="",this.sponsorPic="",this.miningRate=.02,this.mineBalance=0,this.lastCalcTime=0};o.prototype={toString:function(){return JSON.stringify(this)}};var g=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else this.index=0,this.respawnTimestamp=0,this.army=null,this.alive=!0};g.prototype={toString:function(){return JSON.stringify(this)}};var s=function(t){if(t){var e=JSON.parse(t);for(var a in e)this[a]=e[a]}else{var r={speed:0};r.lastLocationX=5e3*Math.cos(rad),r.lastLocationY=5e3*Math.sin(rad),r.destinationX=null,r.destinationY=null,r.lastLocationTime=(new Date).valueOf(),this.locationData=r,this.owner="",this.alive=!0,this.affectedCities=[]}};s.prototype={toString:function(){return JSON.stringify(this)}};var a=function(){t(this,"adminAddress"),t(this,"totalIslandCnt"),t(this,"totalNas"),t(this,"cityMoveSpeed"),t(this,"raidCityCargoRate"),t(this,"safeZoneLine"),t(this,"damagePerAttackCity"),t(this,"energyCostPerLyExpand"),t(this,"nukemissSpeed"),t(this,"nukeRadius"),t(this,"totalPirateCnt"),t(this,"pirateCargoC0"),t(this,"pirateArmyC0"),t(this,"piratePeriodTimestamp"),t(this,"allUserList",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),e(this,"allUsers",{parse:function(t){return new i(t)},stringify:function(t){return t.toString()}}),e(this,"allBuildingInfos",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),t(this,"allBuildingIDList"),e(this,"allCargoInfos",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),t(this,"allCargoNameList"),t(this,"allIslands",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),e(this,"allPirates",{parse:function(t){return new g(t)},stringify:function(t){return t.toString()}}),e(this,"allOrders",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}}),e(this,"bancorInfos",{parse:function(t){return JSON.parse(t)},stringify:function(t){return JSON.stringify(t)}})};a.prototype={init:function(){this.adminAddress="APL5FCFSZrnG8L3cinkDRmXFDb27quJUWE",this.totalNas=0,this.cityMoveSpeed=150,this.raidCityCargoRate=.1,this.safeZoneLine=1567,this.damagePerAttackCity=.1,this.energyCostPerLyExpand=.01,this.nukemissSpeed=3600,this.nukeRadius=120,this.totalPirateCnt=1e3,this.pirateCargoC0=100,this.pirateArmyC0=10,this.piratePeriodTimestamp=0,this.allUserList=[],this.allIslands=[],this.allBuildingIDList=[],this.allCargoNameList=[],this.bancorInfos.set("floatmodA",.01),this.bancorInfos.set("floatmodK",.001),this.bancorInfos.set("floatmodX",0),this.bancorInfos.set("floatmodFee",.001)},claimNewUser:function(t,e){if(100<t.length)throw new Error("Nickname is too long.");if(20<e.length)throw new Error("Country name is too long.");var a=y.transaction.from,r=y.transaction.value;if(null!==this.allUsers.get(a))throw new Error("Has claim new user before.");this.totalNas=this.totalNas+r;var n=new i;n.nickname=t,n.country=e,n.address=a,n.locationData=this.getRandomSpawnLocation(),this.fillCargoData(n),this.allUsers.set(a,n);var o=this.allUserList;return o.push(a),this.allUserList=o,{success:!0,result_data:n}},editUser:function(t,e){if(100<t.length)throw new Error("Nickname is too long.");if(20<e.length)throw new Error("Country name is too long.");var a=y.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");return r.nickname=t,r.country=e,this.allUsers.set(a,r),{success:!0,result_data:r}},move:function(t,e){var a=y.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");if(null===t||null===e)throw new Error("Parameters INVALID.");this._recalcUser(r);var n=r.locationData;n.speed=this.cityMoveSpeed,n.destinationX=t,n.destinationY=e;var o=this.getSailEnergyCost(r);if(r.cargoData.ch4<o)throw new Error("User energy NOT enough.");return r.cargoData.ch4-=o,this.allUsers.set(a,r),{success:!0,result_data:r}},expand:function(t){var e=y.transaction.from,a=this.allUsers.get(e);if(null===a)throw new Error("User NOT FOUND.");this._recalcUser(a);for(var r=0,n=0,o=0;o<t.length;o++){var i=+t[o][0],s=+t[o][1];this._getCityIJExpanded(a,i,s)||(a.expandMap[i+","+s]={order:a.expandCnt+r},r+=1,n+=this.getExpandNeedFloatmod(i,s))}if(0==r)throw new Error("All ij are expanded:"+t);if(a.cargoData.floatmod-=n,a.cargoData.floatmod<0)throw new Error("floatmod NOT enough to expand."+n);return a.expandCnt+=r,this.allUsers.set(e,a),{success:!0,result_data:a,newExpandCnd:r}},build:function(t,e,a){var r=y.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");if(this._recalcUser(n),!this._getCityIJExpanded(n,t,e))throw new Error("Build Failed. ("+t+","+e+") has not yet expanded.");if(n.buildingMap[t+","+e])throw new Error("Build Failed. ("+t+","+e+") has a building.");var o=this.allBuildingInfos.get(a);if(!o)throw new Error("Build Failed. CANNOT find buildingID."+a);if("1"!==o.CanBuild)throw new Error("Build Failed. CANNOT build this buildingID."+a);for(var i=0;i<3;i++){var s="BuildMat"+i,l=o[s];if(l){var c=o[s+"Cnt"];if(!n.cargoData[l]||n.cargoData[l]<c)throw new Error("Build Failed. Cargo NOT ENOUGH."+l+"|"+n.cargoData[l]+"<"+c);n.cargoData[l]-=c}}var d=o.Money,h=y.transaction.value;if(d&&0<d&&h<1e18*d)throw new Error("Build Failed. Money NOT ENOUGH. "+d);this.totalNas=this.totalNas+h;var u=(new Date).valueOf();return n.buildingMap[t+","+e]={id:a,lv:0,recoverTime:u+o.MaxCD/4,justBuildOrUpgrade:!0,money:h.valueOf()/1e18},this.allUsers.set(r,n),{success:!0,result_data:n,newBuilding:[t,e,a]}},upgradeBuilding:function(t,e){var a=y.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");this._recalcUser(r);var n=r.buildingMap[t+","+e];if(!n)throw new Error("Upgrade Failed. ("+t+","+e+") has no building.");var o=n.id,i=this.allBuildingInfos.get(o);if(!i)throw new Error("Build Failed. CANNOT find buildingID."+o);if("1"!==i.CanBuild)throw new Error("Upgrade Failed. CANNOT build or upgrade this buildingID."+o);var s=n.lv;if(s>=i.MaxLevel)throw new Error("Upgrade Failed. Building level is MAX.");for(var l=0;l<3;l++){var c="BuildMat"+l,d=i[c];if(d){var h=c+"Cnt",u=this.getBuildingInfoItemWithLv(o,h,s+1);if(!r.cargoData[d]||r.cargoData[d]<u)throw new Error("Upgrade Failed. Cargo NOT ENOUGH."+d+"|"+r.cargoData[d]+"<"+u);r.cargoData[d]-=u}}var p=(new Date).valueOf();n.lv+=1;var f=this.allBuildingInfos.get("_upgradeRate").MaxCD,g=i.MaxCD*Math.pow(f,s+1);return n.recoverTime=p+g,n.justBuildOrUpgrade=!0,this.allUsers.set(a,r),{success:!0,result_data:r,newBuilding:[t,e,o]}},moveBuilding:function(t,e,a,r){var n=y.transaction.from,o=this.allUsers.get(n);if(null===o)throw new Error("User NOT FOUND.");this._recalcUser(o);var i=t+","+e,s=a+","+r;if(!o.buildingMap[i])throw new Error("moveBuilding Failed. ("+i+") has no building.");if(o.buildingMap[s])throw new Error("moveBuilding Failed. ("+s+") has already had a building.");return o.buildingMap[s]=o.buildingMap[i],delete o.buildingMap[i],this.allUsers.set(n,o),{success:!0}},demolish:function(t,e){var a=y.transaction.from,r=this.allUsers.get(a);if(null===r)throw new Error("User NOT FOUND.");this._recalcUser(r);var n=r.buildingMap[t+","+e];if(!n)throw new Error("Demolish Failed. ("+t+","+e+") has no building.");var o=n.id,i=this.allBuildingInfos.get(o);if("1"!==i.CanBuild)throw new Error("Build Failed. CANNOT build or demolish this buildingID."+o);for(var s=n.lv,l=0;l<3;l++){var c="BuildMat"+l,d=i[c];if(d){var h=c+"Cnt",u=this.getBuildingInfoItemWithLv(o,h,s+1);this._userAddCargo(r,d,.5*u)}}return 0<n.money&&this._transaction(a,1e18*n.money),r.buildingMap[t+","+e]=null,this.allUsers.set(a,r),{success:!0}},produce:function(t,e,a){if(a!=Math.floor(a))throw new Error("amount must be Integer."+a);var r=y.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(n);var o=n.buildingMap[t+","+e],i=o.id;if(!o)throw new Error("Building NOT FOUND."+t+","+e);var s=(new Date).valueOf();if(o.recoverTime>s)throw new Error("Production is still in Cooldown."+t+","+e+" recoverTime:"+o.recoverTime+" curTime:"+s);var l=o.lv,c=this.getBuildingInfoItemWithLv(i,"MaxQueue",l);if(c<a)throw new Error("Produce failed because amount > maxQueue."+c);var d=this.allBuildingInfos.get(i);if(!d)throw new Error("CANNOT find buildingInfo."+i);for(var h=0;h<4;h++){var u="In"+h,p=d[u];if(p){var f=u+"Amt",g=this.getBuildingInfoItemWithLv(i,f,l+1)*a;if(n.cargoData[p]-=g,n.cargoData[p]<0)throw new Error("Produce Failed. Cargo NOT ENOUGH."+p+"|"+n.cargoData[p]+"<"+g)}}var m=d.Out0;this._userAddCargo(n,m,a);var v=a*this.getBuildingInfoItemWithLv(i,"CDPerUnit",o.lv);return o.recoverTime=s+6e4*v,o.justBuildOrUpgrade=null,this.allUsers.set(r,n),{success:!0,result_data:n,newCargo:[m,a]}},attackPirate:function(t,e){var a=this.getPirateInfo(t),r=y.transaction.from,n=this.allUsers.get(r);(new Date).valueOf();if(null===a)throw new Error("Error pirate index."+t);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(n);var o=n.locationData,i=o.x-a.x,s=o.y-a.y,l=Math.sqrt(i*i+s+s);if(300<l)throw new Error("Too far from the pirate."+t+", distance:"+l);var c=this.allPirates.get(t);if(c||((c=new g).index=t,c.respawnTimestamp=0),c.respawnTimestamp<this.piratePeriodTimestamp&&(c.respawnTimestamp=this.piratePeriodTimestamp,c.army=a.army,c.alive=!0),c.alive){var d=this._battle(c.army.tank,c.army.chopper,c.army.ship,e.tank,e.chopper,c.army.ship);for(var h in e){if((n.cargoData[h]||0)<e[h])throw new Error("Army NOT ENOUGH."+h);n.cargoData[h]-=e[h]}var u={};if(u.tank=d.left[0],u.chopper=d.left[1],u.ship=d.left[2],d.win){c.alive=!1;var p=a.cargo;for(var f in p)this._userAddCargo(n,f,p[f]);for(var h in u)this._userAddCargo(n,h,u[h])}else c.army=u;return this.allUsers.set(r,n),this.allPirates.set(t,c),{success:d.win,result_data:c}}throw new Error("Pirate NOT Alive."+t)},attackUserCity:function(t,e){var a=this.allUsers.get(t),r=y.transaction.from,n=this.allUsers.get(r),o=(new Date).valueOf();if(null===a)throw new Error("CANNOT find enemy."+t);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(a),this._recalcUser(n);var i=n.locationData,s=a.locationData;if(i.y>=this.safeZoneLine)throw new Error("CANNOT attack other city when you are in Safe Zone."+i);if(s.y>=this.safeZoneLine)throw new Error("CANNOT attack the enemy in Safe Zone."+s);var l=i.x-s.x,c=i.y-s.y,d=Math.sqrt(l*l+c+c);if(100<d)throw new Error("Too far from the enemy."+a+", distance:"+d);for(var h in e)if(n.cargoData[h]-=e[h],n.cargoData[h]<0)throw new Error("Army NOT ENOUGH."+h);var u=this._battle(a.cargoData.tank,a.cargoData.chopper,a.cargoData.ship,e.tank,e.chopper,e.ship);if(a.cargoData.tank=0,a.cargoData.chopper=0,a.cargoData.ship=0,u.win){for(var p in n.cargoData.tank+=u.left[0],n.cargoData.chopper+=u.left[1],n.cargoData.ship+=u.left[2],a.cargoData){if(this.allCargoInfos.get(p).CanRaid){var f=this.getUserWarehouseCap(n.address,p),g=Math.min(a.cargoData[p]*this.raidCityCargoRate,f-(n.cargoData[p]||0));0<g&&(a.cargoData[p]-=g,this._userAddCargo(n,p,g))}}var m=Math.min(1,1-(a.healMaxTimestamp-o)/36e5*this.damagePerAttackCity);0<(m-=this.damagePerAttackCity)?a.healMaxTimestamp=o+(1-m)/this.damagePerAttackCity*36e5:this._cityDestroy(a)}else a.cargoData.tank+=u.left[0],a.cargoData.chopper+=u.left[1],a.cargoData.ship+=u.left[2];return this.allUsers.set(t,a),this.allUsers.set(r,n),{success:u.win}},attackIsland:function(t,e){var a=this.allIslands,r=a[t],n=y.transaction.from,o=this.allUsers.get(n),i=(new Date).valueOf();if(null===r)throw new Error("Error island index."+t);if(null===o)throw new Error("User NOT FOUND.");this._recalcUser(o);var s=o.locationData,l=s.x-r.x,c=s.y-r.y,d=Math.sqrt(l*l+c+c);if(100<d)throw new Error("Too far from the island."+t+", distance:"+d);if(""!==r.occupant){var h=(i-r.lastCalcTime)/36e5,u=Math.exp(.05*h*-1);for(var p in r.army)r.army[p]=Math.round(r.army[p]*u)}if(r.lastCalcTime=i,""===r.occupant||r.occupant===n){for(var p in""===r.occupant&&(r.lastMineTime=i),r.occupant=n,e){if((o.cargoData[p]||0)<e[p])throw new Error("Army NOT ENOUGH."+p);if(r.army[p]=(r.army[p]||0)+e[p],o.cargoData[p]-=e[p],o.cargoData[p]<0)throw new Error("NOT ENOUGH army."+p+", "+e[p])}return a[t]=r,this.allUsers.set(n,o),a[t]=r,this.allIslands=a,{success:!0,result_data:o,island:r}}var f=this._battle(r.army.tank,r.army.chopper,0,e.tank,e.chopper,0);for(var p in f.win&&(this._collectIslandMoneyInternal(r),(r=a[t]).occupant=n),r.army.tank=f.left[0],r.army.chopper=f.left[1],r.army.ship=f.left[2],e){if(o.cargoData[p]<e[p])throw new Error("Army NOT ENOUGH."+p);o.cargoData[p]-=e[p]}return this.allUsers.set(n,o),a[t]=r,this.allIslands=a,{success:f.win,result_data:r}},collectIslandMoney:function(t){var e=this.allIslands,a=e[t],r=y.transaction.from;if(null===a||a.occupant!==r)throw new Error("Error island."+a);var n=this._collectIslandMoneyInternal(a);return e[t]=a,this.allIslands=e,{success:!0,result_data:n}},_collectIslandMoneyInternal:function(t){var e=(new Date).valueOf(),a=(e-t.lastMineTime)/36e5,r=t.money*Math.exp(-t.miningRate*a),n=1e9*Math.floor((t.money-r)/1e9);return t.money=r,t.lastMineTime=e,this.allIslands[t.id]=t,0<n&&this._transaction(t.occupant,n),n},getSailEnergyCost:function(t){var e=t.locationData;if(null===e.destinationX||null===e.destinationY)return 0;var a=e.destinationX-e.lastLocationX,r=e.destinationY-e.lastLocationY;return Math.sqrt(a*a+r*r)*Math.sqrt(t.expandCnt+81)*this.energyCostPerLyExpand},launchNuke:function(t,e){var a=y.transaction.from,r=this.allUsers.get(a),n=(new Date).valueOf();if(null===r)throw new Error("User NOT FOUND.");if(this._recalcUser(r),r.locationData.y>=this.safeZoneLine)throw new Error("CANNOT launch nuke when you are in Safe Zone."+r.locationData);if(r.cargoData.nukemiss<1)throw new Error("nukemiss NOT ENOUGH.",r.cargoData.nukemiss);r.cargoData.nukemiss-=1;var o=new s;o.owner=a;var i={};return i.speed=this.nukemissSpeed,i.lastLocationX=r.locationData.lastLocationX,i.lastLocationY=r.locationData.lastLocationY,i.destinationX=t,i.destinationY=e,i.lastLocationTime=n,o.locationData=o,r.myNukeList.push(o),this.allUsers.set(a,r),{success:!0,result_data:o,index:r.myNukeList.length-1}},triggerNuke:function(t,e){var a=y.transaction.from,r=this.allUsers.get(a),n=(new Date).valueOf();if(null===r)throw new Error("User NOT FOUND.");if(this._recalcLocationData(r.locationData),r.locationData.y>=this.safeZoneLine)throw new Error("CANNOT trigger nuke when you are in Safe Zone."+r.locationData);var o=r.myNukeList[t];if(!o.alive)throw new Error("Nuke is NOT alive."+t);var i=o.locationData,s=this._recalcLocationData(i);if(s.t<1)throw new Error("The nuke has NOT yet arrive at the destination.");if(s.eta>n+12e5)throw new Error("The nuke is EXPIRED.");o.alive=!1;for(var l=0;l<e.length;l++){var c=e[l],d=this.allUsers.get(c);if(null!==d){this._recalcUser(d);var h=d.locationData;if(!(h.y>=this.safeZoneLine)){var u=i.x-h.x,p=i.y-h.y;Math.sqrt(u*u+p+p)>this.nukeRadius||(this._cityDestroy(d),this.allUsers.set(c,d),o.affectedCities.push(c))}}}this.allUsers.set(a,r)},_recalcLocationData:function(t){var e=(new Date).valueOf();if(null===t.destinationX||null===t.destinationY)return 0;var a=t.destinationX-t.lastLocationX,r=t.destinationY-t.lastLocationY,n=Math.sqrt(a*a+r*r)/(t.speed/36e5),o=t.lastLocationTime+n,i=(e-t.lastLocationTime)/n;if(i<1){var s=this._lerpVec2({x:t.lastLocationX,y:t.lastLocationY},{x:t.destinationX,y:t.destinationY},i,!1);t.lastLocationX=s.x,t.lastLocationY=s.y}else t.lastLocationX=t.destinationX,t.lastLocationY=t.destinationY,t.destinationX=null,t.destinationY=null;return t.lastLocationTime=e,{t:i,eta:o}},_recalcUser:function(t){var e=(new Date).valueOf();this._recalcLocationData(t.locationData);var a={};for(var r in t.buildingMap){var n=t.buildingMap[r];if(n){var o=this.allBuildingInfos.get(n.id);if(o.Out0&&0<o.Out0Rate)a[s=o.Out0]||(a[s]=0),a[s]+=this.getBuildingInfoItemWithLv(n.id,"Out0Rate",n.lv)}}var i=(e-t.lastCalcTime)/6e4;for(var s in a)this._userAddCargo(t,s,a[s]*i);t.lastCalcTime=e,this.allUsers.set(t.address,t)},_userAddCargo:function(t,e,a){if(a<0)throw new Error("_userAddCargo() cargoAmount must >= 0"+a);var r=this.getUserWarehouseCap(t.address,e),n=t.cargoData;if(n[e]||(n[e]=0),n[e]<r){var o=Math.min(a,r-n[e]);return t.cargoData[e]=n[e]+o,o}return 0},_battle:function(t,e,a,r,n,o){var i,s,l,c,d,h,u,p,f;return 0==(h=!(0<=(s=(c=(20*Math.pow(t,1)+50*Math.pow(e,1)+100*Math.pow(a,1))*(100*t+40*e+20*a))-(d=1*(20*r+50*Math.pow(n,1)+100*Math.pow(o,1))*(100*r+40*n+20*o)))))?(l=s/c,i=1-.3*Math.random(),u=Math.floor(t*l*i),p=Math.min(e,Math.floor(e*l+t*l*(1-i)*100/2/40)),f=Math.min(a,Math.floor(a*l+t*l*(1-i)*100/2/20))):(l=-s/d,i=1-.3*Math.random(),u=Math.floor(r*l*i),p=Math.min(n,Math.floor(n*l+r*l*(1-i)*100/2/40)),f=Math.min(o,Math.floor(o*l+r*l*(1-i)*100/2/20))),console.log(t,e,a,"|",r,n,o,"获胜方",h,"剩余",u,p,f),{win:h,left:[u,p,f]}},_cityDestroy:function(t){t.healMaxTimestamp=0,t.cargoData={},this._userAddCargo(t,"sand",100),this.locationData=this.getRandomSpawnLocation()},_transaction:function(t,e){var a=y.transfer(t,e);console.log("transfer result:",a,e,e/1e18)},sponsor:function(t,e,a,r){var n=this.allIslands,o=n[t],i=y.transaction.value,s=y.transaction.from;if(null===o)throw new Error("Error island index."+t);if(console.log("sponsor1178|",1.2*o.money),this._collectIslandMoneyInternal(o),o.sponsor!==s&&i<1.2*o.money)throw new Error("value must > current money * 1.2. value:"+i+", island.money:"+o.money);return o.sponsor!==s?(this._transaction(o.sponsor,o.money),this.totalNas=this.totalNas-o.money,o.sponsor=s,o.money=i):o.money=o.money+o.money,this.totalNas=this.totalNas+i,o.sponsorName=e,o.sponsorLink=a,o.sponsorPic=r,n[t]=o,this.allIslands=n,{success:!0,island:o}},transfer:function(t,e,a){if(a<0)throw new Error("amount must >= 0.");var r=y.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");this._recalcUser(n);var o=this.allUsers.get(t);if(null===o)throw new Error("Receiver NOT FOUND.");if(this._recalcUser(o),n.cargoData[e]=(n.cargoData[e]||0)-a,this._userAddCargo(o,e,a),n.cargoData[e]<0)throw new Error("user's cargo NOT ENOUGH to transfer."+n.cargoData[e]);return this.allUsers.set(r,n),this.allUsers.set(t,o),{success:!0}},makeOrder:function(t,e,a,r){var n=y.transaction.from;if(null===this.allUsers.get(n))throw new Error("User NOT FOUND.");var o=this.allOrders.get(t);if(o)throw new Error("orderID is occupied. Change orderID!"+t);if(a<0&&y.transaction.value<-a)throw new Error("Paid coin not enough.");return o={maker:n,cargos:e,valueWei:a,valid:!0},r&&(o.assignedTaker=r),this.allOrders.set(t,o),{success:!0}},takeOrder:function(t){var e=y.transaction.from,a=this.allOrders.get(t);if(null===a)throw new Error("Order NOT FOUND");if(!a.valid)throw new Error("order is INVALID!");if(a.assignedTaker&&e!=a.assignedTaker)throw new Error("Only assignedTaker can take this order!"+a.assignedTaker);if(0<a.valueWei){if(y.transaction.value<a.valueWei)throw new Error("Paid coin not enough.");this._transaction(a.maker,a.valueWei)}var r=this.allUsers.get(a.maker),n=this.allUsers.get(e);for(var o in a.cargos){var i=a.cargos[o];if(i<0){if(r.cargoData[o]+=i,r.cargoData[o]<0)throw new Error("maker's cargo NOT ENOUGH!");this._userAddCargo(n,o,-i)}else if(0<i&&(this._userAddCargo(r,o,i),n.cargoData[o]-=i,n.cargoData[o]<0))throw new Error("taker's cargo NOT ENOUGH!")}return a.taker=e,a.valid=!1,this.allOrders.set(t,a),this.allUsers.set(e,n),this.allUsers.set(a.maker,r),{success:!0}},cancelOrder:function(t){var e=y.transaction.from,a=this.allOrders.get(t);if(null===a)throw new Error("Order NOT FOUND");if(!a.valid)throw new Error("order is INVALID!");if(e!=a.maker)throw new Error("Only order-maker can cancel order!"+a.maker);if(a.valueWei<0){var r=-a.valueWei;this._transaction(a.maker,r)}return a.valid=!1,this.allOrders.set(t,a),{success:!0}},bancorTrade:function(t,e){var a=y.transaction.value,r=y.transaction.from,n=this.allUsers.get(r);if(null===n)throw new Error("User NOT FOUND.");var o=this.bancorInfos.get(t+"A"),i=this.bancorInfos.get(t+"K"),s=this.bancorInfos.get(t+"X");if(0<e){if(a<1e18*(h=o/i*(Math.exp(i*(s+e))-Math.exp(i*s))))throw new Error("Value NOT ENOUGH to buy. need "+h+".You give "+a);var l=a-1e18*h;if(1e-4<l){var c=1e8*Math.floor(l/1e8);this._transaction(r,c)}this._userAddCargo(n,t,e)}else if(e<0){if(n.cargoData[t]-=e,n.cargoData[t]<0)throw new Error("Your cargo NOT ENOUGH "+(n.cargoData[t]+e));var d=this.bancorInfos.get(t+"Fee"),h=o/i*(Math.exp(i*s)-Math.exp(i*(s+e))),u=1e8*Math.floor(h*(1-d)*1e10);this._transaction(r,u)}if((s+=e)<0&&e<0)throw new Error("Bid demand NOT ENOUGH."+s);return this.bancorInfos.set(t+"X",s),this.allUsers.set(r,n),{success:!0}},setBancorInfo:function(t,e,a,r,n){if(y.transaction.from!=this.adminAddress)throw new Error("Permission denied.");return this.bancorInfos.set(t+"A",e),this.bancorInfos.set(t+"K",a),this.bancorInfos.set(t+"X",r),this.bancorInfos.set(t+"Fee",n),{success:!0}},getBancorInfo:function(t){return{cargoName:t,A:this.bancorInfos.get(t+"A"),K:this.bancorInfos.get(t+"K"),X:this.bancorInfos.get(t+"X"),Fee:this.bancorInfos.get(t+"Fee")}},getRandomSpawnLocation:function(){var t=(.25+.5*Math.random())*Math.PI,e={speed:0};return e.lastLocationX=5e3*Math.cos(t),e.lastLocationY=5e3*Math.sin(t),e.destinationX=null,e.destinationY=null,e.lastLocationTime=(new Date).valueOf(),e},_getCityIJExpanded:function(t,e,a){return Math.abs(e)<=4&&Math.abs(a)<=4?{}:t.expandMap[e+","+a]},getMapInfo:function(){for(var a=this.allUsers,t=this.allUserList.map(function(t){var e=a.get(t);return{nickname:e.nickname,address:e.address,country:e.country,healMaxTimestamp:e.healMaxTimestamp,expandCnt:e.expandCnt,locationData:e.locationData,myNukeList:e.myNukeList}}),e=[],r=0;r<this.allIslands.length;r++)e.push(this.allIslands[r]);return{success:!0,result_data:{users:t,islands:e}}},getUserList:function(){return this.allUserList},getUser:function(t){return console.log("BC.getUser",this.allUsers),this.allUsers.get(t)},getPirateInfo:function(t){if(t>=this.totalPirateCnt)throw new Error("index must < totalPirateCnt."+t+"<"+this.totalPirateCnt);var e=this.piratePeriodTimestamp,a=(new Date).valueOf();a/36e5>=Math.floor(e/36e5+1)&&(e=36e5*Math.floor(a/36e5),this.piratePeriodTimestamp=e);var r=e.toString()+t.toString(),n=this.APHash1(r),o=Math.floor(15*Math.pow(n,3))+1,i=o*o,s=o*o*o,l=this.APHash1(r+"theta"),c=this.APHash1(r+"rho"),d=l*Math.PI*2,h=5700*Math.sqrt(c),u=Math.cos(d)*h,p=Math.sin(d)*h,f={};f.x=u,f.y=p,f.lv=o;var g={},m={silicon:1,carbon:.7,iron:.5,chip:.05,deuter:1e-4};for(var v in m){var y=this.APHash1(r+v);g[v]=Math.round(this.pirateCargoC0*i*y*m[v])}g.floatmod=i,f.cargo=g;var C={},M={tank:1,chopper:.8,ship:.2};for(var v in M){y=this.APHash1(r+v);C[v]=Math.round(this.pirateArmyC0*s*y*M[v])}return f.army=C,f},getPirateData:function(t){if(t>=this.totalPirateCnt)throw new Error("index must < totalPirateCnt."+t+"<"+this.totalPirateCnt);return this.allPirates.get(t)},getExpandNeedFloatmod:function(t,e){var a=Math.max(Math.abs(t),Math.abs(e))-3;return a*a*a},getBuildingInfoItemWithLv:function(t,e,a){var r=this.allBuildingInfos.get(t)[e],n=this.allBuildingInfos.get("_upgradeRate")[e];return r?(!isNaN(n)&&0<n&&(r*=Math.pow(n,a)),r):0},getUserWarehouseCap:function(t,e){var a=this.allUsers.get(t);if(null===a)throw new Error("User NOT FOUND.");var r=0;for(var n in a.buildingMap){var o=a.buildingMap[n];if(o)this.allBuildingInfos.get(o.id).HouseOf===e&&(r+=this.getBuildingInfoItemWithLv(o.id,"Capacity",o.lv))}return r},getOrder:function(t){return this.allOrders.get(t)},getConst:function(t){return this[t]},getTimestamp:function(){return(new Date).valueOf()},_lerpVec2:function(t,e,a,r){r&&(a=Math.max(0,Math.min(1,a)));var n={};return n.x=t.x*(1-a)+e.x*a,n.y=t.y*(1-a)+e.y*a,n},APHash1:function(t){for(var e=2863311530,a=0;a<t.length;a++)e^=0==(1&a)?e<<7^t.charCodeAt(a)*(e>>3):~((e<<11)+t.charCodeAt(a)^e>>5);return e/2863311530/1.5+.5},takeRedundantNas:function(t,e){if(y.transaction.from!=this.adminAddress)throw new Error("Permission denied.");if(0==y.verifyAddress(t))throw new Error("Illegal Address.");return this.totalNas=this.totalNas-e,this._transaction(t,e),{success:!0}},changeConst:function(t,e){if(y.transaction.from!==this.adminAddress)throw new Error("Permission denied.");return this[t]=e,{success:!0}},setBuildingInfo:function(t){var e=this;if(y.transaction.from!=this.adminAddress)throw new Error("Permission denied.");this.allBuildingIDList.forEach(function(t){e.allBuildingInfos.del(t)});for(var a=[],r=0;r<t.length;r++){var n=t[r];this.allBuildingInfos.set(n.id,n),a.push(n.id)}return this.allBuildingIDList=a,{success:!0,length:this.allBuildingIDList.length}},getBuildingInfo:function(t){return this.allBuildingInfos.get(t)},setCargoInfo:function(t){var e=this;if(y.transaction.from!=this.adminAddress)throw new Error("Permission denied.");this.allCargoNameList.forEach(function(t){e.allCargoInfos.del(t)});for(var a=[],r=0;r<t.length;r++){var n=t[r];this.allCargoInfos.set(n.id,n),a.push(n.id)}return this.allCargoNameList=a,{success:!0,length:this.allCargoNameList.length}},getCargoInfo:function(t){return this.allCargoInfos.get(t)},setIslandInfo:function(t){if(y.transaction.from!=this.adminAddress)throw new Error("Permission denied.");var e=this.allIslands;if(t.length<e.length)throw new Error("You can only set longer infoArray. >="+e.length);for(var a=0;a<t.length;a++){var r=t[a];if(a<e.length)e[a].x=r.x,e[a].y=r.y;else{var n=new o;n.index=a,n.x=r.x,n.y=r.y,e.push(n)}}return this.allIslands=e,{success:!0,length:t.length}},getIslandInfo:function(t){return this.allIslands[t]},fillCargoData:function(e,t){this.allCargoNameList.forEach(function(t){e.cargoData[t]||(e.cargoData[t]=0)}),t&&this.allUsers.set(e.address,e)}},this.gameContract=new a,this.gameContract.init()},t}();a.default=r,cc._RF.pop()},{}],FlagMgr:[function(t,e,a){"use strict";cc._RF.push(e,"25e0fkSAGlFqq0SWMH7sg7L","FlagMgr"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=(r.property,function(){function t(){}return(r=t).setFlag=function(a,e){try{if(!e)return void(a.spriteFrame=null);r.flagNames.find(function(t){return t==e})?cc.loader.loadRes("flags/"+e,cc.SpriteFrame,function(t,e){t||(a.spriteFrame=e)}):a.spriteFrame=null}catch(t){console.error(t),a.spriteFrame=null}},t.flagNames=["cn","us","jp","kr","eng","ru","de","at","au","be","bg","br","ch","cl","co","cr","cs","dk","es","fr","gh","hr","ir","is","it","kp","ma","mx","ng","nir","nl","pa","pe","pl","pt","py","sa","sco","se","sk","sn","tn","uy","wal"],t=r=__decorate([n],t);var r}());a.FlagMgr=o,cc._RF.pop()},{}],Foreground:[function(t,e,a){"use strict";cc._RF.push(e,"c7a1eqdirtJGpHjde8W3SsV","Foreground"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=(r.property,function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onLoad=function(){this.node.children.forEach(function(t){t.active||(t.active=!0,t.active=!1)})},e=__decorate([n],e)}(cc.Component));a.default=o,cc._RF.pop()},{}],HomeUI:[function(t,e,a){"use strict";cc._RF.push(e,"458fd6d6ChEGo+U+drv+haG","HomeUI"),Object.defineProperty(a,"__esModule",{value:!0});var r,n=t("./CvsMain"),o=t("./BaseUI"),i=t("./MainCtrl"),s=t("./DataMgr"),l=t("./WorldUI"),c=t("./UI/ToastPanel"),d=t("./BlockchainMgr"),h=t("./UI/FlagMgr"),u=t("./UI/DialogPanel"),p=cc._decorator,f=p.ccclass,g=p.property,m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblTotalArkCount=null,t.lblNickname=null,t.lblLv=null,t.sprFlag=null,t.lblMusicButton=null,t.edtBlockchainAddress=null,t.refreshCountdown=0,t}return __extends(t,e),(a=t).prototype.onLoad=function(){(a.Instance=this).node.active=!1},t.prototype.start=function(){r},t.prototype.update=function(t){this.refreshCountdown<0&&this.refresh(),this.refreshCountdown-=t},t.prototype.refresh=function(){s.DataMgr.myUser&&(s.DataMgr.myUser.nickname&&(this.lblNickname.string=s.DataMgr.myUser.nickname),s.DataMgr.myUser.country&&(this.country=s.DataMgr.myUser.country),this.lblLv.string="Level "+s.DataMgr.getUserLevel(s.DataMgr.myUser)),h.FlagMgr.setFlag(this.sprFlag,this.country),this.lblTotalArkCount.string=Object.keys(s.DataMgr.allUsers).length.toFixed(),this.refreshCountdown=1,this.lblMusicButton.string=0<i.default.Instance.getComponent(cc.AudioSource).volume?"音乐：开":"音乐：关"},t.prototype.onClaim=function(){if(!this.lblNickname.string||!this.country)return n.default.OpenPanel("EditNicknamePanel"),void c.default.Toast("请先设置国旗和昵称");if(s.DataMgr.myUser)n.default.EnterUI(l.default);else{var t=a.Instance.lblNickname.string,e=a.Instance.country;d.default.Instance.callFunction("claimNewUser",[t,e],0,function(t){console.log("claimNewUser: ",t),"Error"!=t.toString().substr(0,5)?u.default.PopupWith2Buttons("正在发送方舟，请等候15秒","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):c.default.Toast("交易失败:"+t)})}},t.prototype.onBtnEditNicknameClick=function(){n.default.OpenPanel("EditNicknamePanel")},t.prototype.onWatchWorldClick=function(){n.default.EnterUI(l.default)},t.prototype.onBtnSponsorClick=function(){},t.prototype.onInputAddress=function(t){console.log("手动输入地址",t.string);var e=t.string;e&&(d.default.WalletAddress=e,d.default.Instance.fetchAllDataCountdown=1)},t.prototype.onExplorerClick=function(){window.open("https://explorer.neo.org/address/"+d.default.WalletAddress)},t.prototype.onBookClick=function(){console.log("哪有白皮书")},t.prototype.onBtnSwitchMusicClick=function(){var t=i.default.Instance.getComponent(cc.AudioSource);t.volume=0<t.volume?0:.25,this.lblMusicButton.string=0<t.volume?"音乐：开":"音乐：关"},t.prototype.onInstallWalletClick=function(){window.open("https://github.com/ChengOrangeJu/WebExtensionWallet")},t.prototype.onTestCheat0Click=function(){var t=Number(new Date),e=new s.UserData;(s.DataMgr.myUser=e).address="testaddress",e.nickname="测试昵称",e.country="cn",e.buildingMap={"-1,1":{id:"ironcoll",lv:0,justBuildOrUpgrade:!0},"-1,2":{id:"energycoll",lv:1,justBuildOrUpgrade:!0},"-2,2":{id:"fighterprod",lv:2,recoverTime:t+6e5,justBuildOrUpgrade:!0},"-2,3":{id:"bomberprod",lv:3,recoverTime:t-1e5,justBuildOrUpgrade:!0},"-3,3":{id:"laserprod",lv:4,recoverTime:t+6e6,justBuildOrUpgrade:!1}},e.expandCnt=1,e.expandMap={"-1,1":{order:0}},e.cargoData={iron:320,energy:120},e.locationData=new s.LocationData,e.locationData={speed:100,lastLocationX:-4050,lastLocationY:-230,lastLocationTime:t-1e5,destinationX:3920,destinationY:2390},e.collectingStarIndex=24},__decorate([g(cc.Label)],t.prototype,"lblTotalArkCount",void 0),__decorate([g(cc.Label)],t.prototype,"lblNickname",void 0),__decorate([g(cc.Label)],t.prototype,"lblLv",void 0),__decorate([g(cc.Sprite)],t.prototype,"sprFlag",void 0),__decorate([g(cc.Label)],t.prototype,"lblMusicButton",void 0),__decorate([g(cc.EditBox)],t.prototype,"edtBlockchainAddress",void 0),t=a=__decorate([f],t);var a}(o.default);a.default=m,cc._RF.pop()},{"./BaseUI":"BaseUI","./BlockchainMgr":"BlockchainMgr","./CvsMain":"CvsMain","./DataMgr":"DataMgr","./MainCtrl":"MainCtrl","./UI/DialogPanel":"DialogPanel","./UI/FlagMgr":"FlagMgr","./UI/ToastPanel":"ToastPanel","./WorldUI":"WorldUI"}],IntroUI:[function(t,e,a){"use strict";cc._RF.push(e,"09076VctrZEVKhEeIiQ5hEn","IntroUI"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../CvsMain"),n=t("../HomeUI"),o=cc._decorator,i=o.ccclass,s=(o.property,function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onBtnStartClick=function(){r.default.EnterUI(n.default);console.log("==============[]【】这个好用吗",{a:3,b:4,c:9,d:{h:"stses"}})},e=__decorate([i],e)}(cc.Component));a.default=s,cc._RF.pop()},{"../CvsMain":"CvsMain","../HomeUI":"HomeUI"}],IronMine:[function(t,e,a){"use strict";cc._RF.push(e,"ff0cb7j7qpO/Yov9EsIMZAo","IronMine"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=(r.property,function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onLoad=function(){if(this.gra=this.getComponent(cc.Graphics),this.col=this.getComponent(cc.PolygonCollider),3<=this.col.points.length&&this.gra){this.gra.moveTo(this.col.points[0].x,this.col.points[0].y);for(var t=1;t<this.col.points.length;t++){var e=this.col.points[t];this.gra.lineTo(e.x,e.y)}this.gra.close(),this.gra.fill()}},e=__decorate([n],e)}(cc.Component));a.default=o,cc._RF.pop()},{}],IslandInfoFrame:[function(t,e,a){"use strict";cc._RF.push(e,"c2894Vc0LZARZptbw433jyZ","IslandInfoFrame"),Object.defineProperty(a,"__esModule",{value:!0});var n=t("../DataMgr"),o=t("../Utils/CurrencyFormatter"),r=t("../WorldUI"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblName=null,t.lblLeftMoney=null,t.lblMiningSpeed=null,t.lblOccupant=null,t.grpTitle=null,t.grpMore=null,t}return __extends(t,e),t.prototype.refresh=function(t){if(t){this.lblName.string=t.sponsorName;var e=n.DataMgr.calcCurrentMoneyInIsland(t);this.lblLeftMoney.string=o.default.formatNAS(e/1e18)+"NAS";var a=t.miningRate*e/1e18;if(this.lblMiningSpeed.string=o.default.formatNAS(a)+"NAS/小时",t.occupant&&0<t.occupant.length){var r=t.occupant==n.DataMgr.myUser.address?n.DataMgr.myUser:n.DataMgr.allUsers[t.occupant];this.lblOccupant.string=r?r.nickname:t.occupant}else this.lblOccupant.string="(无)"}},t.prototype.refreshAsZoomScale=function(){this.grpMore.opacity=.18<r.default.Instance.zoomScale||r.default.Instance.focusedObjectNode==this.node.parent?255:0,this.grpTitle.opacity=.08<r.default.Instance.zoomScale||r.default.Instance.focusedObjectNode==this.node.parent?255:0},__decorate([l(cc.Label)],t.prototype,"lblName",void 0),__decorate([l(cc.Label)],t.prototype,"lblLeftMoney",void 0),__decorate([l(cc.Label)],t.prototype,"lblMiningSpeed",void 0),__decorate([l(cc.Label)],t.prototype,"lblOccupant",void 0),__decorate([l(cc.Node)],t.prototype,"grpTitle",void 0),__decorate([l(cc.Node)],t.prototype,"grpMore",void 0),t=__decorate([s],t)}(cc.Component);a.default=c,cc._RF.pop()},{"../DataMgr":"DataMgr","../Utils/CurrencyFormatter":"CurrencyFormatter","../WorldUI":"WorldUI"}],Island:[function(t,e,a){"use strict";cc._RF.push(e,"d5cb37wYS9LEY2kNMygFSvm","Island"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../MainCtrl"),n=t("../WorldUI"),o=t("../UI/IslandInfoFrame"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.infoFrame=null,t.lblName=null,t}return __extends(t,e),t.prototype.onLoad=function(){},t.prototype.setData=function(t){this.data=t,this.refresh()},t.prototype.update=function(){r.default.Ticks%60==0&&this.refresh(),this.node.position=new cc.Vec2(this.data.x,this.data.y).mul(n.default.Instance.zoomScale)},t.prototype.refresh=function(){this.lblName.string=this.data.sponsorName},t.prototype.onLinkClick=function(){var t=this.data.sponsorLink;t&&0<t.length&&window.open(t)},t.prototype.onClick=function(){n.default.Instance.selectObject(this.node)},__decorate([l(o.default)],t.prototype,"infoFrame",void 0),__decorate([l(cc.Label)],t.prototype,"lblName",void 0),t=__decorate([s],t)}(cc.Component);a.default=c,cc._RF.pop()},{"../MainCtrl":"MainCtrl","../UI/IslandInfoFrame":"IslandInfoFrame","../WorldUI":"WorldUI"}],MainCtrl:[function(t,e,a){"use strict";cc._RF.push(e,"162b9/mIe1LjqpHBpjQnzp+","MainCtrl"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("./CvsMain"),n=t("./DataMgr"),o=t("./HomeUI"),i=t("./BlockchainMgr"),s=t("./Internal/FakeBC"),l=cc._decorator.ccclass,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.syncTimestampCountdown=0,t}return __extends(t,e),(a=t).prototype.onLoad=function(){a.Instance=this,r.default.Instance.uiContainer.getChildByName("WorldUI").active=!0,cc.loader.loadRes("Building",function(t,e){console.log("Building loaded",e),n.DataMgr.BuildingConfig=e,s.default.instance.callFunction("APL5FCFSZrnG8L3cinkDRmXFDb27quJUWE","setBuildingInfo",JSON.stringify([n.DataMgr.BuildingConfig]),0)}.bind(this)),cc.loader.loadRes("Cargo",function(t,e){console.log("Cargo loaded",e),n.DataMgr.CargoConfig=e,s.default.instance.callFunction("APL5FCFSZrnG8L3cinkDRmXFDb27quJUWE","setCargoInfo",JSON.stringify([n.DataMgr.CargoConfig]),0)}.bind(this)),n.DataMgr.init()},t.prototype.start=function(){var e=this;r.default.EnterUI(o.default),setTimeout(function(){var t=cc.url.raw("resources/audio/bgm.mp3");e.bgmHandler=cc.audioEngine.play(t,!0,.5)},1e3)},t.prototype.update=function(t){a.Ticks++,this.syncTimestampCountdown-=t,this.syncTimestampCountdown<=0&&(i.default.Instance.getFunction("getTimestamp",[],function(t){try{var e=t.result;n.DataMgr.timestampOffset=e-Number(new Date)}catch(t){console.error(t)}}),this.syncTimestampCountdown+=2)},t.Ticks=0,t=a=__decorate([l],t);var a}(cc.Component);a.default=c,cc._RF.pop()},{"./BlockchainMgr":"BlockchainMgr","./CvsMain":"CvsMain","./DataMgr":"DataMgr","./HomeUI":"HomeUI","./Internal/FakeBC":"FakeBC"}],MathUtil:[function(t,e,a){"use strict";cc._RF.push(e,"e834emvIIxJJ4yMKuLc8OvM","MathUtil"),Object.defineProperty(a,"__esModule",{value:!0});var r=function(){function t(){}return t.lerp=function(t,e,a,r){return r&&(a=Math.max(0,Math.min(1,a))),t*(1-a)+e*a},t.lerpVec2=function(t,e,a,r){return r&&(a=Math.max(0,Math.min(1,a))),t.mul(1-a).add(e.mul(a))},t}();a.default=r,cc._RF.pop()},{}],Pirate:[function(t,e,a){"use strict";cc._RF.push(e,"8e43eh4pIxH27jAFlDUl+4F","Pirate"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../WorldUI"),n=t("../DataMgr"),o=cc._decorator,i=o.ccclass,s=o.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblName=null,t.lblLv=null,t.grpInfo=null,t}return __extends(t,e),t.prototype.setAndRefresh=function(t,e,a){this.index=t,this.lblName.string="海盗",this.refreshData(e),this.refreshZoom(a)},t.prototype.refreshData=function(t){this.data=t,this.lblLv.string=t.lv.toString()},t.prototype.refreshZoom=function(t){if(this.data){var e=new cc.Vec2(this.data.x,this.data.y);this.node.position=e.mul(t)}},t.prototype.update=function(t){this.refreshZoom(r.default.Instance.zoomScale)},t.prototype.onClick=function(){r.default.Instance.selectObject(this.node),n.DataMgr.fetchPirateDataFromBlockchain(this.index)},__decorate([s(cc.Label)],t.prototype,"lblName",void 0),__decorate([s(cc.Label)],t.prototype,"lblLv",void 0),__decorate([s(cc.Node)],t.prototype,"grpInfo",void 0),t=__decorate([i],t)}(cc.Component);a.default=l,cc._RF.pop()},{"../DataMgr":"DataMgr","../WorldUI":"WorldUI"}],ProducerBuilding:[function(t,e,a){"use strict";cc._RF.push(e,"9d500wkk9VBX7d2wFCzaLaX","ProducerBuilding"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("./Building"),n=t("../MainCtrl"),o=cc._decorator,i=o.ccclass,s=o.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblCd=null,t}return __extends(t,e),t.prototype.update=function(t){n.default.Ticks%500==0&&this.refresh();var e=Number(new Date);if(e>=this.data.recoverTime)this.lblCd.string="等待生产";else{var a=this.data.recoverTime-e;this.lblCd.string="冷却中 "+(a/36e5).toFixed()+":"+(a%36e5/6e4).toFixed()+":"+(a%6e4/1e3).toFixed()}},__decorate([s(cc.Label)],t.prototype,"lblCd",void 0),t=__decorate([i],t)}(r.default);a.default=l,cc._RF.pop()},{"../MainCtrl":"MainCtrl","./Building":"Building"}],ProductionPanel:[function(t,e,a){"use strict";cc._RF.push(e,"0ec02S4FWRIsa07Iybuw4PB","ProductionPanel"),Object.defineProperty(a,"__esModule",{value:!0});var h=t("../DataMgr"),u=t("../BlockchainMgr"),p=t("./ToastPanel"),f=t("./DialogPanel"),r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.sprPic=null,t.lblTitle=null,t.lblLv=null,t.inContainer=null,t.lblIn0=null,t.lblOut0=null,t.lblOut0Down=null,t.lblCd=null,t.lblMax=null,t.edtAmt=null,t.SldAmt=null,t.maxAmt=0,t.inList=[],t}return __extends(t,e),(a=t).prototype.onLoad=function(){(a.Instance=this).init()},t.prototype.init=function(){this.inList.push(this.lblIn0);for(var t=1;t<4;t++){var e=cc.instantiate(this.lblIn0.node);e.parent=this.inContainer,this.inList.push(e.getComponent(cc.Label))}this.normalColor=this.lblIn0.node.color},t.prototype.setAndRefresh=function(t,e){this.building=t,this.buildingData=e,this.SldAmt.progress=0,this.onSliderChange();var a=h.DataMgr.getBuildingInfoItemWithLv(e.id,"MaxQueue",e.lv);if(this.maxAmt=Math.floor(a),this.lblMax.string="/"+this.maxAmt.toFixed(),this.sprPic)try{var r=this,n=this.building.info;n.Pic?cc.loader.loadRes("buildings/"+n.Pic,cc.SpriteFrame,function(t,e){t||(r.sprPic.spriteFrame=e)}):this.sprPic.spriteFrame=null}catch(t){console.error(t),this.sprPic.spriteFrame=null}this.refresh()},t.prototype.onSliderChange=function(){this.edtAmt.string=Math.floor(this.SldAmt.progress*this.maxAmt).toFixed(),this.refresh()},t.prototype.onEditBoxChange=function(){var t=parseInt(this.edtAmt.string);t=Math.max(0,Math.min(this.maxAmt,t)),this.edtAmt.string=t.toFixed(),this.SldAmt.progress=t/this.maxAmt,this.refresh()},t.prototype.refresh=function(){for(var t=Math.floor(this.SldAmt.progress*this.maxAmt),e=h.DataMgr.getUserCurrentCargoData(h.DataMgr.myUser),a=this.building.info,r=0;r<4;r++){var n=a["In"+r],o=this.inList[r];if(n){var i=h.DataMgr.getBuildingInfoItemWithLv(a.id,"In"+r+"Amt",this.buildingData.lv)*t,s=h.DataMgr.getCargoInfo(n).Name;o.string=i.toFixed()+" "+s,o.node.color=i<=(e[n]||0)?this.normalColor:cc.Color.RED,o.node.active=!0}else o.node.active=!1}var l=h.DataMgr.getCargoInfo(a.Out0).Name;this.lblOut0.string=t+" "+l,this.lblOut0Down.string=l;var c=h.DataMgr.getBuildingInfoItemWithLv(this.buildingData.id,"CDPerUnit",this.buildingData.lv)*t;this.lblCd.string=Math.floor(c/60)+"h"+Math.floor(c)+"min"},t.prototype.onConfirmClick=function(){console.log("准备生产",this.buildingData);for(var t=h.DataMgr.myUser,e=Math.floor(this.SldAmt.progress*this.maxAmt),a=h.DataMgr.getUserCurrentCargoData(t),r=this.building.info,n=!0,o=0;o<4;o++){var i=r["In"+o];if(i)h.DataMgr.getBuildingInfoItemWithLv(r.id,"In"+o+"Amt",this.buildingData.lv)*e>(a[i]||0)&&(n=!1)}var s=r.Out0,l=h.DataMgr.getUserWarehouseCap(t,s);t.cargoData[s]+e>l&&p.default.Toast("仓库容量不够，如果强行生产，超出容量的部分会被销毁哦");var c=this,d=function(){var t=JSON.parse("["+c.building.node.name+"]");u.default.Instance.callFunction("produce",[t[0],t[1],e],0,function(t){"Error"!=t.toString().substr(0,5)?(f.default.PopupWith2Buttons("正在递交生产计划","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null),c.close()):p.default.Toast("交易失败:"+t)})};n?d():f.default.PopupWith2Buttons("某些原料存货不足","强行发送区块链交易可能失败","确定",null,"强行发送",d)},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([o(cc.Sprite)],t.prototype,"sprPic",void 0),__decorate([o(cc.Label)],t.prototype,"lblTitle",void 0),__decorate([o(cc.Label)],t.prototype,"lblLv",void 0),__decorate([o(cc.Node)],t.prototype,"inContainer",void 0),__decorate([o(cc.Label)],t.prototype,"lblIn0",void 0),__decorate([o(cc.Label)],t.prototype,"lblOut0",void 0),__decorate([o(cc.Label)],t.prototype,"lblOut0Down",void 0),__decorate([o(cc.Label)],t.prototype,"lblCd",void 0),__decorate([o(cc.Label)],t.prototype,"lblMax",void 0),__decorate([o(cc.EditBox)],t.prototype,"edtAmt",void 0),__decorate([o(cc.Slider)],t.prototype,"SldAmt",void 0),t=a=__decorate([n],t);var a}(cc.Component);a.default=i,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","../DataMgr":"DataMgr","./DialogPanel":"DialogPanel","./ToastPanel":"ToastPanel"}],SliderFill:[function(t,e,a){"use strict";cc._RF.push(e,"8a084tl2VNHgIvf7wWiK9H/","SliderFill"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.slider=null,t}return __extends(t,e),t.prototype.start=function(){this.spr=this.node.getComponent(cc.Sprite)},t.prototype.update=function(){this.spr&&this.slider&&(this.spr.fillRange=this.slider.progress)},__decorate([o(cc.Slider)],t.prototype,"slider",void 0),t=__decorate([n],t)}(cc.Component);a.default=i,cc._RF.pop()},{}],SpecialArk:[function(t,e,a){"use strict";cc._RF.push(e,"af740uwBhpJLINK3QpsTq54","SpecialArk"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../WorldUI"),n=t("../UI/DialogPanel"),o=cc._decorator,i=o.ccclass,s=o.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.strName="",t.distanceThreshold=1e4,t.strTooFar="",t.strInfo="",t.grpInfo=null,t}return __extends(t,e),t.prototype.onLoad=function(){this.location=this.node.position},t.prototype.onClick=function(){r.default.Instance.selectObject(this.node)},t.prototype.refreshZoom=function(t){this.node.position=this.location.mul(t),this.grpInfo.opacity=.08<r.default.Instance.zoomScale||r.default.Instance.focusedObjectNode==this.node.parent?255:0},t.prototype.update=function(t){this.refreshZoom(r.default.Instance.zoomScale)},t.prototype.showInfo=function(t){t>this.distanceThreshold?n.default.PopupWithOKButton(this.strName,this.strTooFar):n.default.PopupWithOKButton(this.strName,this.strInfo)},__decorate([s(String)],t.prototype,"strName",void 0),__decorate([s(cc.Float)],t.prototype,"distanceThreshold",void 0),__decorate([s(String)],t.prototype,"strTooFar",void 0),__decorate([s(String)],t.prototype,"strInfo",void 0),__decorate([s(cc.Node)],t.prototype,"grpInfo",void 0),t=__decorate([i],t)}(cc.Component);a.SpecialArk=l,cc._RF.pop()},{"../UI/DialogPanel":"DialogPanel","../WorldUI":"WorldUI"}],SponsorIslandPanel:[function(t,e,a){"use strict";cc._RF.push(e,"6fe40yau5dLRKwAtiP/MgV8","SponsorIslandPanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../BlockchainMgr"),n=t("../Utils/CurrencyFormatter"),o=t("../DataMgr"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.edtName=null,t.edtLink=null,t.edtValue=null,t.lblCurMoney=null,t}return __extends(t,e),(a=t).prototype.onLoad=function(){a.Instance=this},t.prototype.setData=function(t){if((this.island=t).data.sponsor==r.default.WalletAddress)this.lblCurMoney.string="0";else{var e=o.DataMgr.calcCurrentMoneyInIsland(t.data);this.lblCurMoney.string=n.default.formatNAS(1.101*e/1e18)}},t.prototype.onConfirmClick=function(){r.default.Instance.sponsor(this.island.data.index,this.edtName.string,this.edtLink.string,parseFloat(this.edtValue.string))},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([l(cc.EditBox)],t.prototype,"edtName",void 0),__decorate([l(cc.EditBox)],t.prototype,"edtLink",void 0),__decorate([l(cc.EditBox)],t.prototype,"edtValue",void 0),__decorate([l(cc.Label)],t.prototype,"lblCurMoney",void 0),t=a=__decorate([s],t);var a}(cc.Component);a.default=c,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","../DataMgr":"DataMgr","../Utils/CurrencyFormatter":"CurrencyFormatter"}],ToastPanel:[function(t,e,a){"use strict";cc._RF.push(e,"159ccmVx0JBF6iFx9aAYPqK","ToastPanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.toastTemplate=null,t.container=null,t}return __extends(t,e),(r=t).prototype.onLoad=function(){(r.Instance=this).toastTemplate.active=!1},t.prototype.toast=function(t){var e=cc.instantiate(r.Instance.toastTemplate);e.parent=this.container,e.getComponent(cc.Label).string=t,e.active=!0;var a=cc.sequence(cc.delayTime(4.5),cc.fadeOut(.5));e.runAction(a),setTimeout(function(){e.destroy()},5e3)},t.Toast=function(t){r.Instance.toast(t)},__decorate([o(cc.Node)],t.prototype,"toastTemplate",void 0),__decorate([o(cc.Node)],t.prototype,"container",void 0),t=r=__decorate([n],t);var r}(cc.Component);a.default=i,cc._RF.pop()},{}],TransferPanel:[function(t,e,a){"use strict";cc._RF.push(e,"e9d0c/1sVlHbq6Z18AAYTLU","TransferPanel"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../BlockchainMgr"),n=t("./ToastPanel"),o=t("./DialogPanel"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.edtReceiver=null,t.edtValue=null,t.cargoName="iron",t}return __extends(t,e),(a=t).prototype.onLoad=function(){(a.Instance=this).node.active=!1},t.prototype.onToggleClick=function(t,e){this.cargoName=e},t.prototype.onConfirmClick=function(){try{var t=[this.edtReceiver.string,this.cargoName,parseFloat(this.edtValue.string)];r.default.Instance.callFunction("transfer",t,0,function(t){"Error"!=t.toString().substr(0,5)?o.default.PopupWith2Buttons("正在申请转移资源","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null):n.default.Toast("交易失败:"+t)})}catch(t){console.error(t)}},t.prototype.close=function(){this.node.active=!1},__decorate([l(cc.EditBox)],t.prototype,"edtReceiver",void 0),__decorate([l(cc.EditBox)],t.prototype,"edtValue",void 0),t=a=__decorate([s],t);var a}(cc.Component);a.default=c,cc._RF.pop()},{"../BlockchainMgr":"BlockchainMgr","./DialogPanel":"DialogPanel","./ToastPanel":"ToastPanel"}],TweenOpacity:[function(t,e,a){"use strict";cc._RF.push(e,"50870XUWSxEeYdFk2Rucuib","TweenOpacity"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../Utils/MathUtil"),n=cc._decorator,o=n.ccclass,i=n.property,s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.origin=0,t.target=0,t.duration=0,t.delay=0,t.state=0,t.countdown=0,t}return __extends(t,e),t.prototype.start=function(){this.state=0,this.countdown=this.delay,this.setValue(0)},t.prototype.update=function(t){if(this.countdown-=t,0==this.state&&this.countdown<=0&&(this.state=1,this.countdown=this.duration),1==this.state){var e=1-this.countdown/this.duration;this.setValue(e)}},t.prototype.setValue=function(t){this.node.opacity=r.default.lerp(this.origin,this.target,t,!0)},__decorate([i(Number)],t.prototype,"origin",void 0),__decorate([i(Number)],t.prototype,"target",void 0),__decorate([i(Number)],t.prototype,"duration",void 0),__decorate([i(Number)],t.prototype,"delay",void 0),t=__decorate([o],t)}(cc.Component);a.default=s,cc._RF.pop()},{"../Utils/MathUtil":"MathUtil"}],TypewriterEffect:[function(t,e,a){"use strict";cc._RF.push(e,"7fbd51U3iBPeJu8Wjjtt9Cw","TypewriterEffect"),Object.defineProperty(a,"__esModule",{value:!0});var r=cc._decorator,n=r.ccclass,o=r.property,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.label=null,t.richText=null,t.delay=0,t}return __extends(t,e),t.prototype.onLoad=function(){var t=this.label?this.label:this.richText;t&&(this.txt=t.string,setTimeout(this.playEffect(t,t.string,null),1e3*this.delay))},t.prototype.playEffect=function(t,e,a){var r=this,n="",o=e.split(""),i=o.length,s=0;r.func=function(){n+=o[s],t.string=n,++s==i&&(r.unschedule(r.func),a&&a())},r.schedule(r.func,.05,cc.macro.REPEAT_FOREVER,0)},__decorate([o(cc.Label)],t.prototype,"label",void 0),__decorate([o(cc.RichText)],t.prototype,"richText",void 0),__decorate([o(Number)],t.prototype,"delay",void 0),t=__decorate([n],t)}(cc.Component);a.default=i,cc._RF.pop()},{}],WarehouseBuilding:[function(t,e,a){"use strict";cc._RF.push(e,"4551bhwrptGmI96ad9hW5WZ","WarehouseBuilding"),Object.defineProperty(a,"__esModule",{value:!0});var r=t("../DataMgr"),n=t("./Building"),o=cc._decorator,i=o.ccclass,s=o.property,l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblCapacity=null,t}return __extends(t,e),t.prototype.update=function(){this.lblCapacity.string=r.DataMgr.getBuildingInfoItemWithLv(this.data.id,"Capacity",this.data.lv)},__decorate([s(cc.Label)],t.prototype,"lblCapacity",void 0),t=__decorate([i],t)}(n.default);a.default=l,cc._RF.pop()},{"../DataMgr":"DataMgr","./Building":"Building"}],WatchOtherPanel:[function(t,e,a){"use strict";cc._RF.push(e,"7e987wV2udMaZX80yZDbroV","WatchOtherPanel"),Object.defineProperty(a,"__esModule",{value:!0});var o=t("../DataMgr"),r=t("../CvsMain"),n=t("./AttackOtherPanel"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblTitle=null,t.lblLv=null,t.lblHull=null,t.lblDefTank=null,t.lblDefChopper=null,t.lblDefShip=null,t.cargoFrameTemplate=null,t.cargoFrameContainer=null,t.cargoFrameList=[],t}return __extends(t,e),(a=t).prototype.onLoad=function(){a.Instance=this},t.prototype.start=function(){this.cargoFrameTemplate.active=!1},t.prototype.setAndRefresh=function(t){console.log("sAR",t),this.user=t,this.lblTitle.string=t.nickname,this.lblLv.string=o.DataMgr.getUserLevel(t).toFixed(),this.lblHull.string=(100*o.DataMgr.getUserHull(t)).toFixed()+"%";var e=o.DataMgr.getUserCurrentCargoData(t);this.lblDefTank.string=(e.tank||0).toFixed(),this.lblDefChopper.string=(e.chopper||0).toFixed(),this.lblDefShip.string=(e.ship||0).toFixed();var a=0;for(var r in e){var n=void 0;a<this.cargoFrameList.length?n=this.cargoFrameList[a]:((n=cc.instantiate(this.cargoFrameTemplate)).parent=this.cargoFrameContainer,this.cargoFrameList.push(n),n.active=!0),n.getChildByName("LblCargo").getComponent(cc.Label).string=o.DataMgr.getCargoInfo(r).Name+"  "+e[r].toFixed(),a++}for(;a<this.cargoFrameList.length;a++)this.cargoFrameList[a].destroy()},t.prototype.onAttackClick=function(){var t=this,e=function(t){n.default.Instance&&n.default.Instance.setAndRefresh(t)};r.default.OpenPanel("AttackOtherPanel",function(){return e(o.DataMgr.allUsers[t.user.address])}),o.DataMgr.fetchUserDataFromBlockchain(this.user.address,e),this.close()},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([l(cc.Label)],t.prototype,"lblTitle",void 0),__decorate([l(cc.Label)],t.prototype,"lblLv",void 0),__decorate([l(cc.Label)],t.prototype,"lblHull",void 0),__decorate([l(cc.Label)],t.prototype,"lblDefTank",void 0),__decorate([l(cc.Label)],t.prototype,"lblDefChopper",void 0),__decorate([l(cc.Label)],t.prototype,"lblDefShip",void 0),__decorate([l(cc.Node)],t.prototype,"cargoFrameTemplate",void 0),__decorate([l(cc.Node)],t.prototype,"cargoFrameContainer",void 0),t=a=__decorate([s],t);var a}(cc.Component);a.default=c,cc._RF.pop()},{"../CvsMain":"CvsMain","../DataMgr":"DataMgr","./AttackOtherPanel":"AttackOtherPanel"}],WatchPiratePanel:[function(t,e,a){"use strict";cc._RF.push(e,"f3628K/3vJOpY2CWHDJxf+T","WatchPiratePanel"),Object.defineProperty(a,"__esModule",{value:!0});var o=t("../DataMgr"),r=t("../CvsMain"),n=t("./AttackPiratePanel"),i=cc._decorator,s=i.ccclass,l=i.property,c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lblTitle=null,t.lblLv=null,t.lblDefTank=null,t.lblDefChopper=null,t.lblDefShip=null,t.cargoFrameTemplate=null,t.cargoFrameContainer=null,t.cargoFrameList=[],t}return __extends(t,e),(a=t).prototype.onLoad=function(){a.Instance=this},t.prototype.start=function(){this.cargoFrameTemplate.active=!1},t.prototype.setAndRefresh=function(t){this.pirateData=t,this.lblTitle.string="海盗 #"+t.index.toString(),this.lblLv.string=t.lv.toString(),console.log("sAR",t),this.lblDefTank.string=(t.army.tank||0).toFixed(),this.lblDefChopper.string=(t.army.chopper||0).toFixed(),this.lblDefShip.string=(t.army.ship||0).toFixed();var e=t.cargo,a=0;for(var r in e){var n=void 0;a<this.cargoFrameList.length?n=this.cargoFrameList[a]:((n=cc.instantiate(this.cargoFrameTemplate)).parent=this.cargoFrameContainer,this.cargoFrameList.push(n),n.active=!0),n.getChildByName("LblCargo").getComponent(cc.Label).string=o.DataMgr.getCargoInfo(r).Name+"  "+e[r].toFixed(),a++}for(;a<this.cargoFrameList.length;a++)this.cargoFrameList[a].destroy()},t.prototype.onAttackClick=function(){var t=this,e=function(t){n.default.Instance.setAndRefresh(t)};r.default.OpenPanel("AttackPiratePanel",function(){return e(o.DataMgr.getPirateData(t.pirateData.index))}),o.DataMgr.fetchPirateDataFromBlockchain(this.pirateData.index,e),this.close()},t.prototype.close=function(){this.node.destroy(),a.Instance=null},__decorate([l(cc.Label)],t.prototype,"lblTitle",void 0),__decorate([l(cc.Label)],t.prototype,"lblLv",void 0),__decorate([l(cc.Label)],t.prototype,"lblDefTank",void 0),__decorate([l(cc.Label)],t.prototype,"lblDefChopper",void 0),__decorate([l(cc.Label)],t.prototype,"lblDefShip",void 0),__decorate([l(cc.Node)],t.prototype,"cargoFrameTemplate",void 0),__decorate([l(cc.Node)],t.prototype,"cargoFrameContainer",void 0),t=a=__decorate([s],t);var a}(cc.Component);a.default=c,cc._RF.pop()},{"../CvsMain":"CvsMain","../DataMgr":"DataMgr","./AttackPiratePanel":"AttackPiratePanel"}],WorldUI:[function(t,e,a){"use strict";cc._RF.push(e,"d2d4ehqPFVDS4fv9l1Oq7He","WorldUI"),Object.defineProperty(a,"__esModule",{value:!0});var n=t("./CvsMain"),r=t("./BaseUI"),o=t("./CityUI"),M=t("./DataMgr"),i=t("./BlockchainMgr"),s=t("./HomeUI"),_=t("./World/Island"),D=t("./Utils/CurrencyFormatter"),l=t("./UI/SponsorIslandPanel"),c=t("./UI/ToastPanel"),b=t("./World/SpecialArk"),I=t("./World/Pirate"),k=t("./World/ArkInWorld"),d=t("./UI/DialogPanel"),h=t("./UI/CityInfoPanel"),u=cc._decorator,p=u.ccclass,f=u.property,g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.mineContainer=null,t.islandContainer=null,t.islandTemplate=null,t.cityContainer=null,t.cityTemplate=null,t.pirateContainer=null,t.pirateTemplate=null,t.worldMap=null,t.earth=null,t.grpSelectOther=null,t.grpSelectIsland=null,t.grpSelectPirate=null,t.grpSelectSpeArk=null,t.selectFrame=null,t.btnSponsorLink=null,t.lblAttackButton=null,t.btnCollectIsland=null,t.panPad=null,t.sldZoom=null,t.pressingZoomSlider=!1,t.zoomScale=.1,t.togOtherPlayer=null,t.togPirate=null,t.togDiamond=null,t.togScenicSpot=null,t.togNuke=null,t.focusedInfoFrame=null,t.lblSelectInfo0=null,t.lblSelectInfo1=null,t.refreshCountdown=0,t.editSailDestinationMode=!1,t.grpSail=null,t.sailDestinationIndicator=null,t.sailRouteIndicator=null,t.btnCancelSail=null,t.btnConfirmSail=null,t}return __extends(t,e),(r=t).prototype.onLoad=function(){(r.Instance=this).node.active=!1;var e=this;this.sldZoom.node.getChildByName("Handle").on(cc.Node.EventType.TOUCH_START,function(t){e.pressingZoomSlider=!0}),this.sldZoom.node.getChildByName("Handle").on(cc.Node.EventType.TOUCH_END,function(t){e.pressingZoomSlider=!1}),this.sldZoom.node.getChildByName("Handle").on(cc.Node.EventType.TOUCH_CANCEL,function(t){e.pressingZoomSlider=!1}),this.panPad.on(cc.Node.EventType.TOUCH_MOVE,this.onPanPadTouchMove,this),this.panPad.on(cc.Node.EventType.MOUSE_WHEEL,this.onMouseWheel,this),this.panPad.on(cc.Node.EventType.TOUCH_END,this.onPanPadTouchEnd,this),this.cityTemplate.active=!1,this.pirateTemplate.active=!1,this.islandTemplate.active=!1},t.prototype.onEnable=function(){this.editSailDestinationMode=!1,this.focusedObjectNode=null;try{this.refreshData(),this.refreshZoom()}catch(t){console.error(t)}},t.prototype.onBtnBackClick=function(){n.default.EnterUI(s.default)},t.prototype.refreshData=function(){if(this.togOtherPlayer.isChecked){for(var t=Object.keys(M.DataMgr.allUsers).length,e=this.cityContainer.childrenCount;e<t;e++){(l=cc.instantiate(this.cityTemplate)).parent=this.cityContainer,l.active=!0,l.on(cc.Node.EventType.TOUCH_MOVE,this.onPanPadTouchMove,this),l.on(cc.Node.EventType.MOUSE_WHEEL,this.onMouseWheel,this)}for(var a=[],r=t;r<this.cityContainer.childrenCount;r++)a.push(this.cityContainer.children[r]);a.forEach(function(t){return t.destroy()});var n=0;for(var o in M.DataMgr.allUsers){var i=M.DataMgr.allUsers[o];this.cityContainer.children[n].getComponent(k.default).setAndRefresh(i,this.zoomScale),n++}this.cityContainer.active=!0}else this.cityContainer.active=!1;if(this.togPirate.isChecked){for(t=M.DataMgr.totalPirateCnt,n=this.pirateContainer.childrenCount;n<t;n++){(l=cc.instantiate(this.pirateTemplate)).parent=this.pirateContainer,l.active=!0,l.on(cc.Node.EventType.TOUCH_MOVE,this.onPanPadTouchMove,this),l.on(cc.Node.EventType.MOUSE_WHEEL,this.onMouseWheel,this)}for(a=[],n=t;n<this.pirateContainer.childrenCount;n++)a.push(this.pirateContainer.children[n]);a.forEach(function(t){return t.destroy()});for(n=0;n<t;n++)this.pirateContainer.children[n].getComponent(I.default).setAndRefresh(n,M.DataMgr.getPirateData(n),this.zoomScale);this.pirateContainer.active=!0}else this.pirateContainer.active=!1;if(this.togDiamond.isChecked){t=Object.keys(M.DataMgr.allIslandData).length;for(var s=this.islandContainer.childrenCount;s<t;s++){var l;(l=cc.instantiate(this.islandTemplate)).parent=this.islandContainer,l.active=!0,l.on(cc.Node.EventType.TOUCH_MOVE,this.onPanPadTouchMove,this),l.on(cc.Node.EventType.MOUSE_WHEEL,this.onMouseWheel,this)}a=[];for(var c=t;c<this.islandContainer.childrenCount;c++)a.push(this.islandContainer.children[c]);a.forEach(function(t){return t.destroy()});n=0;for(var d in M.DataMgr.allIslandData){i=M.DataMgr.allIslandData[d];this.islandContainer.children[n].getComponent(_.default).setData(i),n++}this.islandContainer.active=!0}else this.islandContainer.active=!1;this.refreshCountdown=2},t.prototype.refreshZoom=function(){this.earth.scale=this.zoomScale,this.editSailDestinationMode&&this.newDestination&&(this.sailDestinationIndicator.position=this.newDestination.mul(this.zoomScale))},t.prototype.update=function(t){if(this.refreshCountdown<0)try{this.refreshData()}catch(t){console.error(t)}this.refreshCountdown-=t;var e=this.sldZoom.progress;if(this.pressingZoomSlider||(.5<e?((e-=5*t)<.5&&(e=.5),this.sldZoom.progress=e):e<.5&&(.5<(e+=5*t)&&(e=.5),this.sldZoom.progress=e)),.5!=e){var a=this.zoomScale;this.zoomScale*=Math.pow(1.5,2*(e-.5)*5*t),this.clampZoom();var r=this.zoomScale/a;this.worldMap.position=this.worldMap.position.mul(r),this.refreshZoom()}if(this.focusedInfoFrame.active=!1,this.focusedObjectNode){this.selectFrame.active=!0,this.selectFrame.position=this.focusedObjectNode.position;var n=this.focusedObjectNode.getComponent(k.default),o=this.focusedObjectNode.getComponent(b.SpecialArk),i=this.focusedObjectNode.getComponent(I.default),s=this.focusedObjectNode.getComponent(_.default);if(n)this.grpSelectSpeArk.active=!1,this.grpSelectIsland.active=!1;else if(i)this.focusedInfoFrame.position=this.focusedObjectNode.position,this.lblSelectInfo0.string="Lv "+(i.data.lv+1),this.lblSelectInfo1.string="坦克 "+(i.data.army.tank?i.data.army.tank.toFixed():0)+"\n无人机 "+(i.data.army.tank?i.data.army.tank.toFixed():0)+"\n炮舰 "+(i.data.army.tank?i.data.army.tank.toFixed():0)+"\n浮力模块 "+(i.data.cargo.floatmod?i.data.cargo.floatmod.toFixed():0),this.grpSelectSpeArk.active=!1,this.grpSelectIsland.active=!1,this.focusedInfoFrame.active=!0;else if(s){if(this.btnSponsorLink.getComponentInChildren(cc.Label).string=s.data.sponsorName?s.data.sponsorName:"无赞助商",s.data.occupant&&M.DataMgr.myUser&&s.data.occupant==M.DataMgr.myUser.address){this.lblAttackButton.string="追加\n驻军";var l=s.data.lastMineTime,c=(M.DataMgr.getBlockchainTimestamp()-l)/36e5,d=s.data.miningRate,h=s.data.money*(1-Math.exp(-d*c))/1e18;this.btnCollectIsland.node.active=!0,this.btnCollectIsland.getComponentInChildren(cc.Label).string="收取\n"+D.default.formatNAS(h)+M.DataMgr.coinUnit}else this.lblAttackButton.string="攻占",this.btnCollectIsland.node.active=!1;this.focusedInfoFrame.position=this.focusedObjectNode.position;var u=M.DataMgr.myUser.address==s.data.occupant,p=M.DataMgr.calcCurrentMoneyInIsland(s.data),f=s.data.miningRate*p/1e18;this.lblSelectInfo0.string=D.default.formatNAS(f)+M.DataMgr.coinUnit+"/h",this.lblSelectInfo1.string="储量"+D.default.formatNAS(p/1e18)+M.DataMgr.coinUnit+"\n"+(u?"<color=#00ff00>我军占领</color>":"<color=#ff0000>他人占领</color>"),this.grpSelectSpeArk.active=!1,this.grpSelectIsland.active=!0}else o&&(this.grpSelectIsland.active=!1,this.grpSelectSpeArk.active=!0);this.grpSelectPirate.active=i&&!0,this.grpSelectOther.active=n&&n.data.address!==M.DataMgr.myUser.address}else this.grpSelectSpeArk.active=!1,this.selectFrame.active=!1,this.grpSelectIsland.active=!1,this.grpSelectPirate.active=!1,this.grpSelectOther.active=!1;if(this.editSailDestinationMode){if(this.grpSail.active=!0,this.sailDestinationIndicator.active=null!=this.newDestination,this.focusedInfoFrame.active=null!=this.newDestination,this.newDestination){var g=M.DataMgr.getUserCurrentLocation(M.DataMgr.myUser),m=this.newDestination.sub(g),v=m.mag(),y=v/M.DataMgr.cityMoveSpeed,C=M.DataMgr.getSailEnergyCost(M.DataMgr.myUser,v);this.lblSelectInfo0.string=v.toFixed()+"km",this.lblSelectInfo1.string=y.toFixed()+"min\n"+C.toFixed()+"甲烷",this.sailRouteIndicator.width=v*this.zoomScale,this.sailRouteIndicator.rotation=180-180*Math.atan2(m.y,m.x)/Math.PI,this.focusedInfoFrame.position=this.newDestination.mul(this.zoomScale)}}else this.grpSail.active=!1,this.sailDestinationIndicator.active=!1},t.prototype.onGotoArkClick=function(){M.DataMgr.myUser?n.default.EnterUI(o.default):c.default.Toast("您尚未领取方舟")},t.prototype.onCenterBtnClick=function(){if(M.DataMgr.myUser){var t=M.DataMgr.myUser,e=M.DataMgr.getUserCurrentLocation(t);e.mulSelf(this.zoomScale),this.worldMap.position=e.neg()}},t.prototype.onPanPadTouchMove=function(t){var e=t.getDelta();this.worldMap.position=this.worldMap.position.add(new cc.Vec2(e.x,e.y))},t.prototype.onPanPadTouchEnd=function(t){if(this.editSailDestinationMode){var e=t.getLocation();if(new cc.Vec2(e.x,e.y).sub(t.getStartLocation()).mag()<20){var a=this.worldMap.convertTouchToNodeSpaceAR(t.touch);this.newDestination=a.mul(1/this.zoomScale),this.sailDestinationIndicator.position=this.newDestination.mul(this.zoomScale),this.focusedInfoFrame.position=this.newDestination.mul(this.zoomScale)}}if(this.focusedObjectNode){e=t.getLocation();new cc.Vec2(e.x,e.y).sub(t.getStartLocation()).mag()<20&&this.cancelSelectObject()}},t.prototype.onMouseWheel=function(t){var e=t.getScrollY(),a=this.zoomScale;this.zoomScale*=Math.pow(1.5,e/120),this.clampZoom();var r=this.zoomScale/a;this.worldMap.position=this.worldMap.position.mul(r),this.refreshZoom()},t.prototype.onZoomSliderChange=function(t){},t.prototype.clampZoom=function(){10<this.zoomScale&&(this.zoomScale=10),this.zoomScale<.01&&(this.zoomScale=.01)},t.prototype.selectObject=function(t){this.editSailDestinationMode?(this.newDestination=t.position.mul(1/this.zoomScale).add(new cc.Vec2(10,10)),this.sailDestinationIndicator.position=this.newDestination.mul(this.zoomScale),this.focusedInfoFrame.position=this.newDestination.mul(this.zoomScale)):this.focusedObjectNode=t},t.prototype.cancelSelectObject=function(){this.focusedObjectNode=null},t.prototype.onSelectObjectInfoClick=function(){var t=this.focusedObjectNode.getComponent(b.SpecialArk);if(t){var e=void 0;if(M.DataMgr.myUser)e=M.DataMgr.getUserCurrentLocation(M.DataMgr.myUser).sub(t.location).mag();else e=6e3;t.showInfo(e)}},t.prototype.onBtnAttackIslandClick=function(){if(M.DataMgr.myUser){var t=this.focusedObjectNode?this.focusedObjectNode.getComponent(_.default):null;t&&n.default.OpenPanel("CityInfoPanel",function(){return h.default.Instance.setAndRefreshIsland(t.data,"watch")})}else c.default.Toast("拥有方舟才能进攻")},t.prototype.onBtnCollectIslandClick=function(){var t=this.focusedObjectNode?this.focusedObjectNode.getComponent(_.default):null;t&&t.data.occupant==M.DataMgr.myUser.address&&i.default.Instance.callFunction("collectIslandMoney",[t.data.index],0,function(t){console.log("collectIslandMoney: ",t),"Error"!=t.toString().substr(0,5)?(d.default.PopupWith2Buttons("准备收取数字货币","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null),r.Instance.editSailDestinationMode=!1):c.default.Toast("交易失败:"+t)})},t.prototype.onIslandSponsorLinkClick=function(){var t=this.focusedObjectNode?this.focusedObjectNode.getComponent(_.default):null;t&&t.data.sponsorLink&&window.open(t.data.sponsorLink)},t.prototype.onIslandIWantSponsorClick=function(){var t=this.focusedObjectNode?this.focusedObjectNode.getComponent(_.default):null;t&&(console.log("onIslandIWantSponsorClick"),n.default.OpenPanel("SponsorIslandPanel",function(){l.default.Instance.setData(t)}))},t.prototype.onBtnSailClick=function(){M.DataMgr.myUser?(this.focusedObjectNode=null,this.editSailDestinationMode=!0,this.newDestination=null):c.default.Toast("拥有方舟才能航行")},t.prototype.onCancelSailClick=function(){this.editSailDestinationMode=!1,this.newDestination=null},t.prototype.onConfirmSailClick=function(){if(this.newDestination){var t=M.DataMgr.myUser,e=M.DataMgr.getUserCurrentLocation(t),a=M.DataMgr.getSailEnergyCost(t,this.newDestination.sub(e).mag());M.DataMgr.getUserCurrentCargoData(t).ch4<a&&c.default.Toast("甲烷燃料不足，强行发送交易可能失败"),console.log("ConfirmMove",this.newDestination),i.default.Instance.callFunction("move",[this.newDestination.x,this.newDestination.y],0,function(t){console.log("moveCallback: ",t),"Error"!=t.toString().substr(0,5)?(d.default.PopupWith2Buttons("引擎开始预热，如果一切顺利，将在30秒内出发","区块链交易已发送，等待出块\nTxHash:"+t.txhash,"查看交易",function(){window.open("https://explorer.neo.org/#/tx/"+t.txhash)},"确定",null),r.Instance.editSailDestinationMode=!1):c.default.Toast("交易失败:"+t)})}else c.default.Toast("请先点击地图空白位置，选择目的地，再点√")},t.prototype.onWatchCityClick=function(){if(this.focusedObjectNode){var t=this.focusedObjectNode.getComponent(k.default);t&&(n.default.OpenPanel("CityInfoPanel",function(){h.default.Instance.setAndRefreshUser(t.data,"watch")}),M.DataMgr.fetchUserDataFromBlockchain(t.data.address,function(t){h.default.Instance&&h.default.Instance.setAndRefreshUser(t,"watch")}))}},t.prototype.onTradeWithOtherClick=function(){console.log("TODO: Trade")},t.prototype.onAttackOtherClick=function(){if(this.focusedObjectNode){var t=this.focusedObjectNode.getComponent(k.default);t&&(n.default.OpenPanel("CityInfoPanel",function(){h.default.Instance.setAndRefreshUser(t.data,"attack")}),M.DataMgr.fetchUserDataFromBlockchain(t.data.address,function(t){h.default.Instance&&h.default.Instance.setAndRefreshUser(t,"attack")}))}},t.prototype.onWatchPirateClick=function(){if(this.focusedObjectNode){var t=this.focusedObjectNode.getComponent(I.default);t&&(n.default.OpenPanel("CityInfoPanel",function(){h.default.Instance.setAndRefreshPirate(M.DataMgr.getPirateData(t.index),"watch")}),M.DataMgr.fetchPirateDataFromBlockchain(t.index,function(t){h.default.Instance&&h.default.Instance.setAndRefreshPirate(t,"watch")}))}},t.prototype.onAttackPirateClick=function(){if(this.focusedObjectNode){var t=this.focusedObjectNode.getComponent(I.default);t&&(n.default.OpenPanel("CityInfoPanel",function(){h.default.Instance.setAndRefreshPirate(M.DataMgr.getPirateData(t.index),"attack")}),M.DataMgr.fetchPirateDataFromBlockchain(t.index,function(t){h.default.Instance&&h.default.Instance.setAndRefreshPirate(t,"attack")}))}},t.prototype.onFilterToggle=function(){this.refreshData()},__decorate([f(cc.Node)],t.prototype,"mineContainer",void 0),__decorate([f(cc.Node)],t.prototype,"islandContainer",void 0),__decorate([f(cc.Node)],t.prototype,"islandTemplate",void 0),__decorate([f(cc.Node)],t.prototype,"cityContainer",void 0),__decorate([f(cc.Node)],t.prototype,"cityTemplate",void 0),__decorate([f(cc.Node)],t.prototype,"pirateContainer",void 0),__decorate([f(cc.Node)],t.prototype,"pirateTemplate",void 0),__decorate([f(cc.Node)],t.prototype,"worldMap",void 0),__decorate([f(cc.Node)],t.prototype,"earth",void 0),__decorate([f(cc.Node)],t.prototype,"grpSelectOther",void 0),__decorate([f(cc.Node)],t.prototype,"grpSelectIsland",void 0),__decorate([f(cc.Node)],t.prototype,"grpSelectPirate",void 0),__decorate([f(cc.Node)],t.prototype,"grpSelectSpeArk",void 0),__decorate([f(cc.Node)],t.prototype,"selectFrame",void 0),__decorate([f(cc.Button)],t.prototype,"btnSponsorLink",void 0),__decorate([f(cc.Label)],t.prototype,"lblAttackButton",void 0),__decorate([f(cc.Button)],t.prototype,"btnCollectIsland",void 0),__decorate([f(cc.Node)],t.prototype,"panPad",void 0),__decorate([f(cc.Slider)],t.prototype,"sldZoom",void 0),__decorate([f(cc.Toggle)],t.prototype,"togOtherPlayer",void 0),__decorate([f(cc.Toggle)],t.prototype,"togPirate",void 0),__decorate([f(cc.Toggle)],t.prototype,"togDiamond",void 0),__decorate([f(cc.Toggle)],t.prototype,"togScenicSpot",void 0),__decorate([f(cc.Toggle)],t.prototype,"togNuke",void 0),__decorate([f(cc.Node)],t.prototype,"focusedInfoFrame",void 0),__decorate([f(cc.Label)],t.prototype,"lblSelectInfo0",void 0),__decorate([f(cc.RichText)],t.prototype,"lblSelectInfo1",void 0),__decorate([f(cc.Node)],t.prototype,"grpSail",void 0),__decorate([f(cc.Node)],t.prototype,"sailDestinationIndicator",void 0),__decorate([f(cc.Node)],t.prototype,"sailRouteIndicator",void 0),__decorate([f(cc.Node)],t.prototype,"btnCancelSail",void 0),__decorate([f(cc.Node)],t.prototype,"btnConfirmSail",void 0),t=r=__decorate([p],t);var r}(r.default);a.default=g,cc._RF.pop()},{"./BaseUI":"BaseUI","./BlockchainMgr":"BlockchainMgr","./CityUI":"CityUI","./CvsMain":"CvsMain","./DataMgr":"DataMgr","./HomeUI":"HomeUI","./UI/CityInfoPanel":"CityInfoPanel","./UI/DialogPanel":"DialogPanel","./UI/SponsorIslandPanel":"SponsorIslandPanel","./UI/ToastPanel":"ToastPanel","./Utils/CurrencyFormatter":"CurrencyFormatter","./World/ArkInWorld":"ArkInWorld","./World/Island":"Island","./World/Pirate":"Pirate","./World/SpecialArk":"SpecialArk"}]},{},["BaseUI","BlockchainMgr","CityUI","Building","CollectorBuilding","ExpandBlueprintCell","ExpandModeContainer","ProducerBuilding","WarehouseBuilding","CvsMain","DataMgr","HomeUI","Contract","FakeBC","MainCtrl","AsyncLoadSprite","AttackOtherPanel","AttackPiratePanel","BuildPanel","BuildingButton","BuildingInfoPanel","BuildingInfoProgressFrame","CityInfoPanel","DialogPanel","EditNicknamePanel","FlagMgr","Foreground","IntroUI","IslandInfoFrame","ProductionPanel","SponsorIslandPanel","ToastPanel","TransferPanel","TweenOpacity","TypewriterEffect","WatchOtherPanel","WatchPiratePanel","CurrencyFormatter","MathUtil","SliderFill","WorldUI","ArkInWorld","IronMine","Island","Pirate","SpecialArk"]);